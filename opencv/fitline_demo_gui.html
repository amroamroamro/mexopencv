<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Robust Line Fitting</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="fitline_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Robust Line Fitting</h1>
         <p>Example of using <tt>cv.fitLine</tt> function for fitting 2D line to points in presence of outliers.
         </p>
         <p>Switch between the different M-estimator functions and see, how well the robust functions fit the line even in case of ~50%
            of outliers.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/python/fitline.py">https://github.com/opencv/opencv/blob/3.2.0/samples/python/fitline.py</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = fitline_demo_gui()
    <span class="comment">% create the UI</span>
    h = buildGUI();
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> pts = sample_line(p1, p2, num, noise)
    <span class="comment">%SAMPLE_LINE  Sample points from line segment</span>
    <span class="comment">%</span>
    <span class="comment">%     pts = sample_line(p1, p2, num)</span>
    <span class="comment">%     pts = sample_line(p1, p2, num, noise)</span>
    <span class="comment">%</span>
    <span class="comment">% ## Input</span>
    <span class="comment">% * __p1__ first line point</span>
    <span class="comment">% * __p2__ second line point</span>
    <span class="comment">% * __num__ number of points to sample</span>
    <span class="comment">% * __noise__ gaussian noise added, default 0</span>
    <span class="comment">%</span>
    <span class="comment">% ## Output</span>
    <span class="comment">% * __pts__ points matrix num-by-2</span>
    <span class="comment">%</span>

    <span class="keyword">if</span> nargin &lt; 4, noise = 0; <span class="keyword">end</span>

    t = rand(num,1);
    pts = bsxfun(@plus, p1, bsxfun(@times, p2 - p1, t));
    pts = pts + randn(num,2) * noise;
<span class="keyword">end</span>

<span class="keyword">function</span> onChange(~,~,h)
    <span class="comment">%ONCHANGE  Event handler for UI controls</span>

    <span class="comment">% retrieve current values from UI controls</span>
    alg = get(h.pop, <span class="string">'Value'</span>);
    algs = get(h.pop, <span class="string">'String'</span>);
    r = round(get(h.slid(1), <span class="string">'Value'</span>));
    numPoints = round(get(h.slid(2), <span class="string">'Value'</span>));
    noise = round(get(h.slid(3), <span class="string">'Value'</span>));
    set(h.txt(1), <span class="string">'String'</span>,sprintf(<span class="string">'Outlier Percent: %d'</span>,r));
    set(h.txt(2), <span class="string">'String'</span>,sprintf(<span class="string">'Num Points: %d'</span>,numPoints));
    set(h.txt(3), <span class="string">'String'</span>,sprintf(<span class="string">'Noise: %d'</span>,noise));

    numOutliers = round(numPoints * r/100);
    dist_func = algs{alg};

    <span class="comment">% we need at least two points to fit a line</span>
    <span class="keyword">if</span> numPoints &lt; 2, <span class="keyword">return</span>; <span class="keyword">end</span>

    <span class="comment">% draw ground-truth line segment from which we sample points</span>
    p0 = [90, 80];
    p1 = h.sz([2 1]) - p0;

    <span class="comment">% sample points from line (with some noise)</span>
    line_points = sample_line(p0, p1, numPoints-numOutliers, noise);

    <span class="comment">% create outlier points</span>
    outliers = bsxfun(@times, rand(numOutliers,2), h.sz([2 1]));

    <span class="comment">% fit line on all points</span>
    lin = cv.fitLine([line_points; outliers], <span class="string">'DistType'</span>,dist_func);

    <span class="comment">% draw points and lines</span>
    img = zeros([h.sz 3], <span class="string">'uint8'</span>);
    img = cv.line(img, p0, p1, <span class="string">'Color'</span>,[0 255 0]);
    img = cv.circle(img, line_points, 2, <span class="keyword">...</span>
        <span class="string">'Color'</span>,[255 255 255], <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
    img = cv.circle(img, outliers, 2, <span class="keyword">...</span>
        <span class="string">'Color'</span>,[255 64 64], <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
    img = cv.line(img, <span class="keyword">...</span>
        lin(3:4) - lin(1:2)*h.sz(2), <span class="keyword">...</span>
        lin(3:4) + lin(1:2)*h.sz(2), <span class="string">'Color'</span>,[255 0 0]);

    <span class="comment">% show result</span>
    set(h.img, <span class="string">'CData'</span>,img);
    drawnow;
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI()
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% parameters</span>
    sz = [256 512];
    img = zeros([sz 3], <span class="string">'uint8'</span>);

    <span class="comment">% build the user interface (no resizing to keep it simple)</span>
    h = struct();
    h.sz = sz;
    h.fig = figure(<span class="string">'Name'</span>,<span class="string">'Fit Line Demo'</span>, <span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[200 200 sz(2) sz(1)+105-1]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: not implemented in Octave</span>
        movegui(h.fig, <span class="string">'center'</span>);
    <span class="keyword">end</span>
    h.ax = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[1 105 sz(2) sz(1)]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        h.img = imshow(img, <span class="string">'Parent'</span>,h.ax);
    <span class="keyword">else</span>
        <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
        axes(h.ax);
        h.img = imshow(img);
    <span class="keyword">end</span>
    h.txt(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10, <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 5 120 20], <span class="string">'String'</span>,<span class="string">'Outlier Percent:'</span>);
    h.txt(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10, <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 30 120 20], <span class="string">'String'</span>,<span class="string">'Num Points:'</span>);
    h.txt(3) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10, <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 55 120 20], <span class="string">'String'</span>,<span class="string">'Noise:'</span>);
    h.txt(4) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10, <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 80 120 20], <span class="string">'String'</span>,<span class="string">'Distance Function:'</span>);
    h.slid(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Value'</span>,30, <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,100, <span class="string">'SliderStep'</span>,[1 10]./(100-0), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 5 sz(2)-125-5 20]);
    h.slid(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Value'</span>,100, <span class="string">'Min'</span>,2, <span class="string">'Max'</span>,500, <span class="string">'SliderStep'</span>,[1 50]./(500-2), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 30 sz(2)-125-5 20]);
    h.slid(3) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Value'</span>,3, <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,50, <span class="string">'SliderStep'</span>,[1 5]./(50-0), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 55 sz(2)-125-5 20]);
    h.pop = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'popupmenu'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 80 80 20], <span class="keyword">...</span>
        <span class="string">'String'</span>,{<span class="string">'L2'</span>, <span class="string">'L1'</span>, <span class="string">'L12'</span>, <span class="string">'Fair'</span>, <span class="string">'Welsch'</span>, <span class="string">'Huber'</span>});
    h.btn = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'pushbutton'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[220 80 80 20], <span class="string">'String'</span>,<span class="string">'Regenerate'</span>);

    <span class="comment">% hook event handlers, and trigger default start</span>
    set([h.slid, h.pop, h.btn], <span class="string">'Callback'</span>,{@onChange,h}, <span class="keyword">...</span>
        <span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>);
    onChange([],[],h);
<span class="keyword">end</span></pre><img src="fitline_demo_gui_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Robust Line Fitting
% Example of using |cv.fitLine| function for fitting 2D line to points in
% presence of outliers.
%
% Switch between the different M-estimator functions and see, how well the
% robust functions fit the line even in case of ~50% of outliers.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/python/fitline.py>
%

function varargout = fitline_demo_gui()
    % create the UI
    h = buildGUI();
    if nargout > 0, varargout{1} = h; end
end

function pts = sample_line(p1, p2, num, noise)
    %SAMPLE_LINE  Sample points from line segment
    %
    %     pts = sample_line(p1, p2, num)
    %     pts = sample_line(p1, p2, num, noise)
    %
    % ## Input
    % * __p1__ first line point
    % * __p2__ second line point
    % * __num__ number of points to sample
    % * __noise__ gaussian noise added, default 0
    %
    % ## Output
    % * __pts__ points matrix num-by-2
    %

    if nargin < 4, noise = 0; end

    t = rand(num,1);
    pts = bsxfun(@plus, p1, bsxfun(@times, p2 - p1, t));
    pts = pts + randn(num,2) * noise;
end

function onChange(~,~,h)
    %ONCHANGE  Event handler for UI controls

    % retrieve current values from UI controls
    alg = get(h.pop, 'Value');
    algs = get(h.pop, 'String');
    r = round(get(h.slid(1), 'Value'));
    numPoints = round(get(h.slid(2), 'Value'));
    noise = round(get(h.slid(3), 'Value'));
    set(h.txt(1), 'String',sprintf('Outlier Percent: %d',r));
    set(h.txt(2), 'String',sprintf('Num Points: %d',numPoints));
    set(h.txt(3), 'String',sprintf('Noise: %d',noise));

    numOutliers = round(numPoints * r/100);
    dist_func = algs{alg};

    % we need at least two points to fit a line
    if numPoints < 2, return; end

    % draw ground-truth line segment from which we sample points
    p0 = [90, 80];
    p1 = h.sz([2 1]) - p0;

    % sample points from line (with some noise)
    line_points = sample_line(p0, p1, numPoints-numOutliers, noise);

    % create outlier points
    outliers = bsxfun(@times, rand(numOutliers,2), h.sz([2 1]));

    % fit line on all points
    lin = cv.fitLine([line_points; outliers], 'DistType',dist_func);

    % draw points and lines
    img = zeros([h.sz 3], 'uint8');
    img = cv.line(img, p0, p1, 'Color',[0 255 0]);
    img = cv.circle(img, line_points, 2, ...
        'Color',[255 255 255], 'Thickness','Filled');
    img = cv.circle(img, outliers, 2, ...
        'Color',[255 64 64], 'Thickness','Filled');
    img = cv.line(img, ...
        lin(3:4) - lin(1:2)*h.sz(2), ...
        lin(3:4) + lin(1:2)*h.sz(2), 'Color',[255 0 0]);

    % show result
    set(h.img, 'CData',img);
    drawnow;
end

function h = buildGUI()
    %BUILDGUI  Creates the UI

    % parameters
    sz = [256 512];
    img = zeros([sz 3], 'uint8');

    % build the user interface (no resizing to keep it simple)
    h = struct();
    h.sz = sz;
    h.fig = figure('Name','Fit Line Demo', ...
        'NumberTitle','off', 'Menubar','none', 'Resize','off', ...
        'Position',[200 200 sz(2) sz(1)+105-1]);
    if ~mexopencv.isOctave()
        %HACK: not implemented in Octave
        movegui(h.fig, 'center');
    end
    h.ax = axes('Parent',h.fig, 'Units','pixels', 'Position',[1 105 sz(2) sz(1)]);
    if ~mexopencv.isOctave()
        h.img = imshow(img, 'Parent',h.ax);
    else
        %HACK: https://savannah.gnu.org/bugs/index.php?45473
        axes(h.ax);
        h.img = imshow(img);
    end
    h.txt(1) = uicontrol('Parent',h.fig, 'Style','text', ...
        'FontSize',10, 'HorizontalAlignment','left', ...
        'Position',[5 5 120 20], 'String','Outlier Percent:');
    h.txt(2) = uicontrol('Parent',h.fig, 'Style','text', ...
        'FontSize',10, 'HorizontalAlignment','left', ...
        'Position',[5 30 120 20], 'String','Num Points:');
    h.txt(3) = uicontrol('Parent',h.fig, 'Style','text', ...
        'FontSize',10, 'HorizontalAlignment','left', ...
        'Position',[5 55 120 20], 'String','Noise:');
    h.txt(4) = uicontrol('Parent',h.fig, 'Style','text', ...
        'FontSize',10, 'HorizontalAlignment','left', ...
        'Position',[5 80 120 20], 'String','Distance Function:');
    h.slid(1) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Value',30, 'Min',0, 'Max',100, 'SliderStep',[1 10]./(100-0), ...
        'Position',[125 5 sz(2)-125-5 20]);
    h.slid(2) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Value',100, 'Min',2, 'Max',500, 'SliderStep',[1 50]./(500-2), ...
        'Position',[125 30 sz(2)-125-5 20]);
    h.slid(3) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Value',3, 'Min',0, 'Max',50, 'SliderStep',[1 5]./(50-0), ...
        'Position',[125 55 sz(2)-125-5 20]);
    h.pop = uicontrol('Parent',h.fig, 'Style','popupmenu', ...
        'Position',[125 80 80 20], ...
        'String',{'L2', 'L1', 'L12', 'Fair', 'Welsch', 'Huber'});
    h.btn = uicontrol('Parent',h.fig, 'Style','pushbutton', ...
        'Position',[220 80 80 20], 'String','Regenerate');

    % hook event handlers, and trigger default start
    set([h.slid, h.pop, h.btn], 'Callback',{@onChange,h}, ...
        'Interruptible','off', 'BusyAction','cancel');
    onChange([],[],h);
end

##### SOURCE END #####
-->
   </body>
</html>