<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Flood-filling in an image</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="ffilldemo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Flood-filling in an image</h1>
         <p>An example using the Flood-Fill technique</p>
         <p>In this sample you will learn how to use the following OpenCV functions:</p>
         <div>
            <ul>
               <li><a href="matlab:doc('cv.floodFill')">cv.floodFill</a></li>
            </ul>
         </div>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/ffilldemo.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/ffilldemo.cpp</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/python/floodfill.py">https://github.com/opencv/opencv/blob/3.2.0/samples/python/floodfill.py</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = ffilldemo_gui(im)
    <span class="comment">% load source image</span>
    <span class="keyword">if</span> nargin &lt; 1
        src = imread(fullfile(mexopencv.root(),<span class="string">'test'</span>,<span class="string">'fruits.jpg'</span>));
    <span class="keyword">elseif</span> ischar(im)
        src = imread(im);
    <span class="keyword">else</span>
        src = im;
    <span class="keyword">end</span>

    <span class="comment">% make sure we start with a color image</span>
    <span class="keyword">if</span> size(src,3) == 1
        src = cv.cvtColor(src, <span class="string">'GRAY2RGB'</span>);
    <span class="keyword">end</span>

    <span class="comment">% create the UI</span>
    h = buildGUI(src);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onClick(~,~,h)
    <span class="comment">%ONCLICK  Event handler for mouse click on images</span>

    <span class="comment">% ignore anything but left mouse clicks</span>
    <span class="keyword">if</span> ~strcmp(get(h.fig,<span class="string">'SelectionType'</span>), <span class="string">'normal'</span>)
        <span class="keyword">return</span>;
    <span class="keyword">end</span>

    <span class="comment">% current parameters</span>
    p = getappdata(h.fig, <span class="string">'params'</span>);

    <span class="comment">% which axis is active (color or gray)</span>
    <span class="keyword">if</span> p.isColor
        idx = 1;
    <span class="keyword">else</span>
        idx = 2;
    <span class="keyword">end</span>

    <span class="comment">% retrieve location of mouse click (in image coordinates)</span>
    <span class="comment">% and use it as flooding seed point</span>
    seed = get(h.ax(idx), <span class="string">'CurrentPoint'</span>);
    seed = seed(1,1:2);

    <span class="comment">% flood fill options</span>
    newVal = randi([0 255], [1 3]);
    <span class="keyword">if</span> ~p.isColor
        newVal = newVal * [0.299; 0.587; 0.114];
    <span class="keyword">end</span>
    <span class="keyword">if</span> p.ffillMode == <span class="string">'s'</span>
        lo = zeros(1,3);
        up = zeros(1,3);
    <span class="keyword">else</span>
        lo = repmat(p.loDiff,1,3);
        up = repmat(p.upDiff,1,3);
    <span class="keyword">end</span>
    flags = {<span class="string">'Connectivity'</span>,p.connectivity, <span class="keyword">...</span>
        <span class="string">'FixedRange'</span>,p.ffillMode==<span class="string">'f'</span>, <span class="string">'MaskFillValue'</span>,p.newMaskVal};

    <span class="comment">% apply flood fill on selected image (color or gray)</span>
    dst = get(h.img(idx), <span class="string">'CData'</span>);
    <span class="keyword">if</span> p.useMask
        <span class="comment">% update mask as well</span>
        mask = get(h.img(3), <span class="string">'CData'</span>);
        mask = cv.threshold(mask, 1, <span class="string">'MaxValue'</span>,128, <span class="string">'Type'</span>,<span class="string">'Binary'</span>);
        [dst,~,area,mask] = cv.floodFill(dst, round(seed-1), newVal, <span class="keyword">...</span>
            <span class="string">'Mask'</span>,mask, <span class="string">'LoDiff'</span>,lo, <span class="string">'UpDiff'</span>,up, flags{:});
        set(h.img(3), <span class="string">'CData'</span>,mask);
    <span class="keyword">else</span>
        [dst,~,area] = cv.floodFill(dst, round(seed-1), newVal, <span class="keyword">...</span>
            <span class="string">'LoDiff'</span>,lo, <span class="string">'UpDiff'</span>,up, flags{:});
    <span class="keyword">end</span>

    <span class="comment">% show result</span>
    fprintf(<span class="string">'%d pixels were repainted\n'</span>, area);
    set(h.img(idx), <span class="string">'CData'</span>,dst);
    set(h.lin, <span class="string">'XData'</span>,seed(1), <span class="string">'YData'</span>,seed(2));
    drawnow;
<span class="keyword">end</span>

<span class="keyword">function</span> onType(~,e,h)
    <span class="comment">%ONTYPE  Event handler for key press on figure</span>

    <span class="comment">% parameters</span>
    p = getappdata(h.fig, <span class="string">'params'</span>);

    <span class="comment">% handle keys</span>
    <span class="keyword">switch</span> e.Key
        <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
            disp(<span class="string">'Exiting ...'</span>);
            close(h.fig);
            <span class="keyword">return</span>;

        <span class="keyword">case</span> <span class="string">'h'</span>
            usage([],[]);

        <span class="keyword">case</span> <span class="string">'c'</span>
            <span class="comment">% reset images</span>
            resetImages(h);
            <span class="keyword">if</span> p.isColor
                <span class="comment">% use gray image</span>
                stackAxes(h, 2, 1);
                disp(<span class="string">'Grayscale mode is set'</span>);
            <span class="keyword">else</span>
                <span class="comment">% use color image</span>
                stackAxes(h, 1, 2);
                disp(<span class="string">'Color mode is set'</span>);
            <span class="keyword">end</span>
            p.isColor = ~p.isColor;

        <span class="keyword">case</span> <span class="string">'m'</span>
            p.useMask = ~p.useMask;

        <span class="keyword">case</span> <span class="string">'r'</span>
            resetImages(h);
            disp(<span class="string">'Original image is restored'</span>);

        <span class="keyword">case</span> {<span class="string">'s'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>}
            p.ffillMode = e.Key;
            <span class="keyword">if</span> e.Key == <span class="string">'s'</span>
                disp(<span class="string">'Simple floodfill mode is set'</span>);
            <span class="keyword">elseif</span> e.Key == <span class="string">'f'</span>
                disp(<span class="string">'Fixed Range floodfill mode is set'</span>);
            <span class="keyword">elseif</span> e.Key == <span class="string">'g'</span>
                disp(<span class="string">'Gradient (floating range) floodfill mode is set'</span>);
            <span class="keyword">end</span>

        <span class="keyword">case</span> {<span class="string">'4'</span>,<span class="string">'8'</span>}
            p.connectivity = str2double(e.Key);
            fprintf(<span class="string">'%s-connectivity mode is set\n'</span>, e.Key);
    <span class="keyword">end</span>

    <span class="comment">% update/refresh</span>
    setappdata(h.fig, <span class="string">'params'</span>, p);
    updateModes(h);
    <span class="keyword">if</span> ismember(e.Key, {<span class="string">'c'</span>,<span class="string">'m'</span>,<span class="string">'r'</span>}), drawnow; <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onChange(~,~,h)
    <span class="comment">%ONCHANGE  Event handler for UI controls</span>

    <span class="comment">% retrieve current values from UI controls</span>
    lo = round(get(h.slid(1), <span class="string">'Value'</span>));
    up = round(get(h.slid(2), <span class="string">'Value'</span>));
    set(h.txt(1), <span class="string">'String'</span>,sprintf(<span class="string">'LoDiff: %3d'</span>,lo));
    set(h.txt(2), <span class="string">'String'</span>,sprintf(<span class="string">'UpDiff: %3d'</span>,up));
    drawnow;

    <span class="comment">% update stored parameters</span>
    p = getappdata(h.fig, <span class="string">'params'</span>);
    p.loDiff = lo;
    p.upDiff = up;
    setappdata(h.fig, <span class="string">'params'</span>, p);
<span class="keyword">end</span>

<span class="keyword">function</span> updateModes(h)
    <span class="comment">%UPDATEMODES  Helper function to show current parameters in editbox</span>

    <span class="comment">% stored parameters</span>
    p = getappdata(h.fig, <span class="string">'params'</span>);
    set(h.txt(3), <span class="string">'String'</span>,sprintf(<span class="string">'c=%d, m=%d, fill=%c, cn=%d'</span>, <span class="keyword">...</span>
        p.isColor, p.useMask, p.ffillMode, p.connectivity));
<span class="keyword">end</span>

<span class="keyword">function</span> resetImages(h)
    <span class="comment">%RESETIMAGES  Helper function to reset images</span>

    <span class="comment">% color</span>
    set(h.img(1), <span class="string">'CData'</span>,h.img0);

    <span class="comment">% gray</span>
    gray = cv.cvtColor(h.img0, <span class="string">'RGB2GRAY'</span>);
    set(h.img(2), <span class="string">'CData'</span>,gray)

    <span class="comment">% mask</span>
    mask = get(h.img(3), <span class="string">'CData'</span>);
    mask(:) = 0;
    set(h.img(3), <span class="string">'CData'</span>,mask);

    <span class="comment">% seed point</span>
    set(h.lin, <span class="string">'XData'</span>,NaN, <span class="string">'YData'</span>,NaN);
<span class="keyword">end</span>

<span class="keyword">function</span> stackAxes(h, idx1, idx2)
    <span class="comment">%STACKAXES  Helper function to switch which axis to show</span>

    set(h.img(idx1), <span class="string">'Visible'</span>,<span class="string">'on'</span>);
    set(h.img(idx2), <span class="string">'Visible'</span>,<span class="string">'off'</span>);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: UISTACK not implemented in Octave</span>
        uistack(h.ax(idx1), <span class="string">'top'</span>);
    <span class="keyword">end</span>

    <span class="comment">% re-parent seed point line inside top axis</span>
    set(h.lin, <span class="string">'Parent'</span>,h.ax(idx1));
<span class="keyword">end</span>

<span class="keyword">function</span> usage(~,~)
    <span class="comment">%USAGE  Display help dialog</span>

    helpdlg({
        <span class="string">'Click on the left image to set flood-fill seed point.'</span>
        <span class="string">''</span>
        <span class="string">'Hot keys:'</span>
        <span class="string">'ESC - quit the program'</span>
        <span class="string">'h - this help dialog'</span>
        <span class="string">'c - switch color/grayscale mode'</span>
        <span class="string">'m - switch mask mode'</span>
        <span class="string">'r - restore the original image'</span>
        <span class="string">'s - use null-range floodfill'</span>
        <span class="string">'f - use gradient floodfill with fixed(absolute) range'</span>
        <span class="string">'g - use gradient floodfill with floating(relative) range'</span>
        <span class="string">'4 - use 4-connectivity mode'</span>
        <span class="string">'8 - use 8-connectivity mode'</span>
    });
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI(img)
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% parameters</span>
    sz = size(img);
    mask = zeros(sz(1:2)+2, <span class="string">'uint8'</span>);
    sz(2) = max(sz(2), 300);  <span class="comment">% minimum figure width</span>
    gray = cv.cvtColor(img, <span class="string">'RGB2GRAY'</span>);
    lo = 20;
    up = 20;

    <span class="comment">% build the user interface (no resizing to keep it simple)</span>
    h = struct();
    h.img0 = img;
    h.fig = figure(<span class="string">'Name'</span>,<span class="string">'Flood-Fill Demo'</span>, <span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[200 200 sz(2)*2 sz(1)+59]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: not implemented in Octave</span>
        movegui(h.fig, <span class="string">'center'</span>);
    <span class="keyword">end</span>
    h.ax(1) = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[1 60 sz(2) sz(1)]);
    h.ax(2) = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[1 60 sz(2) sz(1)]);
    h.ax(3) = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[sz(2)+1 60 sz(2) sz(1)]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        h.img(1) = imshow(img, <span class="string">'Parent'</span>,h.ax(1));
        h.img(2) = imshow(gray, <span class="string">'Parent'</span>,h.ax(2));
        h.img(3) = imshow(mask, <span class="string">'Parent'</span>,h.ax(3));
    <span class="keyword">else</span>
        <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
        axes(h.ax(1));
        h.img(1) = imshow(img);
        axes(h.ax(2));
        h.img(2) = imshow(gray);
        axes(h.ax(3));
        h.img(3) = imshow(mask);
    <span class="keyword">end</span>
    h.txt(3) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="string">'FontSize'</span>,8, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 5 120 20], <span class="string">'String'</span>,<span class="string">''</span>, <span class="string">'Enable'</span>,<span class="string">'off'</span>);
    h.but = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'pushbutton'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[40 30 60 20], <span class="string">'String'</span>,<span class="string">'Help'</span>, <span class="string">'Callback'</span>,@usage);
    h.txt(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 5 80 20], <span class="string">'String'</span>,sprintf(<span class="string">'LoDiff: %3d'</span>,lo));
    h.txt(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[125 30 80 20], <span class="string">'String'</span>,sprintf(<span class="string">'UpDiff: %3d'</span>,up));
    h.slid(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="string">'Value'</span>,lo, <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,255, <span class="string">'SliderStep'</span>,[1 10]./(255-0), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[205 5 sz(2)-210 20]);
    h.slid(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="string">'Value'</span>,up, <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,255, <span class="string">'SliderStep'</span>,[1 10]./(255-0), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[205 30 sz(2)-210 20]);
    h.lin = line(NaN, NaN, <span class="string">'Parent'</span>,h.ax(1), <span class="keyword">...</span>
        <span class="string">'LineStyle'</span>,<span class="string">'none'</span>, <span class="string">'Marker'</span>,<span class="string">'.'</span>, <span class="string">'MarkerSize'</span>,10, <span class="string">'Color'</span>,<span class="string">'r'</span>);

    <span class="comment">%HACK: WindowKeyPressFcn not implemented in Octave</span>
    <span class="comment">% http://savannah.gnu.org/bugs/?44910</span>
    <span class="keyword">if</span> mexopencv.isOctave()
        <span class="comment">% create GUI buttons to interact instead of keyboard pressing</span>
        keys = <span class="string">'qrcmsfg48'</span>;
        labels = {<span class="string">'Quit'</span>, <span class="string">'Reset'</span>, <span class="string">'Color/Grayscale'</span>, <span class="string">'Mask'</span>, <span class="keyword">...</span>
            <span class="string">'null'</span>, <span class="string">'fixed'</span>, <span class="string">'floating'</span>, <span class="string">'4-conn'</span>, <span class="string">'8-conn'</span>};
        <span class="keyword">for</span> k=1:numel(keys)
            uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'pushbutton'</span>, <span class="keyword">...</span>
                <span class="string">'Position'</span>,[sz(2)+20*k 30 20 20], <span class="string">'String'</span>,keys(k), <span class="keyword">...</span>
                <span class="string">'TooltipString'</span>,labels{k}, <span class="keyword">...</span>
                <span class="string">'Callback'</span>,@(o,~) onType(o,struct(<span class="string">'Key'</span>,keys(k)),h));
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">% initialize interactive parameters</span>
    p = struct();
    p.ffillMode = <span class="string">'f'</span>;
    p.loDiff = lo;
    p.upDiff = up;
    p.connectivity = 4;
    p.isColor = true;
    p.useMask = false;
    p.newMaskVal = 255;
    setappdata(h.fig, <span class="string">'params'</span>, p);

    <span class="comment">% hook event handlers, and trigger default start</span>
    opts = {<span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>};
    set(h.slid, <span class="string">'Callback'</span>,{@onChange,h}, opts{:});
    set(h.fig, <span class="string">'WindowKeyPressFcn'</span>,{@onType,h}, opts{:});
    set(h.img(1:2), <span class="string">'ButtonDownFcn'</span>,{@onClick,h}, opts{:});
    stackAxes(h, 1, 2);
    onChange([],[],h);
    updateModes(h);
<span class="keyword">end</span></pre><img src="ffilldemo_gui_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Flood-filling in an image
% An example using the Flood-Fill technique
%
% In this sample you will learn how to use the following OpenCV functions:
%
% * <matlab:doc('cv.floodFill') cv.floodFill>
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/ffilldemo.cpp>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/python/floodfill.py>
%

function varargout = ffilldemo_gui(im)
    % load source image
    if nargin < 1
        src = imread(fullfile(mexopencv.root(),'test','fruits.jpg'));
    elseif ischar(im)
        src = imread(im);
    else
        src = im;
    end

    % make sure we start with a color image
    if size(src,3) == 1
        src = cv.cvtColor(src, 'GRAY2RGB');
    end

    % create the UI
    h = buildGUI(src);
    if nargout > 0, varargout{1} = h; end
end

function onClick(~,~,h)
    %ONCLICK  Event handler for mouse click on images

    % ignore anything but left mouse clicks
    if ~strcmp(get(h.fig,'SelectionType'), 'normal')
        return;
    end

    % current parameters
    p = getappdata(h.fig, 'params');

    % which axis is active (color or gray)
    if p.isColor
        idx = 1;
    else
        idx = 2;
    end

    % retrieve location of mouse click (in image coordinates)
    % and use it as flooding seed point
    seed = get(h.ax(idx), 'CurrentPoint');
    seed = seed(1,1:2);

    % flood fill options
    newVal = randi([0 255], [1 3]);
    if ~p.isColor
        newVal = newVal * [0.299; 0.587; 0.114];
    end
    if p.ffillMode == 's'
        lo = zeros(1,3);
        up = zeros(1,3);
    else
        lo = repmat(p.loDiff,1,3);
        up = repmat(p.upDiff,1,3);
    end
    flags = {'Connectivity',p.connectivity, ...
        'FixedRange',p.ffillMode=='f', 'MaskFillValue',p.newMaskVal};

    % apply flood fill on selected image (color or gray)
    dst = get(h.img(idx), 'CData');
    if p.useMask
        % update mask as well
        mask = get(h.img(3), 'CData');
        mask = cv.threshold(mask, 1, 'MaxValue',128, 'Type','Binary');
        [dst,~,area,mask] = cv.floodFill(dst, round(seed-1), newVal, ...
            'Mask',mask, 'LoDiff',lo, 'UpDiff',up, flags{:});
        set(h.img(3), 'CData',mask);
    else
        [dst,~,area] = cv.floodFill(dst, round(seed-1), newVal, ...
            'LoDiff',lo, 'UpDiff',up, flags{:});
    end

    % show result
    fprintf('%d pixels were repainted\n', area);
    set(h.img(idx), 'CData',dst);
    set(h.lin, 'XData',seed(1), 'YData',seed(2));
    drawnow;
end

function onType(~,e,h)
    %ONTYPE  Event handler for key press on figure

    % parameters
    p = getappdata(h.fig, 'params');

    % handle keys
    switch e.Key
        case {'q', 'escape'}
            disp('Exiting ...');
            close(h.fig);
            return;

        case 'h'
            usage([],[]);

        case 'c'
            % reset images
            resetImages(h);
            if p.isColor
                % use gray image
                stackAxes(h, 2, 1);
                disp('Grayscale mode is set');
            else
                % use color image
                stackAxes(h, 1, 2);
                disp('Color mode is set');
            end
            p.isColor = ~p.isColor;

        case 'm'
            p.useMask = ~p.useMask;

        case 'r'
            resetImages(h);
            disp('Original image is restored');

        case {'s', 'f', 'g'}
            p.ffillMode = e.Key;
            if e.Key == 's'
                disp('Simple floodfill mode is set');
            elseif e.Key == 'f'
                disp('Fixed Range floodfill mode is set');
            elseif e.Key == 'g'
                disp('Gradient (floating range) floodfill mode is set');
            end

        case {'4','8'}
            p.connectivity = str2double(e.Key);
            fprintf('%s-connectivity mode is set\n', e.Key);
    end

    % update/refresh
    setappdata(h.fig, 'params', p);
    updateModes(h);
    if ismember(e.Key, {'c','m','r'}), drawnow; end
end

function onChange(~,~,h)
    %ONCHANGE  Event handler for UI controls

    % retrieve current values from UI controls
    lo = round(get(h.slid(1), 'Value'));
    up = round(get(h.slid(2), 'Value'));
    set(h.txt(1), 'String',sprintf('LoDiff: %3d',lo));
    set(h.txt(2), 'String',sprintf('UpDiff: %3d',up));
    drawnow;

    % update stored parameters
    p = getappdata(h.fig, 'params');
    p.loDiff = lo;
    p.upDiff = up;
    setappdata(h.fig, 'params', p);
end

function updateModes(h)
    %UPDATEMODES  Helper function to show current parameters in editbox

    % stored parameters
    p = getappdata(h.fig, 'params');
    set(h.txt(3), 'String',sprintf('c=%d, m=%d, fill=%c, cn=%d', ...
        p.isColor, p.useMask, p.ffillMode, p.connectivity));
end

function resetImages(h)
    %RESETIMAGES  Helper function to reset images

    % color
    set(h.img(1), 'CData',h.img0);

    % gray
    gray = cv.cvtColor(h.img0, 'RGB2GRAY');
    set(h.img(2), 'CData',gray)

    % mask
    mask = get(h.img(3), 'CData');
    mask(:) = 0;
    set(h.img(3), 'CData',mask);

    % seed point
    set(h.lin, 'XData',NaN, 'YData',NaN);
end

function stackAxes(h, idx1, idx2)
    %STACKAXES  Helper function to switch which axis to show

    set(h.img(idx1), 'Visible','on');
    set(h.img(idx2), 'Visible','off');
    if ~mexopencv.isOctave()
        %HACK: UISTACK not implemented in Octave
        uistack(h.ax(idx1), 'top');
    end

    % re-parent seed point line inside top axis
    set(h.lin, 'Parent',h.ax(idx1));
end

function usage(~,~)
    %USAGE  Display help dialog

    helpdlg({
        'Click on the left image to set flood-fill seed point.'
        ''
        'Hot keys:'
        'ESC - quit the program'
        'h - this help dialog'
        'c - switch color/grayscale mode'
        'm - switch mask mode'
        'r - restore the original image'
        's - use null-range floodfill'
        'f - use gradient floodfill with fixed(absolute) range'
        'g - use gradient floodfill with floating(relative) range'
        '4 - use 4-connectivity mode'
        '8 - use 8-connectivity mode'
    });
end

function h = buildGUI(img)
    %BUILDGUI  Creates the UI

    % parameters
    sz = size(img);
    mask = zeros(sz(1:2)+2, 'uint8');
    sz(2) = max(sz(2), 300);  % minimum figure width
    gray = cv.cvtColor(img, 'RGB2GRAY');
    lo = 20;
    up = 20;

    % build the user interface (no resizing to keep it simple)
    h = struct();
    h.img0 = img;
    h.fig = figure('Name','Flood-Fill Demo', ...
        'NumberTitle','off', 'Menubar','none', 'Resize','off', ...
        'Position',[200 200 sz(2)*2 sz(1)+59]);
    if ~mexopencv.isOctave()
        %HACK: not implemented in Octave
        movegui(h.fig, 'center');
    end
    h.ax(1) = axes('Parent',h.fig, 'Units','pixels', 'Position',[1 60 sz(2) sz(1)]);
    h.ax(2) = axes('Parent',h.fig, 'Units','pixels', 'Position',[1 60 sz(2) sz(1)]);
    h.ax(3) = axes('Parent',h.fig, 'Units','pixels', 'Position',[sz(2)+1 60 sz(2) sz(1)]);
    if ~mexopencv.isOctave()
        h.img(1) = imshow(img, 'Parent',h.ax(1));
        h.img(2) = imshow(gray, 'Parent',h.ax(2));
        h.img(3) = imshow(mask, 'Parent',h.ax(3));
    else
        %HACK: https://savannah.gnu.org/bugs/index.php?45473
        axes(h.ax(1));
        h.img(1) = imshow(img);
        axes(h.ax(2));
        h.img(2) = imshow(gray);
        axes(h.ax(3));
        h.img(3) = imshow(mask);
    end
    h.txt(3) = uicontrol('Parent',h.fig, 'Style','text', 'FontSize',8, ...
        'Position',[5 5 120 20], 'String','', 'Enable','off');
    h.but = uicontrol('Parent',h.fig, 'Style','pushbutton', ...
        'Position',[40 30 60 20], 'String','Help', 'Callback',@usage);
    h.txt(1) = uicontrol('Parent',h.fig, 'Style','text', 'FontSize',11, ...
        'Position',[125 5 80 20], 'String',sprintf('LoDiff: %3d',lo));
    h.txt(2) = uicontrol('Parent',h.fig, 'Style','text', 'FontSize',11, ...
        'Position',[125 30 80 20], 'String',sprintf('UpDiff: %3d',up));
    h.slid(1) = uicontrol('Parent',h.fig, 'Style','slider', 'Value',lo, ...
        'Min',0, 'Max',255, 'SliderStep',[1 10]./(255-0), ...
        'Position',[205 5 sz(2)-210 20]);
    h.slid(2) = uicontrol('Parent',h.fig, 'Style','slider', 'Value',up, ...
        'Min',0, 'Max',255, 'SliderStep',[1 10]./(255-0), ...
        'Position',[205 30 sz(2)-210 20]);
    h.lin = line(NaN, NaN, 'Parent',h.ax(1), ...
        'LineStyle','none', 'Marker','.', 'MarkerSize',10, 'Color','r');

    %HACK: WindowKeyPressFcn not implemented in Octave
    % http://savannah.gnu.org/bugs/?44910
    if mexopencv.isOctave()
        % create GUI buttons to interact instead of keyboard pressing
        keys = 'qrcmsfg48';
        labels = {'Quit', 'Reset', 'Color/Grayscale', 'Mask', ...
            'null', 'fixed', 'floating', '4-conn', '8-conn'};
        for k=1:numel(keys)
            uicontrol('Parent',h.fig, 'Style','pushbutton', ...
                'Position',[sz(2)+20*k 30 20 20], 'String',keys(k), ...
                'TooltipString',labels{k}, ...
                'Callback',@(o,~) onType(o,struct('Key',keys(k)),h));
        end
    end

    % initialize interactive parameters
    p = struct();
    p.ffillMode = 'f';
    p.loDiff = lo;
    p.upDiff = up;
    p.connectivity = 4;
    p.isColor = true;
    p.useMask = false;
    p.newMaskVal = 255;
    setappdata(h.fig, 'params', p);

    % hook event handlers, and trigger default start
    opts = {'Interruptible','off', 'BusyAction','cancel'};
    set(h.slid, 'Callback',{@onChange,h}, opts{:});
    set(h.fig, 'WindowKeyPressFcn',{@onType,h}, opts{:});
    set(h.img(1:2), 'ButtonDownFcn',{@onClick,h}, opts{:});
    stackAxes(h, 1, 2);
    onChange([],[],h);
    updateModes(h);
end

##### SOURCE END #####
-->
   </body>
</html>