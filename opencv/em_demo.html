<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>EM Clustering</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="em_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">EM Clustering</h1>
         <!--introduction-->
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/em.cpp">https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/em.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#2">Options</a></li>
               <li><a href="#3">Data</a></li>
               <li><a href="#5">EM Cluster</a></li>
               <li><a href="#6">Plot</a></li>
            </ul>
         </div>
         <h2 id="2">Options</h2><pre class="codeinput">K = 5;             <span class="comment">% number of clusters</span>
N = 25;            <span class="comment">% number of samples per cluster</span>
W = 400; H = 400;  <span class="comment">% width/height of output image containing 2D points</span>

<span class="comment">% some colors for drawing</span>
clrFG = lines(K);
clrBG = brighten(clrFG, 0.75);</pre><h2 id="3">Data</h2>
         <p>generate the training samples</p><pre class="codeinput">samples = cell(K,1);
<span class="keyword">for</span> i=1:K
    K1 = fix(sqrt(K));
    mu = ([mod(i-1,K1), fix((i-1)/K1)] + 1) * H / (K1+1);
    sig = [30 30];
    samples{i} = bsxfun(@plus, bsxfun(@times, randn([N 2]), sig), mu);
<span class="keyword">end</span>
samples = single(cat(1, samples{:}));  <span class="comment">% 2D points (nsamples-by-2)</span></pre><p>true labels (nsamples-by-1)</p><pre class="codeinput"><span class="keyword">if</span> mexopencv.isOctave()
    <span class="comment">%HACK: http://savannah.gnu.org/bugs/?45497</span>
    groups = int32(repelems(1:K, [1:K; repmat(N,1,K)]))';
<span class="keyword">else</span>
    groups = int32(repelem((1:K)', N));
<span class="keyword">end</span></pre><h2 id="5">EM Cluster</h2>
         <p>cluster the data</p><pre class="codeinput">em = cv.EM();
em.ClustersNumber = K;
em.CovarianceMatrixType = <span class="string">'Spherical'</span>;
em.TermCriteria.maxCount = 300;
em.TermCriteria.epsilon = 0.1;

[~,labels] = em.trainEM(samples);
labels = int32(labels) + 1;  <span class="comment">% convert 0-based to 1-based indices</span></pre><h2 id="6">Plot</h2>
         <p>canvas to draw 2D points</p><pre class="codeinput">img = zeros([H W 3], <span class="string">'uint8'</span>);</pre><p>classify every image pixel</p><pre class="codeinput">[X,Y] = meshgrid(1:W, 1:H);
XY = single([X(:) Y(:)]);

[~,response] = em.predict2(XY);
response = int32(response) + 1;  <span class="comment">% convert 0-based to 1-based indices</span></pre><p>draw the clustered pixels</p><pre class="codeinput"><span class="keyword">for</span> i=1:K
    idx = (response == i);
    <span class="keyword">if</span> ~any(idx), <span class="keyword">continue</span>; <span class="keyword">end</span>
    img = cv.circle(img, XY(idx,:), 1, <span class="keyword">...</span>
        <span class="string">'Color'</span>,uint8(clrBG(i,:)*255), <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
<span class="keyword">end</span></pre><p>draw the clustered samples</p><pre class="codeinput"><span class="keyword">for</span> i=1:size(samples,1)
    img = cv.circle(img, round(samples(i,:)), 3, <span class="keyword">...</span>
        <span class="string">'Color'</span>,uint8(clrFG(labels(i),:)*255), <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
<span class="keyword">end</span></pre><p>display the result</p><pre class="codeinput">imshow(img)
title(<span class="string">'EM-clustering result'</span>)</pre><img src="em_demo_01.png"><p>display the original sample labels vs. clusters</p><pre class="codeinput">figure
image([1 W], [1 H], reshape(double(response), [H W]))
colormap(clrBG)
hold <span class="string">on</span>
<span class="keyword">if</span> mexopencv.isOctave()
    <span class="comment">%HACK: GSCATTER not implemented in Octave</span>
    scatter(samples(:,1), samples(:,2), [], double(groups))
<span class="keyword">else</span>
    gscatter(samples(:,1), samples(:,2), groups, clrFG)
<span class="keyword">end</span>
hold <span class="string">off</span>
axis <span class="string">equal</span> <span class="string">ij</span>, axis([1 W 1 H]), grid <span class="string">on</span>
title(<span class="string">'Original Samples'</span>), xlabel(<span class="string">'X'</span>), ylabel(<span class="string">'Y'</span>)</pre><img src="em_demo_02.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% EM Clustering
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/em.cpp>
%

%% Options
K = 5;             % number of clusters
N = 25;            % number of samples per cluster
W = 400; H = 400;  % width/height of output image containing 2D points

% some colors for drawing
clrFG = lines(K);
clrBG = brighten(clrFG, 0.75);

%% Data
% generate the training samples
samples = cell(K,1);
for i=1:K
    K1 = fix(sqrt(K));
    mu = ([mod(i-1,K1), fix((i-1)/K1)] + 1) * H / (K1+1);
    sig = [30 30];
    samples{i} = bsxfun(@plus, bsxfun(@times, randn([N 2]), sig), mu);
end
samples = single(cat(1, samples{:}));  % 2D points (nsamples-by-2)

%%
% true labels (nsamples-by-1)
if mexopencv.isOctave()
    %HACK: http://savannah.gnu.org/bugs/?45497
    groups = int32(repelems(1:K, [1:K; repmat(N,1,K)]))';
else
    groups = int32(repelem((1:K)', N));
end

%% EM Cluster
% cluster the data
em = cv.EM();
em.ClustersNumber = K;
em.CovarianceMatrixType = 'Spherical';
em.TermCriteria.maxCount = 300;
em.TermCriteria.epsilon = 0.1;

[~,labels] = em.trainEM(samples);
labels = int32(labels) + 1;  % convert 0-based to 1-based indices

%% Plot
% canvas to draw 2D points
img = zeros([H W 3], 'uint8');

%%
% classify every image pixel
[X,Y] = meshgrid(1:W, 1:H);
XY = single([X(:) Y(:)]);

[~,response] = em.predict2(XY);
response = int32(response) + 1;  % convert 0-based to 1-based indices

%%
% draw the clustered pixels
for i=1:K
    idx = (response == i);
    if ~any(idx), continue; end
    img = cv.circle(img, XY(idx,:), 1, ...
        'Color',uint8(clrBG(i,:)*255), 'Thickness','Filled');
end

%%
% draw the clustered samples
for i=1:size(samples,1)
    img = cv.circle(img, round(samples(i,:)), 3, ...
        'Color',uint8(clrFG(labels(i),:)*255), 'Thickness','Filled');
end

%%
% display the result
imshow(img)
title('EM-clustering result')

%%
% display the original sample labels vs. clusters
figure
image([1 W], [1 H], reshape(double(response), [H W]))
colormap(clrBG)
hold on
if mexopencv.isOctave()
    %HACK: GSCATTER not implemented in Octave
    scatter(samples(:,1), samples(:,2), [], double(groups))
else
    gscatter(samples(:,1), samples(:,2), groups, clrFG)
end
hold off
axis equal ij, axis([1 W 1 H]), grid on
title('Original Samples'), xlabel('X'), ylabel('Y')

##### SOURCE END #####
-->
   </body>
</html>