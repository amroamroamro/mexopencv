<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Deep Neural Network with Caffe models</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2018-02-20">
      <meta name="DC.source" content="caffe_googlenet_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Deep Neural Network with Caffe models</h1>
         <!--introduction-->
         <p>Load Caffe framework models.</p>
         <p>In this tutorial you will learn how to use DNN module for image classification by using GoogLeNet trained network from <a href="http://caffe.berkeleyvision.org/model_zoo.html">Caffe model zoo</a>.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/caffe_googlenet.cpp">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/caffe_googlenet.cpp</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/googlenet_python.py">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/googlenet_python.py</a></li>
               <li><a href="https://docs.opencv.org/3.4.0/d5/de7/tutorial_dnn_googlenet.html">https://docs.opencv.org/3.4.0/d5/de7/tutorial_dnn_googlenet.html</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#2">BVLC GoogLeNet</a></li>
               <li><a href="#3">Load class labels</a></li>
               <li><a href="#4">Create and initialize network from Caffe model</a></li>
               <li><a href="#5">Prepare blob from input image</a></li>
               <li><a href="#7">Set the network input</a></li>
               <li><a href="#8">Make forward pass and compute output</a></li>
               <li><a href="#9">Gather output of "prob" layer</a></li>
               <li><a href="#10">Show predictions</a></li>
            </ul>
         </div>
         <h2 id="2">BVLC GoogLeNet</h2>
         <p>First, we download GoogLeNet model files:</p>
         <div>
            <ul>
               <li><tt>deploy.prototxt</tt> and <tt>bvlc_googlenet.caffemodel</tt></li>
               <li>Also we need file with names of   <a href="http://image-net.org/challenges/LSVRC/2012/browse-synsets">ILSVRC2012</a>   classes: <tt>synset_words.txt</tt>.
               </li>
            </ul>
         </div><pre class="codeinput">dirDNN = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'dnn'</span>, <span class="string">'GoogLeNet'</span>);
modelLabels = fullfile(dirDNN, <span class="string">'synset_words.txt'</span>);
modelTxt = fullfile(dirDNN, <span class="string">'deploy.prototxt'</span>);
modelBin = fullfile(dirDNN, <span class="string">'bvlc_googlenet.caffemodel'</span>);  <span class="comment">% 51 MB file</span>
files = {modelLabels, modelTxt, modelBin};
urls = {
    <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/synset_words.txt'</span>;
    <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/bvlc_googlenet.prototxt'</span>;
    <span class="string">'http://dl.caffe.berkeleyvision.org/bvlc_googlenet.caffemodel'</span>;
};
<span class="keyword">if</span> ~isdir(dirDNN), mkdir(dirDNN); <span class="keyword">end</span>
<span class="keyword">for</span> i=1:numel(files)
    <span class="keyword">if</span> exist(files{i}, <span class="string">'file'</span>) ~= 2
        disp(<span class="string">'Downloading...'</span>)
        urlwrite(urls{i}, files{i});
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><h2 id="3">Load class labels</h2><pre class="codeinput"><span class="keyword">if</span> ~mexopencv.isOctave()
    fid = fopen(modelLabels, <span class="string">'rt'</span>);
    C = textscan(fid, <span class="string">'%*s %[^\n]'</span>);
    fclose(fid);
    labels = C{1};
<span class="keyword">else</span>
    <span class="comment">%HACK: textscan is buggy and unreliable in Octave!</span>
    labels = textread(modelLabels, <span class="string">'%s'</span>, <span class="string">'Delimiter'</span>,<span class="string">'\n'</span>);
    labels = regexprep(labels, <span class="string">'^\w+\s*'</span>, <span class="string">''</span>, <span class="string">'once'</span>);
<span class="keyword">end</span>
fprintf(<span class="string">'%d classes\n'</span>, numel(labels));</pre><pre class="codeoutput">1000 classes
</pre><h2 id="4">Create and initialize network from Caffe model</h2><pre class="codeinput">net = cv.Net(<span class="string">'Caffe'</span>, modelTxt, modelBin);
assert(~net.empty(), <span class="string">'Cant load network'</span>);
<span class="keyword">if</span> false
    net.setPreferableTarget(<span class="string">'OpenCL'</span>);
<span class="keyword">end</span></pre><h2 id="5">Prepare blob from input image</h2>
         <p>Read input image (BGR channel order)</p><pre class="codeinput">img = cv.imread(fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'space_shuttle.jpg'</span>), <span class="keyword">...</span>
    <span class="string">'Color'</span>,true, <span class="string">'FlipChannels'</span>,false);</pre><p>we resize and convert the image to 4-dimensional blob (so-called batch) with 1x3x224x224 shape, because GoogLeNet accepts
            only 224x224 BGR-images. we also subtract the mean pixel value of the training dataset ILSVRC_2012 (B: 104.0069879317889,
            G: 116.66876761696767, R: 122.6789143406786)
         </p><pre class="codeinput"><span class="keyword">if</span> true
    blob = cv.Net.blobFromImages(img, <span class="keyword">...</span>
        <span class="string">'Size'</span>,[224 224], <span class="string">'Mean'</span>,[104 117 123], <span class="string">'SwapRB'</span>,false);
<span class="keyword">else</span>
    <span class="comment">% NOTE: blobFromImages does crop/resize to preserve aspect ratio of image</span>
    blob = cv.resize(img, [224 224]);                <span class="comment">% Size</span>
    blob = single(blob);                             <span class="comment">% CV_32F</span>
    blob = bsxfun(@minus, blob, cat(3,104,117,123)); <span class="comment">% Mean (BGR)</span>
    blob = permute(blob, [4 3 1 2]);                 <span class="comment">% HWCN -&gt; NCHW</span>
<span class="keyword">end</span></pre><h2 id="7">Set the network input</h2>
         <p>In <tt>deploy.prototxt</tt> the network input blob named as "data". Other blobs labeled as "name_of_layer.name_of_layer_output".
         </p><pre class="codeinput">net.setInput(blob, <span class="string">'data'</span>);</pre><h2 id="8">Make forward pass and compute output</h2>
         <p>During the forward pass output of each network layer is computed, but in this example we need output from "prob" layer only.</p><pre class="codeinput">tic
p = net.forward(<span class="string">'prob'</span>);  <span class="comment">% 1x1000 vector</span>
toc</pre><pre class="codeoutput">Elapsed time is 0.360979 seconds.
</pre><h2 id="9">Gather output of "prob" layer</h2>
         <p>We determine the best class by taking the output of "prob" layer, which contain probabilities for each of 1000 ILSVRC2012
            image classes, and finding the index of element with maximal value in this one. This index correspond to the class of the
            image.
         </p><pre class="codeinput">[~,ord] = sort(p, <span class="string">'descend'</span>);  <span class="comment">% ordered by maximum probability</span></pre><h2 id="10">Show predictions</h2><pre class="codeinput"><span class="keyword">if</span> ~mexopencv.isOctave()
    <span class="comment">%HACK: TABLE not implemented in Octave</span>
    t = table(labels(:), p(:), <span class="string">'VariableNames'</span>,{<span class="string">'Label'</span>,<span class="string">'Probability'</span>});
    t = sortrows(t, <span class="string">'Probability'</span>, <span class="string">'descend'</span>);
    disp(<span class="string">'Top 5 predictions'</span>);
    disp(t(1:5,:));
<span class="keyword">end</span>

subplot(3,1,1:2), imshow(flip(img,3))
title(<span class="string">'space_shuttle.jpg'</span>, <span class="string">'Interpreter'</span>,<span class="string">'none'</span>)
subplot(3,1,3), barh(1:5, p(ord(1:5))*100)
set(gca, <span class="string">'YTickLabel'</span>,labels(ord(1:5)), <span class="string">'YDir'</span>,<span class="string">'reverse'</span>)
axis([0 100 0 6]), grid <span class="string">on</span>
title(<span class="string">'Top-5 Predictions'</span>), xlabel(<span class="string">'Probability (%)'</span>)</pre><pre class="codeoutput">Top 5 predictions
                  Label                  Probability
    _________________________________    ___________
    'space shuttle'                         0.99993 
    'airliner'                           2.3053e-05 
    'submarine, pigboat, sub, U-boat'    2.1932e-05 
    'bullet train, bullet'               1.0001e-05 
    'missile'                             4.962e-06 
</pre><img src="caffe_googlenet_demo_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Deep Neural Network with Caffe models
% Load Caffe framework models.
%
% In this tutorial you will learn how to use DNN module for image
% classification by using GoogLeNet trained network from
% <http://caffe.berkeleyvision.org/model_zoo.html Caffe model zoo>.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/caffe_googlenet.cpp>
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/googlenet_python.py>
% * <https://docs.opencv.org/3.4.0/d5/de7/tutorial_dnn_googlenet.html>
%

%% BVLC GoogLeNet
% First, we download GoogLeNet model files:
%
% * |deploy.prototxt| and |bvlc_googlenet.caffemodel|
% * Also we need file with names of
%   <http://image-net.org/challenges/LSVRC/2012/browse-synsets ILSVRC2012>
%   classes: |synset_words.txt|.
%
dirDNN = fullfile(mexopencv.root(), 'test', 'dnn', 'GoogLeNet');
modelLabels = fullfile(dirDNN, 'synset_words.txt');
modelTxt = fullfile(dirDNN, 'deploy.prototxt');
modelBin = fullfile(dirDNN, 'bvlc_googlenet.caffemodel');  % 51 MB file
files = {modelLabels, modelTxt, modelBin};
urls = {
    'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/synset_words.txt';
    'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/bvlc_googlenet.prototxt';
    'http://dl.caffe.berkeleyvision.org/bvlc_googlenet.caffemodel';
};
if ~isdir(dirDNN), mkdir(dirDNN); end
for i=1:numel(files)
    if exist(files{i}, 'file') ~= 2
        disp('Downloading...')
        urlwrite(urls{i}, files{i});
    end
end

%% Load class labels
if ~mexopencv.isOctave()
    fid = fopen(modelLabels, 'rt');
    C = textscan(fid, '%*s %[^\n]');
    fclose(fid);
    labels = C{1};
else
    %HACK: textscan is buggy and unreliable in Octave!
    labels = textread(modelLabels, '%s', 'Delimiter','\n');
    labels = regexprep(labels, '^\w+\s*', '', 'once');
end
fprintf('%d classes\n', numel(labels));

%% Create and initialize network from Caffe model
net = cv.Net('Caffe', modelTxt, modelBin);
assert(~net.empty(), 'Cant load network');
if false
    net.setPreferableTarget('OpenCL');
end

%% Prepare blob from input image
% Read input image (BGR channel order)
img = cv.imread(fullfile(mexopencv.root(), 'test', 'space_shuttle.jpg'), ...
    'Color',true, 'FlipChannels',false);

%%
% we resize and convert the image to 4-dimensional blob (so-called batch)
% with 1x3x224x224 shape, because GoogLeNet accepts only 224x224 BGR-images.
% we also subtract the mean pixel value of the training dataset ILSVRC_2012
% (B: 104.0069879317889, G: 116.66876761696767, R: 122.6789143406786)
if true
    blob = cv.Net.blobFromImages(img, ...
        'Size',[224 224], 'Mean',[104 117 123], 'SwapRB',false);
else
    % NOTE: blobFromImages does crop/resize to preserve aspect ratio of image
    blob = cv.resize(img, [224 224]);                % Size
    blob = single(blob);                             % CV_32F
    blob = bsxfun(@minus, blob, cat(3,104,117,123)); % Mean (BGR)
    blob = permute(blob, [4 3 1 2]);                 % HWCN -> NCHW
end

%% Set the network input
% In |deploy.prototxt| the network input blob named as "data".
% Other blobs labeled as "name_of_layer.name_of_layer_output".
net.setInput(blob, 'data');

%% Make forward pass and compute output
% During the forward pass output of each network layer is computed,
% but in this example we need output from "prob" layer only.
tic
p = net.forward('prob');  % 1x1000 vector
toc

%% Gather output of "prob" layer
% We determine the best class by taking the output of "prob" layer, which
% contain probabilities for each of 1000 ILSVRC2012 image classes, and finding
% the index of element with maximal value in this one. This index correspond
% to the class of the image.
[~,ord] = sort(p, 'descend');  % ordered by maximum probability

%% Show predictions
if ~mexopencv.isOctave()
    %HACK: TABLE not implemented in Octave
    t = table(labels(:), p(:), 'VariableNames',{'Label','Probability'});
    t = sortrows(t, 'Probability', 'descend');
    disp('Top 5 predictions');
    disp(t(1:5,:));
end

subplot(3,1,1:2), imshow(flip(img,3))
title('space_shuttle.jpg', 'Interpreter','none')
subplot(3,1,3), barh(1:5, p(ord(1:5))*100)
set(gca, 'YTickLabel',labels(ord(1:5)), 'YDir','reverse')
axis([0 100 0 6]), grid on
title('Top-5 Predictions'), xlabel('Probability (%)')

##### SOURCE END #####
-->
   </body>
</html>