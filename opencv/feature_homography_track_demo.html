<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Feature homography based planar tracking</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="feature_homography_track_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Feature homography based planar tracking</h1>
         <p>Example of using features2d framework for interactive video homography matching. ORB features and FLANN matcher are used.
            The actual tracking is implemented by <tt>PlaneTracker</tt> class.
         </p>
         <p>Inspired by <a href="http://www.youtube.com/watch?v=-ZNYoL8rzPY">http://www.youtube.com/watch?v=-ZNYoL8rzPY</a></p>
         <p>Video: <a href="http://www.youtube.com/watch?v=FirtmYcC0Vc">http://www.youtube.com/watch?v=FirtmYcC0Vc</a></p>
         <p>Select a textured planar object to track by drawing a box with a mouse.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.3.1/samples/python/feature_homography.py">https://github.com/opencv/opencv/blob/3.3.1/samples/python/feature_homography.py</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> feature_homography_track_demo(vid)
    <span class="comment">% video file, and a default target to track [x,y,w,h]</span>
    win = [];
    <span class="keyword">if</span> nargin &lt; 1
        vid = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'blais.mp4'</span>);
        assert(exist(vid, <span class="string">'file'</span>) == 2, <span class="string">'Missing video file'</span>);
        <span class="keyword">if</span> true
            win = [135 165 285 175];  <span class="comment">% face</span>
        <span class="keyword">else</span>
            win = [136 0 366 433];    <span class="comment">% book</span>
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> isempty(vid)
        vid = 0;
    <span class="keyword">end</span>

    <span class="comment">% open video feed, and get first frame</span>
    cap = cv.VideoCapture(vid);
    pause(1);
    assert(cap.isOpened(), <span class="string">'Failed to open video'</span>);
    frame = cap.read();
    assert(~isempty(frame), <span class="string">'Failed to read frames'</span>);

    <span class="comment">% prepare plot</span>
    paused = false;
    tframe = zeros(size(frame), class(frame));  <span class="comment">% target frame + drawings</span>
    hImg = imshow([frame, tframe]);

    <span class="comment">% create and initialize tracker</span>
    tracker = PlaneTracker();
    <span class="keyword">if</span> ~isempty(win)
        onRect(win);
    <span class="keyword">end</span>

    <span class="comment">% create ROI region selector</span>
    <span class="keyword">if</span> ~mexopencv.isOctave()
        onHelp();
        roi = RectSelector(hImg);
        roi.clip = true;
        roi.callback = @onRect;
    <span class="keyword">else</span>
        <span class="comment">%HACK: RectSelector not Octave compatible</span>
        <span class="comment">%HACK: function handle to nested function not supported in Octave</span>
        roi = struct(<span class="string">'isDragging'</span>,@()false);
    <span class="keyword">end</span>

    <span class="comment">% listen to keyboard input</span>
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: function handle to nested function not supported in Octave</span>
        set(ancestor(hImg,<span class="string">'figure'</span>), <span class="string">'WindowKeyPressFcn'</span>,@onType);
    <span class="keyword">end</span>

    <span class="comment">% main loop</span>
    <span class="keyword">while</span> ishghandle(hImg)
        playing = ~paused &amp;&amp; ~roi.isDragging();
        <span class="keyword">if</span> playing
            <span class="comment">% read new frame</span>
            frame = cap.read();
            <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>
        <span class="keyword">end</span>
        out = [frame, tframe];

        <span class="comment">% track and draw keypoints and boundary of target in new frame</span>
        <span class="keyword">if</span> playing
            tracked = tracker.track(frame);
            <span class="keyword">if</span> ~isempty(tracked)
                tr = tracked(1);
                out = cv.circle(out, tr.pt1, 2, <span class="string">'Color'</span>,[255 0 0]);
                out = cv.polylines(out, tr.quad, <span class="string">'Closed'</span>,true, <span class="keyword">...</span>
                    <span class="string">'Color'</span>,[0 255 0], <span class="string">'Thickness'</span>,2);
                <span class="comment">% draw matches</span>
                out = cv.line(out, <span class="keyword">...</span>
                    bsxfun(@plus, tr.pt0, [size(frame,2) 0]), tr.pt1, <span class="keyword">...</span>
                    <span class="string">'Color'</span>,[0 0 255]);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">% display result</span>
        set(hImg, <span class="string">'CData'</span>,out);
        <span class="keyword">if</span> playing
            drawnow;
        <span class="keyword">else</span>
            pause(0.1);  <span class="comment">% slow down a bit if paused</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    cap.release();
    <span class="keyword">if</span> isobject(roi), delete(roi); <span class="keyword">end</span>

    <span class="comment">% --- Callback functions ---</span>

    <span class="keyword">function</span> onRect(rect)
        <span class="comment">%ONRECT  Callback for ROI selector</span>
        <span class="comment">%</span>
        <span class="comment">%     onRect(rect)</span>
        <span class="comment">%</span>
        <span class="comment">% ## Input</span>
        <span class="comment">% * __rect__ selected rectangle [x,y,w,h], or empty</span>
        <span class="comment">%</span>

        <span class="keyword">if</span> isempty(rect), <span class="keyword">return</span>; <span class="keyword">end</span>

        <span class="comment">% selection must be made in left image (current frame)</span>
        rect = cv.Rect.intersect(rect, [0 0 size(frame,2) size(frame,1)]);
        <span class="keyword">if</span> cv.Rect.area(rect) &lt; 1, <span class="keyword">return</span>; <span class="keyword">end</span>

        <span class="comment">% track new target</span>
        disp(<span class="string">'New target...'</span>)
        tracker.clear();
        tracker.addTarget(frame, rect);

        <span class="comment">% draw keypoints and boundary in target frame</span>
        <span class="keyword">if</span> ~isempty(tracker.targets)
            t = tracker.targets(1);
            tframe = cv.drawKeypoints(t.image, t.kpts, <span class="string">'Color'</span>,[255 0 0]);
            tframe = cv.rectangle(tframe, t.rect(1:2), t.rect(3:4), <span class="keyword">...</span>
                <span class="string">'Color'</span>,[0 255 0], <span class="string">'Thickness'</span>,2);
        <span class="keyword">else</span>
            tframe(:) = 0;
        <span class="keyword">end</span>

        <span class="comment">% un-pause</span>
        paused = false;
    <span class="keyword">end</span>

    <span class="keyword">function</span> onType(hfig, e)
        <span class="comment">%ONTYPE  Event handler for key press on figure</span>

        <span class="keyword">switch</span> e.Key
            <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
                close(hfig);

            <span class="keyword">case</span> <span class="string">'h'</span>
                onHelp();

            <span class="keyword">case</span> {<span class="string">'space'</span>, <span class="string">'p'</span>}
                disp(<span class="string">'Toggle pause...'</span>);
                paused = ~paused;

            <span class="keyword">case</span> {<span class="string">'c'</span>, <span class="string">'r'</span>}
                disp(<span class="string">'Clearing tracker...'</span>);
                tracker.clear();
                tframe(:) = 0;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onHelp()
        <span class="comment">%ONHELP  Display usage help dialog</span>

        h = helpdlg({
            <span class="string">'Select object(s) to track using the mouse.'</span>
            <span class="string">'Hot keys:'</span>
            <span class="string">'  q - quit'</span>
            <span class="string">'  h - help'</span>
            <span class="string">'  p - pause'</span>
            <span class="string">'  c - clear targets'</span>
        });

        <span class="comment">% wait for user to accept dialog</span>
        set(h, <span class="string">'WindowStyle'</span>,<span class="string">'modal'</span>);
        waitfor(h);
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><pre class="codeoutput">New target...
</pre><img src="feature_homography_track_demo_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Feature homography based planar tracking
%
% Example of using features2d framework for interactive video homography
% matching. ORB features and FLANN matcher are used. The actual tracking is
% implemented by |PlaneTracker| class.
%
% Inspired by <http://www.youtube.com/watch?v=-ZNYoL8rzPY>
%
% Video: <http://www.youtube.com/watch?v=FirtmYcC0Vc>
%
% Select a textured planar object to track by drawing a box with a mouse.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.3.1/samples/python/feature_homography.py>
%

function feature_homography_track_demo(vid)
    % video file, and a default target to track [x,y,w,h]
    win = [];
    if nargin < 1
        vid = fullfile(mexopencv.root(), 'test', 'blais.mp4');
        assert(exist(vid, 'file') == 2, 'Missing video file');
        if true
            win = [135 165 285 175];  % face
        else
            win = [136 0 366 433];    % book
        end
    elseif isempty(vid)
        vid = 0;
    end

    % open video feed, and get first frame
    cap = cv.VideoCapture(vid);
    pause(1);
    assert(cap.isOpened(), 'Failed to open video');
    frame = cap.read();
    assert(~isempty(frame), 'Failed to read frames');

    % prepare plot
    paused = false;
    tframe = zeros(size(frame), class(frame));  % target frame + drawings
    hImg = imshow([frame, tframe]);

    % create and initialize tracker
    tracker = PlaneTracker();
    if ~isempty(win)
        onRect(win);
    end

    % create ROI region selector
    if ~mexopencv.isOctave()
        onHelp();
        roi = RectSelector(hImg);
        roi.clip = true;
        roi.callback = @onRect;
    else
        %HACK: RectSelector not Octave compatible
        %HACK: function handle to nested function not supported in Octave
        roi = struct('isDragging',@()false);
    end

    % listen to keyboard input
    if ~mexopencv.isOctave()
        %HACK: function handle to nested function not supported in Octave
        set(ancestor(hImg,'figure'), 'WindowKeyPressFcn',@onType);
    end

    % main loop
    while ishghandle(hImg)
        playing = ~paused && ~roi.isDragging();
        if playing
            % read new frame
            frame = cap.read();
            if isempty(frame), break; end
        end
        out = [frame, tframe];

        % track and draw keypoints and boundary of target in new frame
        if playing
            tracked = tracker.track(frame);
            if ~isempty(tracked)
                tr = tracked(1);
                out = cv.circle(out, tr.pt1, 2, 'Color',[255 0 0]);
                out = cv.polylines(out, tr.quad, 'Closed',true, ...
                    'Color',[0 255 0], 'Thickness',2);
                % draw matches
                out = cv.line(out, ...
                    bsxfun(@plus, tr.pt0, [size(frame,2) 0]), tr.pt1, ...
                    'Color',[0 0 255]);
            end
        end

        % display result
        set(hImg, 'CData',out);
        if playing
            drawnow;
        else
            pause(0.1);  % slow down a bit if paused
        end
    end
    cap.release();
    if isobject(roi), delete(roi); end

    % REPLACE_WITH_DASH_DASH- Callback functions REPLACE_WITH_DASH_DASH-

    function onRect(rect)
        %ONRECT  Callback for ROI selector
        %
        %     onRect(rect)
        %
        % ## Input
        % * __rect__ selected rectangle [x,y,w,h], or empty
        %

        if isempty(rect), return; end

        % selection must be made in left image (current frame)
        rect = cv.Rect.intersect(rect, [0 0 size(frame,2) size(frame,1)]);
        if cv.Rect.area(rect) < 1, return; end

        % track new target
        disp('New target...')
        tracker.clear();
        tracker.addTarget(frame, rect);

        % draw keypoints and boundary in target frame
        if ~isempty(tracker.targets)
            t = tracker.targets(1);
            tframe = cv.drawKeypoints(t.image, t.kpts, 'Color',[255 0 0]);
            tframe = cv.rectangle(tframe, t.rect(1:2), t.rect(3:4), ...
                'Color',[0 255 0], 'Thickness',2);
        else
            tframe(:) = 0;
        end

        % un-pause
        paused = false;
    end

    function onType(hfig, e)
        %ONTYPE  Event handler for key press on figure

        switch e.Key
            case {'q', 'escape'}
                close(hfig);

            case 'h'
                onHelp();

            case {'space', 'p'}
                disp('Toggle pause...');
                paused = ~paused;

            case {'c', 'r'}
                disp('Clearing tracker...');
                tracker.clear();
                tframe(:) = 0;
        end
    end

    function onHelp()
        %ONHELP  Display usage help dialog

        h = helpdlg({
            'Select object(s) to track using the mouse.'
            'Hot keys:'
            '  q - quit'
            '  h - help'
            '  p - pause'
            '  c - clear targets'
        });

        % wait for user to accept dialog
        set(h, 'WindowStyle','modal');
        waitfor(h);
    end
end

##### SOURCE END #####
-->
   </body>
</html>