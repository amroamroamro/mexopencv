<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>warp_perspective_demo_gui</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="warp_perspective_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Image Warping</a></li>
               <li><a href="#3">Callback Functions</a></li>
               <li><a href="#5">Helper Functions</a></li>
            </ul>
         </div>
         <h2 id="1">Image Warping</h2>
         <p>A demo program shows how perspective transformation applied on an image. Based on a sample code from <a href="http://study.marearts.com/2015/03/image-warping-using-opencv.html">MareArts blog</a>.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.3.1/samples/cpp/warpPerspective_demo.cpp">https://github.com/opencv/opencv/blob/3.3.1/samples/cpp/warpPerspective_demo.cpp</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = warp_perspective_demo_gui(im)</pre><pre class="codeinput">    <span class="comment">% load source image and set initial ROI corners (4 points clockwise)</span>
    roi = [];
    <span class="keyword">if</span> nargin &lt; 1
        <span class="keyword">if</span> true
            im = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'books_right.jpg'</span>);
            roi = [360 109; 532 138; 460 417; 317 338];
        <span class="keyword">else</span>
            im = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'box_in_scene.png'</span>);
            roi = [243 188; 328 151; 388 294; 319 351];
        <span class="keyword">end</span>
        img = cv.imread(im, <span class="string">'Color'</span>,true);
    <span class="keyword">elseif</span> ischar(im)
        img = cv.imread(im, <span class="string">'Color'</span>,true);
    <span class="keyword">else</span>
        img = im;
    <span class="keyword">end</span>
    <span class="keyword">if</span> isempty(roi)
        roi = bsxfun(@rdivide, [size(img,2) size(img,1)], <span class="keyword">...</span>
            [1.7 4.2; 1.15 3.32; 1.33 1.1; 1.93 1.36]);
    <span class="keyword">end</span>

    <span class="comment">% create the UI and hook event handlers</span>
    h = buildGUI(img, roi);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>
    opts = {<span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>};
    set(h.fig, <span class="string">'CloseRequestFcn'</span>,@(~,~) delete(h.fig), <span class="keyword">...</span>
        <span class="string">'WindowKeyPressFcn'</span>,@onType, opts{:});
    set(h.fig(1), <span class="string">'WindowButtonDownFcn'</span>,@onMouseDown, opts{:});</pre><img src="warp_perspective_demo_gui_01.png"><img src="warp_perspective_demo_gui_02.png"><h2 id="3">Callback Functions</h2><pre class="codeinput">    <span class="keyword">function</span> redraw()
        <span class="comment">%REDRAW  Apply transformation using current ROI and display results</span>

        <span class="comment">% reapply transformation</span>
        out1 = drawROI(img, roi);
        [out2, sz] = warpROI(img, roi);

        <span class="comment">% show results and ajust second plot to fit image</span>
        set(h.img(1), <span class="string">'CData'</span>,out1);
        set(h.img(2), <span class="string">'CData'</span>,out2, <span class="string">'XData'</span>,[1 sz(1)], <span class="string">'YData'</span>,[1 sz(2)]);
        set(h.ax(2), <span class="string">'XLim'</span>,[0 sz(1)]+0.5, <span class="string">'YLim'</span>,[0 sz(2)]+0.5);
        pos = get(h.fig(2), <span class="string">'Position'</span>);
        set(h.fig(2), <span class="string">'Position'</span>,[pos(1:2) sz]);
        drawnow;
    <span class="keyword">end</span>

    <span class="keyword">function</span> onType(~,e)
        <span class="comment">%ONTYPE  Event handler for key press on figure</span>

        <span class="keyword">switch</span> e.Key
            <span class="keyword">case</span> <span class="string">'h'</span>
                helpdlg({
                    <span class="string">'Use your mouse to select a point and move it'</span>
                    <span class="string">'to see transformation changes.'</span>
                    <span class="string">''</span>
                    <span class="string">'Hot keys:'</span>
                    <span class="string">'h - this help dialog'</span>
                    <span class="string">'q - quit the program'</span>
                    <span class="string">'r - change order of points to rotate transformation'</span>
                    <span class="string">'i - change order of points to invert transformation '</span>
                });
            <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
                close(h.fig);
            <span class="keyword">case</span> <span class="string">'r'</span>
                roi = circshift(roi, -1);
                redraw();
            <span class="keyword">case</span> <span class="string">'i'</span>
                roi = roi([2 1 4 3],:);
                redraw();
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onMouseDown(~,~)
        <span class="comment">%ONMOUSEDOWN  Event handler for mouse down on figure</span>

        <span class="comment">% hit-test for closest ROI corner</span>
        pt = getCurrentPoint(h.ax(1));
        d = sum(abs(bsxfun(@minus, roi, pt)), 2);
        [mn, pt_idx] = min(d);
        <span class="keyword">if</span> mn &lt; 20
            <span class="comment">% attach event handlers, and change mouse pointer</span>
            set(h.fig(1), <span class="string">'Pointer'</span>,<span class="string">'cross'</span>, <span class="keyword">...</span>
                <span class="string">'WindowButtonMotionFcn'</span>,{@onMouseMove, pt_idx}, <span class="keyword">...</span>
                <span class="string">'WindowButtonUpFcn'</span>,@onMouseUp);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onMouseMove(~,~,idx)
        <span class="comment">%ONMOUSEMOVE  Event handler for mouse move on figure</span>

        <span class="comment">% move specified ROI corner</span>
        pt = getCurrentPoint(h.ax(1));
        roi(idx,:) = pt;
        redraw();
    <span class="keyword">end</span>

    <span class="keyword">function</span> onMouseUp(~,~)
        <span class="comment">%ONMOUSEUP  Event handler for mouse up on figure</span>

        <span class="comment">% detach event handlers, and restore mouse pointer</span>
        set(h.fig(1), <span class="string">'Pointer'</span>,<span class="string">'arrow'</span>, <span class="keyword">...</span>
            <span class="string">'WindowButtonMotionFcn'</span>,<span class="string">''</span>, <span class="keyword">...</span>
            <span class="string">'WindowButtonUpFcn'</span>,<span class="string">''</span>);
    <span class="keyword">end</span></pre><pre class="codeinput"><span class="keyword">end</span></pre><h2 id="5">Helper Functions</h2><pre class="codeinput"><span class="keyword">function</span> out = drawROI(img, pts)
    <span class="comment">%DRAWROI  Show ROI corners with labels</span>

    labels = {<span class="string">'TL'</span>, <span class="string">'TR'</span>, <span class="string">'BR'</span>, <span class="string">'BL'</span>};
    out = cv.polylines(img, pts, <span class="string">'Closed'</span>,true, <span class="string">'Color'</span>,[0 0 255], <span class="string">'Thickness'</span>,2);
    out = cv.circle(out, pts, 5, <span class="string">'Color'</span>,[0 255 0], <span class="string">'Thickness'</span>,3);
    out = cv.putText(out, labels, pts, <span class="keyword">...</span>
        <span class="string">'FontScale'</span>,0.8, <span class="string">'Color'</span>,[255 0 0], <span class="string">'Thickness'</span>,2);
<span class="keyword">end</span>

<span class="keyword">function</span> [out, dsz] = warpROI(img, srcPts)
    <span class="comment">%WARPROI  Compute warped image from ROI</span>

    <span class="comment">% map ROI corners to corresponding destination rectangle</span>
    len = diff(srcPts([1:end 1],:), 1, 1);  <span class="comment">% [TR-TL; BR-TR; BL-BR; TL-BL]</span>
    len = cellfun(@norm, num2cell(len, 2)); <span class="comment">% lengths of sides</span>
    w = max(len(1), len(3));
    h = max(len(2), len(4));
    dstPts = [0 0; w 0; w h; 0 h];

    <span class="comment">% compute homography between points and apply persepective transformation</span>
    dsz = round([w h]);
    H = cv.findHomography(srcPts, dstPts);
    out = cv.warpPerspective(img, H, <span class="string">'DSize'</span>,dsz);
<span class="keyword">end</span>

<span class="keyword">function</span> p = getCurrentPoint(ax)
    <span class="comment">%GETCURRENTPOINT  Retrieve current mouse location</span>

    p = get(ax, <span class="string">'CurrentPoint'</span>);
    p = p(1,1:2) - 1;
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI(img, roi)
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% apply initial perspective transformation</span>
    out1 = drawROI(img, roi);
    out2 = warpROI(img, roi);
    sz1 = size(out1);
    sz2 = size(out2);

    <span class="comment">% properties</span>
    fprops = {<span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'on'</span>};
    aprops = {<span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,[0 0 1 1]};
    h = struct();

    <span class="comment">% show input image + ROI corners</span>
    h.fig(1) = figure(<span class="string">'Name'</span>,<span class="string">'Image'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[100 200 sz1(2) sz1(1)], fprops{:});
    h.ax(1) = axes(<span class="string">'Parent'</span>,h.fig(1), aprops{:});
    <span class="keyword">if</span> mexopencv.isOctave()
        h.img(1) = imshow(out1);
    <span class="keyword">else</span>
        h.img(1) = imshow(out1, <span class="string">'Parent'</span>,h.ax(1));
    <span class="keyword">end</span>

    <span class="comment">% show warped image</span>
    h.fig(2) = figure(<span class="string">'Name'</span>,<span class="string">'Warped'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[200+sz1(2) 200 sz2(2) sz2(1)], fprops{:});
    h.ax(2) = axes(<span class="string">'Parent'</span>,h.fig(2), aprops{:});
    <span class="keyword">if</span> mexopencv.isOctave()
        h.img(2) = imshow(out2);
    <span class="keyword">else</span>
        h.img(2) = imshow(out2, <span class="string">'Parent'</span>,h.ax(2));
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Image Warping
% A demo program shows how perspective transformation applied on an image.
% Based on a sample code from
% <http://study.marearts.com/2015/03/image-warping-using-opencv.html MareArts blog>.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.3.1/samples/cpp/warpPerspective_demo.cpp>
%

function varargout = warp_perspective_demo_gui(im)
    % load source image and set initial ROI corners (4 points clockwise)
    roi = [];
    if nargin < 1
        if true
            im = fullfile(mexopencv.root(), 'test', 'books_right.jpg');
            roi = [360 109; 532 138; 460 417; 317 338];
        else
            im = fullfile(mexopencv.root(), 'test', 'box_in_scene.png');
            roi = [243 188; 328 151; 388 294; 319 351];
        end
        img = cv.imread(im, 'Color',true);
    elseif ischar(im)
        img = cv.imread(im, 'Color',true);
    else
        img = im;
    end
    if isempty(roi)
        roi = bsxfun(@rdivide, [size(img,2) size(img,1)], ...
            [1.7 4.2; 1.15 3.32; 1.33 1.1; 1.93 1.36]);
    end

    % create the UI and hook event handlers
    h = buildGUI(img, roi);
    if nargout > 0, varargout{1} = h; end
    opts = {'Interruptible','off', 'BusyAction','cancel'};
    set(h.fig, 'CloseRequestFcn',@(~,~) delete(h.fig), ...
        'WindowKeyPressFcn',@onType, opts{:});
    set(h.fig(1), 'WindowButtonDownFcn',@onMouseDown, opts{:});


    %% Callback Functions

    function redraw()
        %REDRAW  Apply transformation using current ROI and display results

        % reapply transformation
        out1 = drawROI(img, roi);
        [out2, sz] = warpROI(img, roi);

        % show results and ajust second plot to fit image
        set(h.img(1), 'CData',out1);
        set(h.img(2), 'CData',out2, 'XData',[1 sz(1)], 'YData',[1 sz(2)]);
        set(h.ax(2), 'XLim',[0 sz(1)]+0.5, 'YLim',[0 sz(2)]+0.5);
        pos = get(h.fig(2), 'Position');
        set(h.fig(2), 'Position',[pos(1:2) sz]);
        drawnow;
    end

    function onType(~,e)
        %ONTYPE  Event handler for key press on figure

        switch e.Key
            case 'h'
                helpdlg({
                    'Use your mouse to select a point and move it'
                    'to see transformation changes.'
                    ''
                    'Hot keys:'
                    'h - this help dialog'
                    'q - quit the program'
                    'r - change order of points to rotate transformation'
                    'i - change order of points to invert transformation '
                });
            case {'q', 'escape'}
                close(h.fig);
            case 'r'
                roi = circshift(roi, -1);
                redraw();
            case 'i'
                roi = roi([2 1 4 3],:);
                redraw();
        end
    end

    function onMouseDown(~,~)
        %ONMOUSEDOWN  Event handler for mouse down on figure

        % hit-test for closest ROI corner
        pt = getCurrentPoint(h.ax(1));
        d = sum(abs(bsxfun(@minus, roi, pt)), 2);
        [mn, pt_idx] = min(d);
        if mn < 20
            % attach event handlers, and change mouse pointer
            set(h.fig(1), 'Pointer','cross', ...
                'WindowButtonMotionFcn',{@onMouseMove, pt_idx}, ...
                'WindowButtonUpFcn',@onMouseUp);
        end
    end

    function onMouseMove(~,~,idx)
        %ONMOUSEMOVE  Event handler for mouse move on figure

        % move specified ROI corner
        pt = getCurrentPoint(h.ax(1));
        roi(idx,:) = pt;
        redraw();
    end

    function onMouseUp(~,~)
        %ONMOUSEUP  Event handler for mouse up on figure

        % detach event handlers, and restore mouse pointer
        set(h.fig(1), 'Pointer','arrow', ...
            'WindowButtonMotionFcn','', ...
            'WindowButtonUpFcn','');
    end
end

%% Helper Functions

function out = drawROI(img, pts)
    %DRAWROI  Show ROI corners with labels

    labels = {'TL', 'TR', 'BR', 'BL'};
    out = cv.polylines(img, pts, 'Closed',true, 'Color',[0 0 255], 'Thickness',2);
    out = cv.circle(out, pts, 5, 'Color',[0 255 0], 'Thickness',3);
    out = cv.putText(out, labels, pts, ...
        'FontScale',0.8, 'Color',[255 0 0], 'Thickness',2);
end

function [out, dsz] = warpROI(img, srcPts)
    %WARPROI  Compute warped image from ROI

    % map ROI corners to corresponding destination rectangle
    len = diff(srcPts([1:end 1],:), 1, 1);  % [TR-TL; BR-TR; BL-BR; TL-BL]
    len = cellfun(@norm, num2cell(len, 2)); % lengths of sides
    w = max(len(1), len(3));
    h = max(len(2), len(4));
    dstPts = [0 0; w 0; w h; 0 h];

    % compute homography between points and apply persepective transformation
    dsz = round([w h]);
    H = cv.findHomography(srcPts, dstPts);
    out = cv.warpPerspective(img, H, 'DSize',dsz);
end

function p = getCurrentPoint(ax)
    %GETCURRENTPOINT  Retrieve current mouse location

    p = get(ax, 'CurrentPoint');
    p = p(1,1:2) - 1;
end

function h = buildGUI(img, roi)
    %BUILDGUI  Creates the UI

    % apply initial perspective transformation
    out1 = drawROI(img, roi);
    out2 = warpROI(img, roi);
    sz1 = size(out1);
    sz2 = size(out2);

    % properties
    fprops = {'Menubar','none', 'Resize','on'};
    aprops = {'Units','normalized', 'Position',[0 0 1 1]};
    h = struct();

    % show input image + ROI corners
    h.fig(1) = figure('Name','Image', ...
        'Position',[100 200 sz1(2) sz1(1)], fprops{:});
    h.ax(1) = axes('Parent',h.fig(1), aprops{:});
    if mexopencv.isOctave()
        h.img(1) = imshow(out1);
    else
        h.img(1) = imshow(out1, 'Parent',h.ax(1));
    end

    % show warped image
    h.fig(2) = figure('Name','Warped', ...
        'Position',[200+sz1(2) 200 sz2(2) sz2(1)], fprops{:});
    h.ax(2) = axes('Parent',h.fig(2), aprops{:});
    if mexopencv.isOctave()
        h.img(2) = imshow(out2);
    else
        h.img(2) = imshow(out2, 'Parent',h.ax(2));
    end
end

##### SOURCE END #####
-->
   </body>
</html>