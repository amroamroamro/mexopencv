<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Background Subtraction demo</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="segment_objects_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Background Subtraction demo</h1>
         <!--introduction-->
         <p>An example using drawContours to clean up a background segmentation result.</p>
         <p>This program demonstrates a simple method of connected components clean up of background subtraction. When the program starts,
            it begins learning the background. You can toggle background learning on and off using the checkbox.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/segment_objects.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/segment_objects.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#2">Set up video source: video file or camera</a></li>
               <li><a href="#3">Create a background subtractor</a></li>
               <li><a href="#5">Prepare window</a></li>
               <li><a href="#6">Main loop</a></li>
            </ul>
         </div>
         <h2 id="2">Set up video source: video file or camera</h2><pre class="codeinput">fname = fullfile(mexopencv.root(),<span class="string">'test'</span>,<span class="string">'768x576.avi'</span>);
<span class="keyword">if</span> exist(fname, <span class="string">'file'</span>) ~= 2
    <span class="comment">% download video from Github</span>
    disp(<span class="string">'Downloading video...'</span>)
    url = <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.1.0/samples/data/768x576.avi'</span>;
    urlwrite(url, fname);
<span class="keyword">end</span>
cap = cv.VideoCapture(fname);
<span class="comment">%cap = cv.VideoCapture(0); pause(2);</span>
assert(cap.isOpened(), <span class="string">'Cannot open video source'</span>);
cap.PosFrames = 750;

frame = cap.read();
assert(~isempty(frame), <span class="string">'Cannot read data from the video source'</span>);</pre><h2 id="3">Create a background subtractor</h2><pre class="codeinput">bs = cv.BackgroundSubtractorMOG2(<span class="string">'VarThreshold'</span>,10);</pre><pre class="codeinput">ZR = zeros(size(frame,1), size(frame,2), <span class="string">'uint8'</span>);
niters = 3;</pre><h2 id="5">Prepare window</h2><pre class="codeinput">hFig = figure(<span class="string">'Position'</span>,[100 100 840 630], <span class="keyword">...</span>
    <span class="string">'KeyPressFcn'</span>,@(o,e)setappdata(o,<span class="string">'flag'</span>,true));
setappdata(hFig, <span class="string">'flag'</span>,false);
subplot(221), hImg(1) = imshow(frame); title(<span class="string">'video'</span>)
subplot(222), hImg(2) = imshow(frame); title(<span class="string">'BG model'</span>)
subplot(223), hImg(3) = imshow(ZR); title(<span class="string">'FG segmented'</span>)
subplot(224), hImg(4) = imshow(ZR); title(<span class="string">'FG largest component'</span>)
hCB = uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="string">'Position'</span>,[20 20 200 20], <span class="keyword">...</span>
    <span class="string">'String'</span>,<span class="string">'Update Background Model'</span>, <span class="string">'Value'</span>,true);</pre><img src="segment_objects_demo_01.png"><h2 id="6">Main loop</h2><pre class="codeinput"><span class="keyword">while</span> ishghandle(hFig)
    <span class="comment">% get next frame</span>
    frame = cap.read();
    <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>

    <span class="comment">% determine whether to update BG model or not, then compute FG mask</span>
    update_bg_model = get(hCB,<span class="string">'Value'</span>);
    <span class="keyword">if</span> update_bg_model
        learnRate = -1; <span class="comment">% automatically chosen learning rate</span>
    <span class="keyword">else</span>
        learnRate = 0;  <span class="comment">% dont update BG model</span>
    <span class="keyword">end</span>
    fgmask = bs.apply(frame, <span class="string">'LearningRate'</span>,learnRate);

    <span class="comment">% process mask and extract largest connected component</span>
    bw = cv.dilate(fgmask, <span class="string">'Iterations'</span>,niters);
    bw = cv.erode(bw, <span class="string">'Iterations'</span>,niters*2);
    bw = cv.dilate(bw, <span class="string">'Iterations'</span>,niters);
    [contours, hierarchy] = cv.findContours(bw, <span class="keyword">...</span>
        <span class="string">'Mode'</span>,<span class="string">'CComp'</span>, <span class="string">'Method'</span>,<span class="string">'Simple'</span>);
    <span class="keyword">if</span> ~isempty(contours)
        maxArea = 0;
        largestComp = 0;
        idx = 0;
        <span class="keyword">while</span> idx &gt;= 0
            <span class="comment">% compute contour area</span>
            a = abs(cv.contourArea(contours{idx+1}));
            <span class="keyword">if</span> a &gt; maxArea
                maxArea = a;
                largestComp = idx;
            <span class="keyword">end</span>
            <span class="comment">% iterate through all the top-level contours</span>
            idx = hierarchy{idx+1}(1);
        <span class="keyword">end</span>
        out_frame = cv.drawContours(ZR, contours, <span class="keyword">...</span>
            <span class="string">'ContourIdx'</span>,largestComp, <span class="string">'Hierarchy'</span>,hierarchy, <span class="keyword">...</span>
            <span class="string">'Color'</span>,255, <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
    <span class="keyword">else</span>
        out_frame = ZR;
    <span class="keyword">end</span>

    <span class="comment">% update images</span>
    set(hImg(1), <span class="string">'CData'</span>,frame)     <span class="comment">% video frame</span>
    <span class="keyword">if</span> update_bg_model
        <span class="comment">% get the current BG model</span>
        set(hImg(2), <span class="string">'CData'</span>,bs.getBackgroundImage())
    <span class="keyword">end</span>
    set(hImg(3), <span class="string">'CData'</span>,fgmask)    <span class="comment">% FG mask</span>
    set(hImg(4), <span class="string">'CData'</span>,out_frame) <span class="comment">% largest contour in FG mask</span>

    <span class="comment">% Terminate if any user input</span>
    flag = getappdata(hFig, <span class="string">'flag'</span>);
    <span class="keyword">if</span> isempty(flag)||flag, <span class="keyword">break</span>; <span class="keyword">end</span>
    pause(0.1);
<span class="keyword">end</span></pre><img src="segment_objects_demo_02.png"><p>release camera</p><pre class="codeinput">cap.release()</pre><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Background Subtraction demo
% An example using drawContours to clean up a background segmentation result.
%
% This program demonstrates a simple method of connected components clean up
% of background subtraction.
% When the program starts, it begins learning the background.
% You can toggle background learning on and off using the checkbox.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/segment_objects.cpp>
%

%% Set up video source: video file or camera
fname = fullfile(mexopencv.root(),'test','768x576.avi');
if exist(fname, 'file') ~= 2
    % download video from Github
    disp('Downloading video...')
    url = 'https://cdn.rawgit.com/opencv/opencv/3.1.0/samples/data/768x576.avi';
    urlwrite(url, fname);
end
cap = cv.VideoCapture(fname);
%cap = cv.VideoCapture(0); pause(2);
assert(cap.isOpened(), 'Cannot open video source');
cap.PosFrames = 750;

frame = cap.read();
assert(~isempty(frame), 'Cannot read data from the video source');

%% Create a background subtractor
bs = cv.BackgroundSubtractorMOG2('VarThreshold',10);

%%
ZR = zeros(size(frame,1), size(frame,2), 'uint8');
niters = 3;

%% Prepare window
hFig = figure('Position',[100 100 840 630], ...
    'KeyPressFcn',@(o,e)setappdata(o,'flag',true));
setappdata(hFig, 'flag',false);
subplot(221), hImg(1) = imshow(frame); title('video')
subplot(222), hImg(2) = imshow(frame); title('BG model')
subplot(223), hImg(3) = imshow(ZR); title('FG segmented')
subplot(224), hImg(4) = imshow(ZR); title('FG largest component')
hCB = uicontrol('Style','checkbox', 'Position',[20 20 200 20], ...
    'String','Update Background Model', 'Value',true);

%% Main loop
while ishghandle(hFig)
    % get next frame
    frame = cap.read();
    if isempty(frame), break; end

    % determine whether to update BG model or not, then compute FG mask
    update_bg_model = get(hCB,'Value');
    if update_bg_model
        learnRate = -1; % automatically chosen learning rate
    else
        learnRate = 0;  % dont update BG model
    end
    fgmask = bs.apply(frame, 'LearningRate',learnRate);

    % process mask and extract largest connected component
    bw = cv.dilate(fgmask, 'Iterations',niters);
    bw = cv.erode(bw, 'Iterations',niters*2);
    bw = cv.dilate(bw, 'Iterations',niters);
    [contours, hierarchy] = cv.findContours(bw, ...
        'Mode','CComp', 'Method','Simple');
    if ~isempty(contours)
        maxArea = 0;
        largestComp = 0;
        idx = 0;
        while idx >= 0
            % compute contour area
            a = abs(cv.contourArea(contours{idx+1}));
            if a > maxArea
                maxArea = a;
                largestComp = idx;
            end
            % iterate through all the top-level contours
            idx = hierarchy{idx+1}(1);
        end
        out_frame = cv.drawContours(ZR, contours, ...
            'ContourIdx',largestComp, 'Hierarchy',hierarchy, ...
            'Color',255, 'Thickness','Filled');
    else
        out_frame = ZR;
    end

    % update images
    set(hImg(1), 'CData',frame)     % video frame
    if update_bg_model
        % get the current BG model
        set(hImg(2), 'CData',bs.getBackgroundImage())
    end
    set(hImg(3), 'CData',fgmask)    % FG mask
    set(hImg(4), 'CData',out_frame) % largest contour in FG mask

    % Terminate if any user input
    flag = getappdata(hFig, 'flag');
    if isempty(flag)||flag, break; end
    pause(0.1);
end

%%
% release camera
cap.release()

##### SOURCE END #####
-->
   </body>
</html>