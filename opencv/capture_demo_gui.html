<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Video Capture</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="capture_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Video Capture</h1>
         <p>We learn how to capture live stream from camera and display it, while adjusting basic video color properties.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://docs.opencv.org/3.2.0/dd/d43/tutorial_py_video_display.html">https://docs.opencv.org/3.2.0/dd/d43/tutorial_py_video_display.html</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_basic.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_basic.cpp</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_starter.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_starter.cpp</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = capture_demo_gui()
    <span class="comment">% create the UI</span>
    h = buildGUI();
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>

    <span class="comment">% main loop</span>
    counter = 0;
    tID = tic();
    <span class="keyword">while</span> ishghandle(h.fig)
        <span class="comment">% get frame-by-frame</span>
        frame = h.cap.read();
        <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>

        <span class="comment">% FPS</span>
        counter = counter + 1;
        frame = cv.putText(frame, sprintf(<span class="string">'FPS = %.2f'</span>, counter/toc(tID)), <span class="keyword">...</span>
            [10 20], <span class="string">'FontFace'</span>,<span class="string">'HersheyPlain'</span>, <span class="string">'Color'</span>,[0 255 0]);

        <span class="comment">% display</span>
        set(h.img, <span class="string">'CData'</span>,frame);
        drawnow;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onType(~,e,h)
    <span class="comment">%ONTYPE  Event handler for key press on figure</span>

    <span class="comment">% handle keys</span>
    <span class="keyword">switch</span> e.Key
        <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
            close(h.fig);

        <span class="keyword">case</span> {<span class="string">'c'</span>, <span class="string">'s'</span>, <span class="string">'space'</span>, <span class="string">'enter'</span>}
            frame = h.cap.retrieve();
            filename = sprintf(<span class="string">'capture_%s.jpg'</span>, datestr(now(),<span class="string">'yyyymmddTHHMMSS'</span>));
            cv.imwrite(filename, frame);
            disp([<span class="string">'Saved '</span> filename]);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onChange(~,~,h)
    <span class="comment">%ONCHANGE  Event handler for UI controls</span>

    <span class="comment">% retrieve current values from UI controls</span>
    <span class="comment">% and update corresponding properties</span>
    h.cap.set(<span class="string">'Brightness'</span>, round(get(h.slid(1), <span class="string">'Value'</span>)));
    h.cap.set(<span class="string">'Contrast'</span>,   round(get(h.slid(2), <span class="string">'Value'</span>)));
    h.cap.set(<span class="string">'Saturation'</span>, round(get(h.slid(3), <span class="string">'Value'</span>)));

    <span class="comment">% update UI</span>
    set(h.txt(1), <span class="string">'String'</span>,sprintf(<span class="string">'Brightness: %2d'</span>,h.cap.get(<span class="string">'Brightness'</span>)));
    set(h.txt(2), <span class="string">'String'</span>,sprintf(<span class="string">'Contrast: %2d'</span>,  h.cap.get(<span class="string">'Contrast'</span>)));
    set(h.txt(3), <span class="string">'String'</span>,sprintf(<span class="string">'Saturation: %2d'</span>,h.cap.get(<span class="string">'Saturation'</span>)));
    drawnow;
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI()
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% setup video capture</span>
    <span class="comment">%cap = cv.VideoCapture(0, 'API','Any');</span>
    cap = createVideoCapture([], <span class="string">'chess'</span>);
    pause(1);
    assert(cap.isOpened());

    <span class="comment">% video settings</span>
    frame = cap.read();
    assert(~isempty(frame));
    sz = size(frame);
    fourcc = char(typecast(int32(cap.get(<span class="string">'FourCC'</span>)), <span class="string">'uint8'</span>));

    <span class="comment">% build the user interface (no resizing to keep it simple)</span>
    h = struct();
    h.cap = cap;
    h.fig = figure(<span class="string">'Name'</span>,sprintf(<span class="string">'Video Capture: %dx%d %s'</span>, sz(2), sz(1), fourcc), <span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[200 200 sz(2) sz(1)+80-1]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: not implemented in Octave</span>
        movegui(h.fig, <span class="string">'center'</span>);
    <span class="keyword">end</span>
    h.ax = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[1 80 sz(2) sz(1)]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        h.img = imshow(frame, <span class="string">'Parent'</span>,h.ax);
    <span class="keyword">else</span>
        <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
        axes(h.ax);
        h.img = imshow(frame);
    <span class="keyword">end</span>
    h.txt(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 5 130 20], <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'String'</span>,sprintf(<span class="string">'Brightness: %2d'</span>,cap.get(<span class="string">'Brightness'</span>)));
    h.txt(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 30 130 20], <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'String'</span>,sprintf(<span class="string">'Contrast: %2d'</span>,cap.get(<span class="string">'Contrast'</span>)));
    h.txt(3) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 55 130 20], <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'String'</span>,sprintf(<span class="string">'Saturation: %2d'</span>,cap.get(<span class="string">'Saturation'</span>)));
    h.slid(1) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[135 5 sz(2)-135-5 20], <span class="string">'Value'</span>,cap.get(<span class="string">'Brightness'</span>), <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,100, <span class="string">'SliderStep'</span>,[1 10]./(100-0));
    h.slid(2) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[135 30 sz(2)-135-5 20], <span class="string">'Value'</span>,cap.get(<span class="string">'Contrast'</span>), <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,100, <span class="string">'SliderStep'</span>,[1 10]./(100-0));
    h.slid(3) = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[135 55 sz(2)-135-5 20], <span class="string">'Value'</span>,cap.get(<span class="string">'Saturation'</span>), <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,100, <span class="string">'SliderStep'</span>,[1 10]./(100-0));

    <span class="comment">% hook event handlers</span>
    opts = {<span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>};
    set(h.slid, <span class="string">'Callback'</span>,{@onChange,h}, opts{:});
    set(h.fig, <span class="string">'WindowKeyPressFcn'</span>,{@onType,h}, opts{:});
<span class="keyword">end</span></pre><img src="capture_demo_gui_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Video Capture
% We learn how to capture live stream from camera and display it, while
% adjusting basic video color properties.
%
% Sources:
%
% * <https://docs.opencv.org/3.2.0/dd/d43/tutorial_py_video_display.html>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_basic.cpp>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/videocapture_starter.cpp>
%

function varargout = capture_demo_gui()
    % create the UI
    h = buildGUI();
    if nargout > 0, varargout{1} = h; end

    % main loop
    counter = 0;
    tID = tic();
    while ishghandle(h.fig)
        % get frame-by-frame
        frame = h.cap.read();
        if isempty(frame), break; end

        % FPS
        counter = counter + 1;
        frame = cv.putText(frame, sprintf('FPS = %.2f', counter/toc(tID)), ...
            [10 20], 'FontFace','HersheyPlain', 'Color',[0 255 0]);

        % display
        set(h.img, 'CData',frame);
        drawnow;
    end
end

function onType(~,e,h)
    %ONTYPE  Event handler for key press on figure

    % handle keys
    switch e.Key
        case {'q', 'escape'}
            close(h.fig);

        case {'c', 's', 'space', 'enter'}
            frame = h.cap.retrieve();
            filename = sprintf('capture_%s.jpg', datestr(now(),'yyyymmddTHHMMSS'));
            cv.imwrite(filename, frame);
            disp(['Saved ' filename]);
    end
end

function onChange(~,~,h)
    %ONCHANGE  Event handler for UI controls

    % retrieve current values from UI controls
    % and update corresponding properties
    h.cap.set('Brightness', round(get(h.slid(1), 'Value')));
    h.cap.set('Contrast',   round(get(h.slid(2), 'Value')));
    h.cap.set('Saturation', round(get(h.slid(3), 'Value')));

    % update UI
    set(h.txt(1), 'String',sprintf('Brightness: %2d',h.cap.get('Brightness')));
    set(h.txt(2), 'String',sprintf('Contrast: %2d',  h.cap.get('Contrast')));
    set(h.txt(3), 'String',sprintf('Saturation: %2d',h.cap.get('Saturation')));
    drawnow;
end

function h = buildGUI()
    %BUILDGUI  Creates the UI

    % setup video capture
    %cap = cv.VideoCapture(0, 'API','Any');
    cap = createVideoCapture([], 'chess');
    pause(1);
    assert(cap.isOpened());

    % video settings
    frame = cap.read();
    assert(~isempty(frame));
    sz = size(frame);
    fourcc = char(typecast(int32(cap.get('FourCC')), 'uint8'));

    % build the user interface (no resizing to keep it simple)
    h = struct();
    h.cap = cap;
    h.fig = figure('Name',sprintf('Video Capture: %dx%d %s', sz(2), sz(1), fourcc), ...
        'NumberTitle','off', 'Menubar','none', 'Resize','off', ...
        'Position',[200 200 sz(2) sz(1)+80-1]);
    if ~mexopencv.isOctave()
        %HACK: not implemented in Octave
        movegui(h.fig, 'center');
    end
    h.ax = axes('Parent',h.fig, 'Units','pixels', 'Position',[1 80 sz(2) sz(1)]);
    if ~mexopencv.isOctave()
        h.img = imshow(frame, 'Parent',h.ax);
    else
        %HACK: https://savannah.gnu.org/bugs/index.php?45473
        axes(h.ax);
        h.img = imshow(frame);
    end
    h.txt(1) = uicontrol('Parent',h.fig, 'Style','text', ...
        'Position',[5 5 130 20], 'FontSize',11, ...
        'String',sprintf('Brightness: %2d',cap.get('Brightness')));
    h.txt(2) = uicontrol('Parent',h.fig, 'Style','text', ...
        'Position',[5 30 130 20], 'FontSize',11, ...
        'String',sprintf('Contrast: %2d',cap.get('Contrast')));
    h.txt(3) = uicontrol('Parent',h.fig, 'Style','text', ...
        'Position',[5 55 130 20], 'FontSize',11, ...
        'String',sprintf('Saturation: %2d',cap.get('Saturation')));
    h.slid(1) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Position',[135 5 sz(2)-135-5 20], 'Value',cap.get('Brightness'), ...
        'Min',0, 'Max',100, 'SliderStep',[1 10]./(100-0));
    h.slid(2) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Position',[135 30 sz(2)-135-5 20], 'Value',cap.get('Contrast'), ...
        'Min',0, 'Max',100, 'SliderStep',[1 10]./(100-0));
    h.slid(3) = uicontrol('Parent',h.fig, 'Style','slider', ...
        'Position',[135 55 sz(2)-135-5 20], 'Value',cap.get('Saturation'), ...
        'Min',0, 'Max',100, 'SliderStep',[1 10]./(100-0));

    % hook event handlers
    opts = {'Interruptible','off', 'BusyAction','cancel'};
    set(h.slid, 'Callback',{@onChange,h}, opts{:});
    set(h.fig, 'WindowKeyPressFcn',{@onType,h}, opts{:});
end

##### SOURCE END #####
-->
   </body>
</html>