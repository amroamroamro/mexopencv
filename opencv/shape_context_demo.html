<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Shape context for shape matching</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="shape_context_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Shape context for shape matching</h1>
         <!--introduction-->
         <p>This program demonstrates a method for shape comparison based on Shape Context.</p>
         <p>We use 20 sample images from OpenCV: https://github.com/opencv/opencv/tree/3.1.0/samples/data/shape_sample/*.png</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/shape_example.cpp">https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/shape_example.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <p>Read set of images</p><pre class="codeinput">fpath = fullfile(mexopencv.root(),<span class="string">'test'</span>);
files = dir(fullfile(fpath,<span class="string">'shape*.png'</span>));
imgs = cell(1, numel(files));
<span class="keyword">for</span> i=1:numel(files)
    imgs{i} = cv.imread(fullfile(fpath, files(i).name), <span class="string">'Grayscale'</span>,true);
<span class="keyword">end</span></pre><p>Extract contours</p><pre class="codeinput">contours = cell(size(imgs));
<span class="keyword">for</span> i=1:numel(imgs)
    cont = cv.findContours(imgs{i}, <span class="string">'Mode'</span>,<span class="string">'List'</span>, <span class="string">'Method'</span>,<span class="string">'None'</span>);
    cont = [cont{:}];
    cont = cat(1,cont{:});
    contours{i} = cont;    <span class="comment">% flattened 2D points</span>
<span class="keyword">end</span></pre><p>use the same number of points for all images</p><pre class="codeinput">[NN,~] = cellfun(@size, contours);
npts = min(NN);  <span class="comment">% 300</span>
<span class="keyword">for</span> i=1:numel(contours)
    cont = contours{i};
    N = size(cont,1);

    <span class="comment">% uniformly sample same number of points</span>
    idx = randperm(N, npts);
    cont = cont(sort(idx),:);

    <span class="comment">% reshaped into 2-channels as 1xNx2</span>
    contours{i} = permute(cont, [3 1 2]);
<span class="keyword">end</span></pre><p>query image (provide any number between 1 and 20 for selecting an image in the folder)</p><pre class="codeinput">indexQuery = 11;</pre><p>compute distance between query and all images</p><pre class="codeinput"><span class="keyword">if</span> true
    sc = cv.ShapeContextDistanceExtractor();
<span class="keyword">else</span>
    sc = cv.HausdorffDistanceExtractor();
<span class="keyword">end</span>
dist = zeros(size(contours));
hWait = waitbar(0, <span class="string">'Calculating distances'</span>);
<span class="keyword">for</span> i=1:numel(contours)
    <span class="keyword">if</span> i == indexQuery
        <span class="keyword">continue</span>;
    <span class="keyword">end</span>
    waitbar(i/numel(contours), hWait);
    tic
    dist(i) = sc.computeDistance(contours{indexQuery}, contours{i});
    toc
<span class="keyword">end</span>
close(hWait)

<span class="comment">% sorted matches</span>
[~,ord] = sort(dist);</pre><pre class="codeoutput">Elapsed time is 5.400297 seconds.
Elapsed time is 5.340579 seconds.
Elapsed time is 5.337628 seconds.
Elapsed time is 5.352275 seconds.
Elapsed time is 5.587719 seconds.
Elapsed time is 5.510961 seconds.
Elapsed time is 5.550998 seconds.
Elapsed time is 5.539079 seconds.
Elapsed time is 5.418877 seconds.
Elapsed time is 5.475764 seconds.
Elapsed time is 5.526154 seconds.
Elapsed time is 5.485514 seconds.
Elapsed time is 5.548504 seconds.
Elapsed time is 5.548055 seconds.
Elapsed time is 5.555361 seconds.
Elapsed time is 5.491198 seconds.
Elapsed time is 5.485358 seconds.
Elapsed time is 5.436754 seconds.
Elapsed time is 5.491954 seconds.
</pre><p>show all distances (sorted)</p><pre class="codeinput"><span class="keyword">if</span> ~mexopencv.isOctave()
    <span class="comment">%HACK: not implemented in Octave</span>
    t = array2table(dist(:), <span class="string">'VariableNames'</span>,{<span class="string">'Distance'</span>}, <span class="keyword">...</span>
        <span class="string">'RowNames'</span>,cellstr(num2str((1:numel(dist))')));
    display(sortrows(t))
<span class="keyword">end</span></pre><pre class="codeoutput">  20&times;1 table
           Distance 
          __________
    11             0
    12        3.4207
    1         4.0969
    9         88.539
    5         242.81
    15        263.47
    10        274.33
    6         421.81
    16        486.32
    2         565.28
    8         1669.6
    7         2154.4
    20         30147
    18         38864
    19         55634
    13         88106
    14         97760
    17    1.0517e+05
    4     1.2892e+05
    3     1.8379e+05
</pre><p>show best 3 image matches</p><pre class="codeinput">subplot(221), imshow(imgs{indexQuery}), title(<span class="string">'query'</span>)
<span class="keyword">for</span> i=(1:3)+1
    subplot(2,2,i), imshow(imgs{ord(i)})
    title(sprintf(<span class="string">'match #%d = %.3f'</span>, i-1, dist(ord(i))))
<span class="keyword">end</span></pre><img src="shape_context_demo_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Shape context for shape matching
% This program demonstrates a method for shape comparison based on Shape
% Context.
%
% We use 20 sample images from OpenCV:
% https://github.com/opencv/opencv/tree/3.1.0/samples/data/shape_sample/*.png
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/shape_example.cpp>
%

%%
% Read set of images
fpath = fullfile(mexopencv.root(),'test');
files = dir(fullfile(fpath,'shape*.png'));
imgs = cell(1, numel(files));
for i=1:numel(files)
    imgs{i} = cv.imread(fullfile(fpath, files(i).name), 'Grayscale',true);
end

%%
% Extract contours
contours = cell(size(imgs));
for i=1:numel(imgs)
    cont = cv.findContours(imgs{i}, 'Mode','List', 'Method','None');
    cont = [cont{:}];
    cont = cat(1,cont{:});
    contours{i} = cont;    % flattened 2D points
end

%%
% use the same number of points for all images
[NN,~] = cellfun(@size, contours);
npts = min(NN);  % 300
for i=1:numel(contours)
    cont = contours{i};
    N = size(cont,1);

    % uniformly sample same number of points
    idx = randperm(N, npts);
    cont = cont(sort(idx),:);

    % reshaped into 2-channels as 1xNx2
    contours{i} = permute(cont, [3 1 2]);
end

%%
% query image
% (provide any number between 1 and 20 for selecting an image in the folder)
indexQuery = 11;

%%
% compute distance between query and all images
if true
    sc = cv.ShapeContextDistanceExtractor();
else
    sc = cv.HausdorffDistanceExtractor();
end
dist = zeros(size(contours));
hWait = waitbar(0, 'Calculating distances');
for i=1:numel(contours)
    if i == indexQuery
        continue;
    end
    waitbar(i/numel(contours), hWait);
    tic
    dist(i) = sc.computeDistance(contours{indexQuery}, contours{i});
    toc
end
close(hWait)

% sorted matches
[~,ord] = sort(dist);

%%
% show all distances (sorted)
if ~mexopencv.isOctave()
    %HACK: not implemented in Octave
    t = array2table(dist(:), 'VariableNames',{'Distance'}, ...
        'RowNames',cellstr(num2str((1:numel(dist))')));
    display(sortrows(t))
end

%%
% show best 3 image matches
subplot(221), imshow(imgs{indexQuery}), title('query')
for i=(1:3)+1
    subplot(2,2,i), imshow(imgs{ord(i)})
    title(sprintf('match #%d = %.3f', i-1, dist(ord(i))))
end

##### SOURCE END #####
-->
   </body>
</html>