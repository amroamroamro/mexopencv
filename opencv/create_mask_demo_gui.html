<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Interactive Mask demo</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="create_mask_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Interactive Mask demo</h1>
         <p>Interactively create a polygon mask.</p>
         <p>This tutorial demonstrates how to make mask image (black and white). The program takes as input a source image and outputs
            its corresponding mask image.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/create_mask.cpp">https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/create_mask.cpp</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = create_mask_demo_gui(im)
    <span class="comment">% load an image</span>
    <span class="keyword">if</span> nargin &lt; 1
        src = imread(fullfile(mexopencv.root(),<span class="string">'test'</span>,<span class="string">'fruits.jpg'</span>));
    <span class="keyword">elseif</span> isempty(im)
        [im,cancel] = imgetfile();
        assert(~cancel, <span class="string">'No file selected'</span>);
        src = imread(im);
    <span class="keyword">elseif</span> ischar(im)
        src = cv.imread(im, <span class="string">'Color'</span>,true);
    <span class="keyword">else</span>
        src = im;
    <span class="keyword">end</span>
    assert(size(src,3) == 3, <span class="string">'Expecting a color source image'</span>);

    <span class="comment">% shared data</span>
    sz = size(src);
    out = [];        <span class="comment">% output image</span>
    pts = [];        <span class="comment">% 2D points</span>

    <span class="comment">% create the UI</span>
    h = buildGUI();
    onReset([],[]);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>


    <span class="keyword">function</span> h = buildGUI()
        <span class="comment">%BUILDGUI  Creates the UI</span>

        h = struct();
        h.fig = figure(<span class="string">'Name'</span>,<span class="string">'Interactive Mask'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
            <span class="string">'Position'</span>,[200 200 sz(2) sz(1)]);
        <span class="keyword">if</span> ~mexopencv.isOctave()
            <span class="comment">%HACK: not implemented in Octave</span>
            movegui(h.fig, <span class="string">'center'</span>);
        <span class="keyword">end</span>
        h.ax = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,[0 0 1 1]);
        <span class="keyword">if</span> ~mexopencv.isOctave()
            h.img = imshow(src, <span class="string">'Parent'</span>,h.ax);
        <span class="keyword">else</span>
            <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
            axes(h.ax);
            h.img = imshow(src);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onHelp(~,~)
        <span class="comment">%ONHELP  Display usage help dialog</span>

        hd = helpdlg({
            <span class="string">'Left-click the mouse to define the vertices of the polygon.'</span>
            <span class="string">'Right-click when finished to close the polygon, connecting'</span>
            <span class="string">'the last vertex with the first.'</span>
            <span class="string">'Hot keys:'</span>
            <span class="string">'  h: usage dialog'</span>
            <span class="string">'  r: reset'</span>
            <span class="string">'  s: save current output image as PNG image'</span>
            <span class="string">'  p: save current points matrix as MAT-file'</span>
            <span class="string">'  q: quit the program'</span>
        }, <span class="string">'Interactive mask demo'</span>);
        set(hd, <span class="string">'WindowStyle'</span>,<span class="string">'modal'</span>);
    <span class="keyword">end</span>

    <span class="keyword">function</span> onReset(~,~)
        <span class="comment">%ONRESET  Restart from scratch</span>

        <span class="comment">% reset data</span>
        pts = zeros(0,2);
        out = src;

        <span class="comment">% register mouse button handlers and change cursor</span>
        set(h.fig, <span class="string">'Pointer'</span>,<span class="string">'cross'</span>, <span class="string">'WindowKeyPressFcn'</span>,@onType, <span class="keyword">...</span>
            <span class="string">'WindowButtonDownFcn'</span>,@onMouseDown, <span class="keyword">...</span>
            <span class="string">'WindowButtonUpFcn'</span>,@onMouseUp);

        <span class="comment">% update plot</span>
        set(h.img, <span class="string">'CData'</span>,out);
        drawnow;
    <span class="keyword">end</span>

    <span class="keyword">function</span> onType(~,e)
        <span class="comment">%ONTYPE  Event handler for key press on figure</span>

        <span class="comment">% handle keys</span>
        <span class="keyword">switch</span> e.Key
            <span class="keyword">case</span> <span class="string">'r'</span>
                onReset([],[]);
            <span class="keyword">case</span> <span class="string">'h'</span>
                onHelp([],[]);
            <span class="keyword">case</span> <span class="string">'s'</span>
                fname = [tempname() <span class="string">'.png'</span>];
                imwrite(out, fname);
                fprintf(<span class="string">'Output saved as "%s"\n'</span>, fname);
            <span class="keyword">case</span> <span class="string">'p'</span>
                uisave({<span class="string">'pts'</span>}, <span class="string">'points.mat'</span>);
            <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
                close(h.fig);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onMouseDown(~,~)
        <span class="comment">%ONMOUSEDOWN  Event handler for mouse down on figure</span>

        <span class="keyword">if</span> strcmp(get(h.fig,<span class="string">'SelectionType'</span>), <span class="string">'normal'</span>)
            <span class="comment">% get current location of mouse pointer</span>
            pt = get(h.ax, <span class="string">'CurrentPoint'</span>);
            pt = round(pt(1,1:2));

            <span class="comment">% draw point</span>
            out = cv.circle(out, pt, 2, <span class="keyword">...</span>
                <span class="string">'Color'</span>,[255 0 0], <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);

            <span class="comment">% store point</span>
            pts(end+1,:) = pt;

            <span class="comment">% connect to previous point by a straight line</span>
            <span class="keyword">if</span> size(pts,1) &gt;= 2
                out = cv.line(out, pts(end-1,:), pts(end,:), <span class="keyword">...</span>
                    <span class="string">'Color'</span>,[255 0 0], <span class="string">'Thickness'</span>,2);
            <span class="keyword">end</span>

            <span class="comment">% update plot</span>
            set(h.img, <span class="string">'CData'</span>,out);
            drawnow;
        <span class="keyword">else</span>
            <span class="comment">% create a polygon from all vertices</span>
            out = src;
            <span class="keyword">if</span> ~isempty(pts)
                out = cv.polylines(out, pts, <span class="keyword">...</span>
                    <span class="string">'Closed'</span>,true, <span class="string">'Color'</span>,[0 0 0], <span class="string">'Thickness'</span>,2);
            <span class="keyword">end</span>

            <span class="comment">% update plot</span>
            set(h.img, <span class="string">'CData'</span>,out);
            drawnow;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onMouseUp(~,~)
        <span class="comment">%ONMOUSEUP  Event handler for mouse up on figure</span>

        <span class="comment">% only respond to right mouse button up</span>
        <span class="keyword">if</span> strcmp(get(h.fig,<span class="string">'SelectionType'</span>), <span class="string">'normal'</span>), <span class="keyword">return</span>; <span class="keyword">end</span>

        <span class="comment">% unregister all mouse button handlers</span>
        set(h.fig, <span class="string">'Pointer'</span>,<span class="string">'arrow'</span>, <span class="keyword">...</span>
            <span class="string">'WindowButtonDownFcn'</span>,<span class="string">''</span>, <span class="string">'WindowButtonUpFcn'</span>,<span class="string">''</span>);

        <span class="comment">% create binary mask from polygon</span>
        mask = zeros(sz(1:2), <span class="string">'uint8'</span>);
        <span class="keyword">if</span> ~isempty(pts)
            mask = cv.fillPoly(mask, pts, <span class="string">'Color'</span>,[255 255 255]);
        <span class="keyword">end</span>
        cv.imwrite(fullfile(tempdir(), <span class="string">'mask.png'</span>), mask);
        disp([<span class="string">'Mask saved: '</span> fullfile(tempdir(), <span class="string">'mask.png'</span>)]);

        <span class="comment">% apply mask on image</span>
        out = bsxfun(@times, uint8(mask~=0), src);

        <span class="comment">% update plot</span>
        set(h.img, <span class="string">'CData'</span>,out);
        drawnow;
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><img src="create_mask_demo_gui_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Interactive Mask demo
% Interactively create a polygon mask.
%
% This tutorial demonstrates how to make mask image (black and white).
% The program takes as input a source image and outputs its corresponding
% mask image.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.1.0/samples/cpp/create_mask.cpp>
%

function varargout = create_mask_demo_gui(im)
    % load an image
    if nargin < 1
        src = imread(fullfile(mexopencv.root(),'test','fruits.jpg'));
    elseif isempty(im)
        [im,cancel] = imgetfile();
        assert(~cancel, 'No file selected');
        src = imread(im);
    elseif ischar(im)
        src = cv.imread(im, 'Color',true);
    else
        src = im;
    end
    assert(size(src,3) == 3, 'Expecting a color source image');

    % shared data
    sz = size(src);
    out = [];        % output image
    pts = [];        % 2D points

    % create the UI
    h = buildGUI();
    onReset([],[]);
    if nargout > 0, varargout{1} = h; end


    function h = buildGUI()
        %BUILDGUI  Creates the UI

        h = struct();
        h.fig = figure('Name','Interactive Mask', 'Menubar','none', ...
            'Position',[200 200 sz(2) sz(1)]);
        if ~mexopencv.isOctave()
            %HACK: not implemented in Octave
            movegui(h.fig, 'center');
        end
        h.ax = axes('Parent',h.fig, 'Units','normalized', 'Position',[0 0 1 1]);
        if ~mexopencv.isOctave()
            h.img = imshow(src, 'Parent',h.ax);
        else
            %HACK: https://savannah.gnu.org/bugs/index.php?45473
            axes(h.ax);
            h.img = imshow(src);
        end
    end

    function onHelp(~,~)
        %ONHELP  Display usage help dialog

        hd = helpdlg({
            'Left-click the mouse to define the vertices of the polygon.'
            'Right-click when finished to close the polygon, connecting'
            'the last vertex with the first.'
            'Hot keys:'
            '  h: usage dialog'
            '  r: reset'
            '  s: save current output image as PNG image'
            '  p: save current points matrix as MAT-file'
            '  q: quit the program'
        }, 'Interactive mask demo');
        set(hd, 'WindowStyle','modal');
    end

    function onReset(~,~)
        %ONRESET  Restart from scratch

        % reset data
        pts = zeros(0,2);
        out = src;

        % register mouse button handlers and change cursor
        set(h.fig, 'Pointer','cross', 'WindowKeyPressFcn',@onType, ...
            'WindowButtonDownFcn',@onMouseDown, ...
            'WindowButtonUpFcn',@onMouseUp);

        % update plot
        set(h.img, 'CData',out);
        drawnow;
    end

    function onType(~,e)
        %ONTYPE  Event handler for key press on figure

        % handle keys
        switch e.Key
            case 'r'
                onReset([],[]);
            case 'h'
                onHelp([],[]);
            case 's'
                fname = [tempname() '.png'];
                imwrite(out, fname);
                fprintf('Output saved as "%s"\n', fname);
            case 'p'
                uisave({'pts'}, 'points.mat');
            case {'q', 'escape'}
                close(h.fig);
        end
    end

    function onMouseDown(~,~)
        %ONMOUSEDOWN  Event handler for mouse down on figure

        if strcmp(get(h.fig,'SelectionType'), 'normal')
            % get current location of mouse pointer
            pt = get(h.ax, 'CurrentPoint');
            pt = round(pt(1,1:2));

            % draw point
            out = cv.circle(out, pt, 2, ...
                'Color',[255 0 0], 'Thickness','Filled');

            % store point
            pts(end+1,:) = pt;

            % connect to previous point by a straight line
            if size(pts,1) >= 2
                out = cv.line(out, pts(end-1,:), pts(end,:), ...
                    'Color',[255 0 0], 'Thickness',2);
            end

            % update plot
            set(h.img, 'CData',out);
            drawnow;
        else
            % create a polygon from all vertices
            out = src;
            if ~isempty(pts)
                out = cv.polylines(out, pts, ...
                    'Closed',true, 'Color',[0 0 0], 'Thickness',2);
            end

            % update plot
            set(h.img, 'CData',out);
            drawnow;
        end
    end

    function onMouseUp(~,~)
        %ONMOUSEUP  Event handler for mouse up on figure

        % only respond to right mouse button up
        if strcmp(get(h.fig,'SelectionType'), 'normal'), return; end

        % unregister all mouse button handlers
        set(h.fig, 'Pointer','arrow', ...
            'WindowButtonDownFcn','', 'WindowButtonUpFcn','');

        % create binary mask from polygon
        mask = zeros(sz(1:2), 'uint8');
        if ~isempty(pts)
            mask = cv.fillPoly(mask, pts, 'Color',[255 255 255]);
        end
        cv.imwrite(fullfile(tempdir(), 'mask.png'), mask);
        disp(['Mask saved: ' fullfile(tempdir(), 'mask.png')]);

        % apply mask on image
        out = bsxfun(@times, uint8(mask~=0), src);

        % update plot
        set(h.img, 'CData',out);
        drawnow;
    end
end

##### SOURCE END #####
-->
   </body>
</html>