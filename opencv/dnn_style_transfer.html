<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>DNN: Style Transfer</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2018-02-20">
      <meta name="DC.source" content="dnn_style_transfer.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">DNN: Style Transfer</h1>
         <!--introduction-->
         <p>Maps the artistic style of various pieces of artwork onto input image.</p>
         <p>This demo is used to run <a href="https://github.com/jcjohnson/fast-neural-style">style transfer models</a> using OpenCV. It combines the content of one image with the style of another using convolutional neural networks.
         </p>
         <p>Pretrained models are available representing several styles:</p>
         <div>
            <ul>
               <li>The Muse, Pablo Picasso, 1935   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/la_muse.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/la_muse.jpg</a></li>
               <li>The Scream, Edvard Munch, 1893   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/the_scream.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/the_scream.jpg</a></li>
               <li>Udnie (Young American Girl, The Dance), Francis Picabia, 1913   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/udnie.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/udnie.jpg</a></li>
               <li>The Great Wave off Kanagawa, Hokusai, 1829-1832   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/wave.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/wave.jpg</a></li>
               <li>The Starry Night, Vincent Van Gogh, 1889   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/starry_night.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/starry_night.jpg</a></li>
               <li>Composition VII, Wassily Kandinsky, 1913   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/composition_vii.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/composition_vii.jpg</a></li>
               <li>Candy   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/candy.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/candy.jpg</a></li>
               <li>Mosaic   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/mosaic.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/mosaic.jpg</a></li>
               <li>Feathers   <a href="https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/feathers.jpg">https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/feathers.jpg</a></li>
            </ul>
         </div>
         <p>References:</p>
         <div>
            <ul>
               <li>"Perceptual Losses for Real-Time Style Transfer and Super-Resolution".   Justin Johnson, Alexandre Alahi, and Li Fei-Fei.
                  ECCV 2016.   <a href="https://cs.stanford.edu/people/jcjohns/eccv16/">https://cs.stanford.edu/people/jcjohns/eccv16/</a></li>
            </ul>
         </div>
         <div>
            <ul>
               <li>"Instance Normalization: The Missing Ingredient for Fast Stylization".   Dmitry Ulyanov, Andrea Vedaldi, and Victor Lempitsky.
                    <a href="https://arxiv.org/abs/1607.08022">https://arxiv.org/abs/1607.08022</a></li>
            </ul>
         </div>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fast_neural_style.py">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fast_neural_style.py</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <p>input image</p><pre class="codeinput">fname = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'lena.jpg'</span>);
img = cv.imread(fname, <span class="string">'Color'</span>,true, <span class="string">'FlipChannels'</span>,false);</pre><p>load network</p><pre class="codeinput">[net, blobOpts, ref] = StyleTransfer(<span class="string">'the_scream'</span>);
assert(~net.empty());</pre><p>feed image to network</p><pre class="codeinput">opts = parseBlobOpts(blobOpts{:});
blob = cv.Net.blobFromImages(img, blobOpts{:});
net.setInput(blob);</pre><p>run forward pass</p><pre class="codeinput">tic
out = net.forward();
toc</pre><pre class="codeoutput">Elapsed time is 0.816851 seconds.
</pre><p>recover output image</p><pre class="codeinput">out = imageFromBlob(out, opts);
out = flip(out, 3);  <span class="comment">% BGR to RGB</span>
<span class="keyword">if</span> false
    <span class="comment">% use a median filter as a post-processing step</span>
    out = cv.medianBlur(out, <span class="string">'KSize'</span>,3);
<span class="keyword">end</span></pre><p>show results</p><pre class="codeinput">figure(<span class="string">'Position'</span>,get(0, <span class="string">'DefaultFigurePosition'</span>).*[0.5 1 2 1])
subplot(131), imshow(flip(img, 3)), title(<span class="string">'input'</span>)
subplot(132), imshow(out), title(<span class="string">'output'</span>)
subplot(133), imshow(imread(ref)), title(<span class="string">'reference'</span>)</pre><img src="dnn_style_transfer_01.png"><p>Helper functions</p><pre class="codeinput"><span class="keyword">function</span> opts = parseBlobOpts(varargin)
    p = inputParser();
    p.addParameter(<span class="string">'ScaleFactor'</span>, 1.0);
    p.addParameter(<span class="string">'Size'</span>, [0 0]);   <span class="comment">% [w,h]</span>
    p.addParameter(<span class="string">'Mean'</span>, [0 0 0]); <span class="comment">% [r,g,b]</span>
    p.addParameter(<span class="string">'SwapRB'</span>, true);
    p.addParameter(<span class="string">'Crop'</span>, true);
    p.parse(varargin{:});
    opts = p.Results;
<span class="keyword">end</span>

<span class="keyword">function</span> img = imageFromBlob(blob, opts)
    img = permute(blob, [3 4 2 1]); <span class="comment">% NCHW -&gt; HWCN</span>
    img = img / opts.ScaleFactor;
    <span class="keyword">if</span> false &amp;&amp; opts.SwapRB
        opts.Mean([1 3]) = opts.Mean([3 1]);
    <span class="keyword">end</span>
    img = bsxfun(@plus, img, reshape(opts.Mean, 1, 1, []));
    img = uint8(round(img));
<span class="keyword">end</span></pre><p>Pretrained models</p><pre class="codeinput"><span class="keyword">function</span> dname = get_dnn_dir(dname)
    <span class="comment">%GET_DNN_DIR  Path to model files, and show where to get them if missing</span>

    dname = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'dnn'</span>, dname);
    b = isdir(dname);
    <span class="keyword">if</span> ~b
        <span class="comment">% display help of calling function</span>
        <span class="comment">% (assumed to be a local function in current file)</span>
        st = dbstack(1);
        help([mfilename() filemarker() st(1).name])
    <span class="keyword">end</span>
    assert(b, <span class="string">'Missing model: %s'</span>, dname);
<span class="keyword">end</span>

<span class="keyword">function</span> [net, blobOpts, fname] = StyleTransfer(style)
    <span class="comment">%STYLETRANSFER  Style Transfer models [Torch]</span>
    <span class="comment">%</span>
    <span class="comment">% homepage = https://github.com/jcjohnson/fast-neural-style</span>
    <span class="comment">%</span>
    <span class="comment">% # Models from the ECCV 2016 paper</span>
    <span class="comment">%</span>
    <span class="comment">% ## Model + Weights</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/eccv16/the_wave.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/the_wave.t7</span>
    <span class="comment">% hash = ae2235b7d380c346cd009418efa012453e35d089</span>
    <span class="comment">% size = 24.3 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/eccv16/starry_night.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/starry_night.t7</span>
    <span class="comment">% hash = 5b5e115253197b84d6c6ece1dafe6c15d7105ca6</span>
    <span class="comment">% size = 24.3 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/eccv16/la_muse.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/la_muse.t7</span>
    <span class="comment">% hash = 66a0b11a82d2b635105771ca7e7fb5b87692a51b</span>
    <span class="comment">% size = 24.3 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/eccv16/composition_vii.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/composition_vii.t7</span>
    <span class="comment">% hash = c3bc362a742d833c2691fb02fd7904bd73ed6632</span>
    <span class="comment">% size = 27.0 MB</span>
    <span class="comment">%</span>
    <span class="comment">% # Models with instance normalization</span>
    <span class="comment">% (smaller and faster models without sacrificing quality)</span>
    <span class="comment">%</span>
    <span class="comment">% ## Model + Weights</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/candy.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/candy.t7</span>
    <span class="comment">% hash = 64cf17abf37f4b3ac6773d8524dd3ba47a4ff5c2</span>
    <span class="comment">% size = 14.8 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/la_muse.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/la_muse.t7</span>
    <span class="comment">% hash = cab9697c54cbc652bd5069dc734a0200d2b88f03</span>
    <span class="comment">% size = 14.8 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/mosaic.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/mosaic.t7</span>
    <span class="comment">% hash = f4d3e2a5e3060b3c39a9648ad009de3e09cd0001</span>
    <span class="comment">% size = 17.5 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/feathers.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/feathers.t7</span>
    <span class="comment">% hash = 9838007df750d483b5b5e90b92d76e8ada5a31c0</span>
    <span class="comment">% size = 17.5 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/the_scream.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/the_scream.t7</span>
    <span class="comment">% hash = ae36b9289cab525657b97a4ea63609c338137da7</span>
    <span class="comment">% size = 17.5 MB</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/StyleTransfer/instance_norm/udnie.t7</span>
    <span class="comment">% url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/udnie.t7</span>
    <span class="comment">% hash = db237afe0c2a08c93bb77f63c40d0fea8191c631</span>
    <span class="comment">% size = 10.7 MB</span>
    <span class="comment">%</span>

    <span class="keyword">if</span> false
        dname = get_dnn_dir(fullfile(<span class="string">'StyleTransfer'</span>, <span class="string">'eccv16'</span>));
        style = validatestring(style, <span class="keyword">...</span>
            {<span class="string">'the_wave'</span>, <span class="string">'starry_night'</span>, <span class="string">'la_muse'</span>, <span class="string">'composition_vii'</span>});
    <span class="keyword">else</span>
        dname = get_dnn_dir(fullfile(<span class="string">'StyleTransfer'</span>, <span class="string">'instance_norm'</span>));
        style = validatestring(style, <span class="keyword">...</span>
            {<span class="string">'candy'</span>, <span class="string">'la_muse'</span>, <span class="string">'mosaic'</span>, <span class="string">'feathers'</span>, <span class="string">'the_scream'</span>, <span class="string">'udnie'</span>});
    <span class="keyword">end</span>

    <span class="comment">% load model</span>
    net = cv.Net(<span class="string">'Torch'</span>, fullfile(dname, [style <span class="string">'.t7'</span>]));
    blobOpts = {<span class="string">'SwapRB'</span>,false, <span class="string">'Mean'</span>,[103.939, 116.779, 123.68]};

    <span class="comment">% reference style image</span>
    im = [style <span class="string">'.jpg'</span>];
    <span class="keyword">if</span> strcmp(style, <span class="string">'the_wave'</span>), im = <span class="string">'wave.jpg'</span>; <span class="keyword">end</span>
    fname = fullfile(dname, im);
    <span class="keyword">if</span> exist(fname, <span class="string">'file'</span>) ~= 2
        disp(<span class="string">'Downloading style image...'</span>)
        url = <span class="string">'https://github.com/jcjohnson/fast-neural-style/raw/master/images/styles/'</span>;
        urlwrite([url im], fname);
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% DNN: Style Transfer
% Maps the artistic style of various pieces of artwork onto input image.
%
% This demo is used to run
% <https://github.com/jcjohnson/fast-neural-style style transfer models>
% using OpenCV. It combines the content of one image with the style of another
% using convolutional neural networks.
%
% Pretrained models are available representing several styles:
%
% * The Muse, Pablo Picasso, 1935
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/la_muse.jpg>
% * The Scream, Edvard Munch, 1893
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/the_scream.jpg>
% * Udnie (Young American Girl, The Dance), Francis Picabia, 1913
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/udnie.jpg>
% * The Great Wave off Kanagawa, Hokusai, 1829-1832
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/wave.jpg>
% * The Starry Night, Vincent Van Gogh, 1889
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/starry_night.jpg>
% * Composition VII, Wassily Kandinsky, 1913
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/composition_vii.jpg>
% * Candy
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/candy.jpg>
% * Mosaic
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/mosaic.jpg>
% * Feathers
%   <https://github.com/jcjohnson/fast-neural-style/blob/master/images/styles/feathers.jpg>
%
% References:
%
% * "Perceptual Losses for Real-Time Style Transfer and Super-Resolution".
%   Justin Johnson, Alexandre Alahi, and Li Fei-Fei. ECCV 2016.
%   <https://cs.stanford.edu/people/jcjohns/eccv16/>
%
% * "Instance Normalization: The Missing Ingredient for Fast Stylization".
%   Dmitry Ulyanov, Andrea Vedaldi, and Victor Lempitsky.
%   <https://arxiv.org/abs/1607.08022>
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fast_neural_style.py>
%

%%
% input image
fname = fullfile(mexopencv.root(), 'test', 'lena.jpg');
img = cv.imread(fname, 'Color',true, 'FlipChannels',false);

%%
% load network
[net, blobOpts, ref] = StyleTransfer('the_scream');
assert(~net.empty());

%%
% feed image to network
opts = parseBlobOpts(blobOpts{:});
blob = cv.Net.blobFromImages(img, blobOpts{:});
net.setInput(blob);

%%
% run forward pass
tic
out = net.forward();
toc

%%
% recover output image
out = imageFromBlob(out, opts);
out = flip(out, 3);  % BGR to RGB
if false
    % use a median filter as a post-processing step
    out = cv.medianBlur(out, 'KSize',3);
end

%%
% show results
figure('Position',get(0, 'DefaultFigurePosition').*[0.5 1 2 1])
subplot(131), imshow(flip(img, 3)), title('input')
subplot(132), imshow(out), title('output')
subplot(133), imshow(imread(ref)), title('reference')

%%
% Helper functions

function opts = parseBlobOpts(varargin)
    p = inputParser();
    p.addParameter('ScaleFactor', 1.0);
    p.addParameter('Size', [0 0]);   % [w,h]
    p.addParameter('Mean', [0 0 0]); % [r,g,b]
    p.addParameter('SwapRB', true);
    p.addParameter('Crop', true);
    p.parse(varargin{:});
    opts = p.Results;
end

function img = imageFromBlob(blob, opts)
    img = permute(blob, [3 4 2 1]); % NCHW -> HWCN
    img = img / opts.ScaleFactor;
    if false && opts.SwapRB
        opts.Mean([1 3]) = opts.Mean([3 1]);
    end
    img = bsxfun(@plus, img, reshape(opts.Mean, 1, 1, []));
    img = uint8(round(img));
end

%%
% Pretrained models

function dname = get_dnn_dir(dname)
    %GET_DNN_DIR  Path to model files, and show where to get them if missing

    dname = fullfile(mexopencv.root(), 'test', 'dnn', dname);
    b = isdir(dname);
    if ~b
        % display help of calling function
        % (assumed to be a local function in current file)
        st = dbstack(1);
        help([mfilename() filemarker() st(1).name])
    end
    assert(b, 'Missing model: %s', dname);
end

function [net, blobOpts, fname] = StyleTransfer(style)
    %STYLETRANSFER  Style Transfer models [Torch]
    %
    % homepage = https://github.com/jcjohnson/fast-neural-style
    %
    % # Models from the ECCV 2016 paper
    %
    % ## Model + Weights
    %
    % file = test/dnn/StyleTransfer/eccv16/the_wave.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/the_wave.t7
    % hash = ae2235b7d380c346cd009418efa012453e35d089
    % size = 24.3 MB
    %
    % file = test/dnn/StyleTransfer/eccv16/starry_night.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/starry_night.t7
    % hash = 5b5e115253197b84d6c6ece1dafe6c15d7105ca6
    % size = 24.3 MB
    %
    % file = test/dnn/StyleTransfer/eccv16/la_muse.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/la_muse.t7
    % hash = 66a0b11a82d2b635105771ca7e7fb5b87692a51b
    % size = 24.3 MB
    %
    % file = test/dnn/StyleTransfer/eccv16/composition_vii.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/composition_vii.t7
    % hash = c3bc362a742d833c2691fb02fd7904bd73ed6632
    % size = 27.0 MB
    %
    % # Models with instance normalization
    % (smaller and faster models without sacrificing quality)
    %
    % ## Model + Weights
    %
    % file = test/dnn/StyleTransfer/instance_norm/candy.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/candy.t7
    % hash = 64cf17abf37f4b3ac6773d8524dd3ba47a4ff5c2
    % size = 14.8 MB
    %
    % file = test/dnn/StyleTransfer/instance_norm/la_muse.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/la_muse.t7
    % hash = cab9697c54cbc652bd5069dc734a0200d2b88f03
    % size = 14.8 MB
    %
    % file = test/dnn/StyleTransfer/instance_norm/mosaic.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/mosaic.t7
    % hash = f4d3e2a5e3060b3c39a9648ad009de3e09cd0001
    % size = 17.5 MB
    %
    % file = test/dnn/StyleTransfer/instance_norm/feathers.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/feathers.t7
    % hash = 9838007df750d483b5b5e90b92d76e8ada5a31c0
    % size = 17.5 MB
    %
    % file = test/dnn/StyleTransfer/instance_norm/the_scream.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/the_scream.t7
    % hash = ae36b9289cab525657b97a4ea63609c338137da7
    % size = 17.5 MB
    %
    % file = test/dnn/StyleTransfer/instance_norm/udnie.t7
    % url  = https://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/udnie.t7
    % hash = db237afe0c2a08c93bb77f63c40d0fea8191c631
    % size = 10.7 MB
    %

    if false
        dname = get_dnn_dir(fullfile('StyleTransfer', 'eccv16'));
        style = validatestring(style, ...
            {'the_wave', 'starry_night', 'la_muse', 'composition_vii'});
    else
        dname = get_dnn_dir(fullfile('StyleTransfer', 'instance_norm'));
        style = validatestring(style, ...
            {'candy', 'la_muse', 'mosaic', 'feathers', 'the_scream', 'udnie'});
    end

    % load model
    net = cv.Net('Torch', fullfile(dname, [style '.t7']));
    blobOpts = {'SwapRB',false, 'Mean',[103.939, 116.779, 123.68]};

    % reference style image
    im = [style '.jpg'];
    if strcmp(style, 'the_wave'), im = 'wave.jpg'; end
    fname = fullfile(dname, im);
    if exist(fname, 'file') ~= 2
        disp('Downloading style image...')
        url = 'https://github.com/jcjohnson/fast-neural-style/raw/master/images/styles/';
        urlwrite([url im], fname);
    end
end

##### SOURCE END #####
-->
   </body>
</html>