<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Texture flow direction estimation</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="texture_flow_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Texture flow direction estimation</h1>
         <!--introduction-->
         <p>Sample shows how <tt>cv.cornerEigenValsAndVecs</tt> function can be used to estimate image texture flow direction.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/python/texture_flow.py">https://github.com/opencv/opencv/blob/3.2.0/samples/python/texture_flow.py</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <p>load image</p><pre class="codeinput">fname = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'starry_night.jpg'</span>);
<span class="keyword">if</span> exist(fname, <span class="string">'file'</span>) ~= 2
    disp(<span class="string">'Downloading image...'</span>)
    url = <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.2.0/samples/data/starry_night.jpg'</span>;
    urlwrite(url, fname);
<span class="keyword">end</span>
img = imread(fname);
imshow(img), title(<span class="string">'image'</span>)</pre><img src="texture_flow_demo_01.png"><p>convert to grayscale</p><pre class="codeinput">gray = cv.cvtColor(img, <span class="string">'RGB2GRAY'</span>);</pre><p>compute eigenvectors of the covariance matrix of derivatives</p><pre class="codeinput">eigen = cv.cornerEigenValsAndVecs(gray, <span class="string">'BlockSize'</span>,15, <span class="string">'KSize'</span>,3);
F = eigen(:,:,5:6);  <span class="comment">% flow = x2/y2 eigenvectors of lambda_2</span></pre><p>draw flow vectors on brightened image</p><pre class="codeinput">d = 12;
[X, Y] = meshgrid(d/2:d:size(img,2), d/2:d:size(img,1));
VX = F(Y(:,1), X(1,:), 1) * d;
VY = F(Y(:,1), X(1,:), 2) * d;
<span class="keyword">if</span> true
    vis = cv.convertTo(img, <span class="string">'Alpha'</span>,0.5, <span class="string">'Beta'</span>,192/2);
<span class="keyword">elseif</span> true
    vis = cv.convertScaleAbs(img, <span class="string">'Alpha'</span>,0.5, <span class="string">'Beta'</span>,192/2);
<span class="keyword">else</span>
    vis = cv.addWeighted(img,0.5, 192,0.5, 0);
<span class="keyword">end</span>
vis = cv.line(vis, [X(:) Y(:)] - [VX(:) VY(:)], <span class="keyword">...</span>
    [X(:) Y(:)] + [VX(:) VY(:)], <span class="string">'Color'</span>,[0 0 0], <span class="string">'LineType'</span>,<span class="string">'AA'</span>);
imshow(vis), title(<span class="string">'flow'</span>)</pre><img src="texture_flow_demo_02.png"><p>another way to visualize flow</p><pre class="codeinput">figure, imshow(img)
<span class="keyword">if</span> ~mexopencv.isOctave()
	alpha(0.5)
<span class="keyword">end</span>
hold <span class="string">on</span>, quiver(X, Y, VX, VY, <span class="string">'Color'</span>,<span class="string">'k'</span>), hold <span class="string">off</span>
title(<span class="string">'flow'</span>)</pre><img src="texture_flow_demo_03.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Texture flow direction estimation
%
% Sample shows how |cv.cornerEigenValsAndVecs| function can be used to
% estimate image texture flow direction.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/python/texture_flow.py>
%

%%
% load image
fname = fullfile(mexopencv.root(), 'test', 'starry_night.jpg');
if exist(fname, 'file') ~= 2
    disp('Downloading image...')
    url = 'https://cdn.rawgit.com/opencv/opencv/3.2.0/samples/data/starry_night.jpg';
    urlwrite(url, fname);
end
img = imread(fname);
imshow(img), title('image')

%%
% convert to grayscale
gray = cv.cvtColor(img, 'RGB2GRAY');

%%
% compute eigenvectors of the covariance matrix of derivatives
eigen = cv.cornerEigenValsAndVecs(gray, 'BlockSize',15, 'KSize',3);
F = eigen(:,:,5:6);  % flow = x2/y2 eigenvectors of lambda_2

%%
% draw flow vectors on brightened image
d = 12;
[X, Y] = meshgrid(d/2:d:size(img,2), d/2:d:size(img,1));
VX = F(Y(:,1), X(1,:), 1) * d;
VY = F(Y(:,1), X(1,:), 2) * d;
if true
    vis = cv.convertTo(img, 'Alpha',0.5, 'Beta',192/2);
elseif true
    vis = cv.convertScaleAbs(img, 'Alpha',0.5, 'Beta',192/2);
else
    vis = cv.addWeighted(img,0.5, 192,0.5, 0);
end
vis = cv.line(vis, [X(:) Y(:)] - [VX(:) VY(:)], ...
    [X(:) Y(:)] + [VX(:) VY(:)], 'Color',[0 0 0], 'LineType','AA');
imshow(vis), title('flow')

%%
% another way to visualize flow
figure, imshow(img)
if ~mexopencv.isOctave()
	alpha(0.5)
end
hold on, quiver(X, Y, VX, VY, 'Color','k'), hold off
title('flow')

##### SOURCE END #####
-->
   </body>
</html>