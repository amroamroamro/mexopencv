<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Detecting corners location in subpixeles</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="corner_subpixels_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Detecting corners location in subpixeles</h1>
         <p>Demo code for detecting corners using Shi-Tomasi method and refining corner locations.</p>
         <p>In this sample you will learn how to use the OpenCV functions:</p>
         <div>
            <ul>
               <li><a href="matlab:doc('cv.goodFeaturesToTrack')">cv.goodFeaturesToTrack</a> to detect   corners using the Shi-Tomasi method.
               </li>
               <li><a href="matlab:doc('cv.cornerSubPix')">cv.cornerSubPix</a> to find more exact corner   positions (more exact than integer pixels).
               </li>
            </ul>
         </div>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://docs.opencv.org/3.2.0/d8/dd8/tutorial_good_features_to_track.html">https://docs.opencv.org/3.2.0/d8/dd8/tutorial_good_features_to_track.html</a></li>
               <li><a href="https://docs.opencv.org/3.2.0/d8/d5e/tutorial_corner_subpixeles.html">https://docs.opencv.org/3.2.0/d8/d5e/tutorial_corner_subpixeles.html</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/goodFeaturesToTrack_Demo.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/goodFeaturesToTrack_Demo.cpp</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/cornerSubPix_Demo.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/cornerSubPix_Demo.cpp</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = corner_subpixels_demo_gui(im)
    <span class="comment">% load source image</span>
    <span class="keyword">if</span> nargin &lt; 1
        src = imread(fullfile(mexopencv.root(),<span class="string">'test'</span>,<span class="string">'blox.jpg'</span>));
    <span class="keyword">elseif</span> ischar(im)
        src = imread(im);
    <span class="keyword">else</span>
        src = im;
    <span class="keyword">end</span>

    <span class="comment">% create the UI</span>
    h = buildGUI(src);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onChange(~,~,h)
    <span class="comment">%ONCHANGE  Event handler for UI controls</span>

    <span class="comment">% retrieve current values from UI controls</span>
    maxCorners = round(get(h.slid, <span class="string">'Value'</span>));
    <span class="comment">% maxCorners=0 means all corners found are kept</span>
    <span class="comment">%if maxCorners == 0, maxCorners = 500; end</span>
    set(h.txt, <span class="string">'String'</span>,sprintf(<span class="string">'Max Corners: %2d'</span>,maxCorners));

    <span class="comment">% apply Shi-Tomasi corner detector</span>
    corners = cv.goodFeaturesToTrack(h.srcgray, <span class="string">'MaxCorners'</span>,maxCorners, <span class="keyword">...</span>
        <span class="string">'QualityLevel'</span>,0.01, <span class="string">'MinDistance'</span>,10, <span class="keyword">...</span>
        <span class="string">'BlockSize'</span>,3, <span class="string">'UseHarrisDetector'</span>,false, <span class="string">'K'</span>,0.04);
    fprintf(<span class="string">'Number of corners detected: %d\n'</span>, numel(corners));

    <span class="comment">% draw corners detected</span>
    out = h.src;
    <span class="keyword">for</span> i=1:numel(corners)
        out = cv.circle(out, corners{i}, 5, <span class="string">'Color'</span>,[255 0 0], <span class="string">'Thickness'</span>,2);
    <span class="keyword">end</span>

    <span class="comment">% show result</span>
    set(h.img, <span class="string">'CData'</span>,out);
    drawnow;

    <span class="comment">% calculate the refined corner locations</span>
    corners2 = cv.cornerSubPix(h.srcgray, corners, <span class="string">'WinSize'</span>,[5 5], <span class="keyword">...</span>
        <span class="string">'Criteria'</span>,struct(<span class="string">'type'</span>,<span class="string">'Count+EPS'</span>, <span class="string">'maxCount'</span>,40, <span class="string">'epsilon'</span>,0.001));
    <span class="keyword">for</span> i=1:numel(corners)
        fprintf(<span class="string">' -- Refined Corner [%2d] (%3d,%3d) -&gt; (%6.2f,%6.2f)\n'</span>, <span class="keyword">...</span>
            i, corners{i}, corners2{i});
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI(img)
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% parameters</span>
    maxCorners = 10;
    max_maxCorners = 50;
    sz = size(img);
    sz(2) = max(sz(2), 300);  <span class="comment">% minimum figure width</span>

    <span class="comment">% build the user interface (no resizing to keep it simple)</span>
    h = struct();
    h.src = img;
    <span class="keyword">if</span> size(img,3) &gt; 1
        h.srcgray = cv.cvtColor(img, <span class="string">'RGB2GRAY'</span>);
    <span class="keyword">else</span>
        h.srcgray = img;
    <span class="keyword">end</span>
    h.fig = figure(<span class="string">'Name'</span>,<span class="string">'Image Corners Demo'</span>, <span class="keyword">...</span>
        <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[200 200 sz(2) sz(1)+29]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: not implemented in Octave</span>
        movegui(h.fig, <span class="string">'center'</span>);
    <span class="keyword">end</span>
    h.ax = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="string">'Position'</span>,[1 30 sz(2) sz(1)]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        h.img = imshow(img, <span class="string">'Parent'</span>,h.ax);
    <span class="keyword">else</span>
        <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
        axes(h.ax);
        h.img = imshow(img);
    <span class="keyword">end</span>
    h.txt = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="string">'FontSize'</span>,11, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[5 5 130 20], <span class="string">'String'</span>,sprintf(<span class="string">'Max Corners: %2d'</span>,maxCorners));
    h.slid = uicontrol(<span class="string">'Parent'</span>,h.fig, <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="string">'Value'</span>,maxCorners, <span class="keyword">...</span>
        <span class="string">'Min'</span>,0, <span class="string">'Max'</span>,max_maxCorners, <span class="string">'SliderStep'</span>,[1 10]./(max_maxCorners-0), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[135 5 sz(2)-135-5 20]);

    <span class="comment">% hook event handlers, and trigger default start</span>
    set(h.slid, <span class="string">'Callback'</span>,{@onChange,h}, <span class="keyword">...</span>
        <span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>);
    onChange([],[],h);
<span class="keyword">end</span></pre><pre class="codeoutput">Number of corners detected: 10
 -- Refined Corner [ 1] (138,162) -&gt; (136.15,161.56)
 -- Refined Corner [ 2] (230, 98) -&gt; (230.77, 96.75)
 -- Refined Corner [ 3] (135,184) -&gt; (135.42,182.43)
 -- Refined Corner [ 4] ( 47,165) -&gt; ( 48.30,163.26)
 -- Refined Corner [ 5] (168,159) -&gt; (169.76,158.30)
 -- Refined Corner [ 6] ( 26,105) -&gt; ( 24.52,103.50)
 -- Refined Corner [ 7] (238,203) -&gt; (239.23,201.65)
 -- Refined Corner [ 8] ( 85,146) -&gt; ( 85.07,147.57)
 -- Refined Corner [ 9] ( 61,229) -&gt; ( 63.54,228.51)
 -- Refined Corner [10] (169,182) -&gt; (169.13,181.32)
</pre><img src="corner_subpixels_demo_gui_01.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Detecting corners location in subpixeles
% Demo code for detecting corners using Shi-Tomasi method and refining corner
% locations.
%
% In this sample you will learn how to use the OpenCV functions:
%
% * <matlab:doc('cv.goodFeaturesToTrack') cv.goodFeaturesToTrack> to detect
%   corners using the Shi-Tomasi method.
% * <matlab:doc('cv.cornerSubPix') cv.cornerSubPix> to find more exact corner
%   positions (more exact than integer pixels).
%
% Sources:
%
% * <https://docs.opencv.org/3.2.0/d8/dd8/tutorial_good_features_to_track.html>
% * <https://docs.opencv.org/3.2.0/d8/d5e/tutorial_corner_subpixeles.html>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/goodFeaturesToTrack_Demo.cpp>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/TrackingMotion/cornerSubPix_Demo.cpp>
%

function varargout = corner_subpixels_demo_gui(im)
    % load source image
    if nargin < 1
        src = imread(fullfile(mexopencv.root(),'test','blox.jpg'));
    elseif ischar(im)
        src = imread(im);
    else
        src = im;
    end

    % create the UI
    h = buildGUI(src);
    if nargout > 0, varargout{1} = h; end
end

function onChange(~,~,h)
    %ONCHANGE  Event handler for UI controls

    % retrieve current values from UI controls
    maxCorners = round(get(h.slid, 'Value'));
    % maxCorners=0 means all corners found are kept
    %if maxCorners == 0, maxCorners = 500; end
    set(h.txt, 'String',sprintf('Max Corners: %2d',maxCorners));

    % apply Shi-Tomasi corner detector
    corners = cv.goodFeaturesToTrack(h.srcgray, 'MaxCorners',maxCorners, ...
        'QualityLevel',0.01, 'MinDistance',10, ...
        'BlockSize',3, 'UseHarrisDetector',false, 'K',0.04);
    fprintf('Number of corners detected: %d\n', numel(corners));

    % draw corners detected
    out = h.src;
    for i=1:numel(corners)
        out = cv.circle(out, corners{i}, 5, 'Color',[255 0 0], 'Thickness',2);
    end

    % show result
    set(h.img, 'CData',out);
    drawnow;

    % calculate the refined corner locations
    corners2 = cv.cornerSubPix(h.srcgray, corners, 'WinSize',[5 5], ...
        'Criteria',struct('type','Count+EPS', 'maxCount',40, 'epsilon',0.001));
    for i=1:numel(corners)
        fprintf(' REPLACE_WITH_DASH_DASH Refined Corner [%2d] (%3d,%3d) -> (%6.2f,%6.2f)\n', ...
            i, corners{i}, corners2{i});
    end
end

function h = buildGUI(img)
    %BUILDGUI  Creates the UI

    % parameters
    maxCorners = 10;
    max_maxCorners = 50;
    sz = size(img);
    sz(2) = max(sz(2), 300);  % minimum figure width

    % build the user interface (no resizing to keep it simple)
    h = struct();
    h.src = img;
    if size(img,3) > 1
        h.srcgray = cv.cvtColor(img, 'RGB2GRAY');
    else
        h.srcgray = img;
    end
    h.fig = figure('Name','Image Corners Demo', ...
        'NumberTitle','off', 'Menubar','none', 'Resize','off', ...
        'Position',[200 200 sz(2) sz(1)+29]);
    if ~mexopencv.isOctave()
        %HACK: not implemented in Octave
        movegui(h.fig, 'center');
    end
    h.ax = axes('Parent',h.fig, 'Units','pixels', 'Position',[1 30 sz(2) sz(1)]);
    if ~mexopencv.isOctave()
        h.img = imshow(img, 'Parent',h.ax);
    else
        %HACK: https://savannah.gnu.org/bugs/index.php?45473
        axes(h.ax);
        h.img = imshow(img);
    end
    h.txt = uicontrol('Parent',h.fig, 'Style','text', 'FontSize',11, ...
        'Position',[5 5 130 20], 'String',sprintf('Max Corners: %2d',maxCorners));
    h.slid = uicontrol('Parent',h.fig, 'Style','slider', 'Value',maxCorners, ...
        'Min',0, 'Max',max_maxCorners, 'SliderStep',[1 10]./(max_maxCorners-0), ...
        'Position',[135 5 sz(2)-135-5 20]);

    % hook event handlers, and trigger default start
    set(h.slid, 'Callback',{@onChange,h}, ...
        'Interruptible','off', 'BusyAction','cancel');
    onChange([],[],h);
end

##### SOURCE END #####
-->
   </body>
</html>