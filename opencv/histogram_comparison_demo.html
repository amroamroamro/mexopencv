<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Histogram Comparison</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="histogram_comparison_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Histogram Comparison</h1>
         <!--introduction-->
         <p>In this demo, we show how to:</p>
         <div>
            <ul>
               <li>Use the function <tt>cv.compareHist</tt> to get a numerical parameter that   express how well two histograms match with each other
               </li>
               <li>Use different metrics to compare histograms</li>
            </ul>
         </div>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://docs.opencv.org/3.2.0/d8/dc8/tutorial_histogram_comparison.html">https://docs.opencv.org/3.2.0/d8/dc8/tutorial_histogram_comparison.html</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/Histograms_Matching/compareHist_Demo.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/Histograms_Matching/compareHist_Demo.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#2">Theory</a></li>
               <li><a href="#3">Code</a></li>
            </ul>
         </div>
         <h2 id="2">Theory</h2>
         <p>To compare two histograms (<img src="histogram_comparison_demo_eq00967655477663270137.png" alt="$H_{1}$" class="equation" width="16" height="12"> and <img src="histogram_comparison_demo_eq06736791705432295443.png" alt="$H_{2}$" class="equation" width="17" height="12">), first we have to choose a <i>metric</i> (<img src="histogram_comparison_demo_eq03372033720239165822.png" alt="$d(H_{1}, H_{2})$" class="equation" width="60" height="15">) to express how well both histograms match.
         </p>
         <p>OpenCV implements the function <tt>cv.compareHist</tt> to perform a comparison. It also offers 4 different metrics to compute the matching:
         </p>
         <div>
            <ul>
               <li><b>Correlation</b>:
               </li>
            </ul>
         </div>
         <p><img src="histogram_comparison_demo_eq10201049251035495005.png" alt="$$d(H_1,H_2) =  \frac{\sum_I (H_1(I) - \bar{H_1}) (H_2(I) - \bar{H_2})}&#xA;                     {\sqrt{\sum_I(H_1(I) - \bar{H_1})^2&#xA;                            \sum_I(H_2(I) - \bar{H_2})^2}}$$" class="equation" width="324" height="40"></p>
         <p>where</p>
         <p><img src="histogram_comparison_demo_eq05550427514564648721.png" alt="$$\bar{H_k} =  \frac{1}{N} \sum _J H_k(J)$$" class="equation" width="119" height="38"></p>
         <p>and <img src="histogram_comparison_demo_eq03672095713503266041.png" alt="$N$" class="equation" width="13" height="10"> is the total number of histogram bins.
         </p>
         <div>
            <ul>
               <li><b>Chi-Square</b>:
               </li>
            </ul>
         </div>
         <p><img src="histogram_comparison_demo_eq15529027717241519978.png" alt="$$d(H_1,H_2) =  \sum _I  \frac{\left(H_1(I)-H_2(I)\right)^2}{H_1(I)}$$" class="equation" width="216" height="42"></p>
         <div>
            <ul>
               <li><b>Intersection</b>:
               </li>
            </ul>
         </div>
         <p><img src="histogram_comparison_demo_eq07784028747000587772.png" alt="$$d(H_1,H_2) =  \sum _I  \min (H_1(I), H_2(I))$$" class="equation" width="220" height="31"></p>
         <div>
            <ul>
               <li><b>Bhattacharyya</b>:
               </li>
            </ul>
         </div>
         <p><img src="histogram_comparison_demo_eq15536739003678654772.png" alt="$$d(H_1,H_2) =  \sqrt{1 - \frac{1}{\sqrt{\bar{H_1} \bar{H_2} N^2}}&#xA;                          \sum_I \sqrt{H_1(I) \cdot H_2(I)}}$$" class="equation" width="320" height="44"></p>
         <h2 id="3">Code</h2>
         <p>This program:</p>
         <div>
            <ul>
               <li>Loads a <i>base image</i> and 2 <i>test images</i> to be compared with it.
               </li>
               <li>Generate 1 image that is the lower half of the <i>base image</i></li>
               <li>Convert the images to HSV format</li>
               <li>Calculate the H-S histogram for all the images and normalize them in order   to compare them.</li>
               <li>Compare the histogram of the <i>base image</i> with respect to the 2 test   histograms, the histogram of the lower half base image and with the same   base image histogram.
               </li>
               <li>Display the numerical matching parameters obtained.</li>
            </ul>
         </div>
         <p>Load source images (base image and the two other images to compare)</p><pre class="codeinput">im = {
    <span class="string">'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_0.jpg'</span>
    <span class="string">'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_1.jpg'</span>
    <span class="string">'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_2.jpg'</span>
};
src = cell(3,1);
<span class="keyword">for</span> i=1:3
    [~,name,ext] = fileparts(im{i});
    fname = fullfile(mexopencv.root(), <span class="string">'test'</span>, [name ext]);
    <span class="keyword">if</span> exist(fname, <span class="string">'file'</span>) ~= 2
        disp(<span class="string">'Downloading image...'</span>)
        urlwrite(im{i}, fname);
    <span class="keyword">end</span>
    src{i} = cv.imread(fname, <span class="string">'Color'</span>,true);
<span class="keyword">end</span></pre><p>also create an image of half the base image</p><pre class="codeinput">src{4} = src{1}(end/2:end,:,:);
src = src([1 4 2 3]);</pre><p>show images</p><pre class="codeinput">names = {<span class="string">'Base'</span>, <span class="string">'Half'</span>, <span class="string">'Test1'</span>, <span class="string">'Test2'</span>};
<span class="keyword">for</span> i=1:numel(src)
    subplot(2,2,i), imshow(src{i}), title(names{i})
<span class="keyword">end</span></pre><img src="histogram_comparison_demo_01.png"><p>convert images to HSV color space</p><pre class="codeinput">hsv = cell(size(src));
<span class="keyword">for</span> i=1:numel(src)
    hsv{i} = cv.cvtColor(src{i}, <span class="string">'RGB2HSV'</span>);
<span class="keyword">end</span></pre><p>calculate H-S 2D histograms</p><pre class="codeinput"><span class="comment">%ranges = {linspace(0,180,50+1), linspace(0,256,60+1)};</span>
ranges = {[0 180], [0 256]};
hsizes = [50, 60];
histo = cell(size(hsv));
<span class="keyword">for</span> i=1:numel(hsv)
    histo{i} = cv.calcHist(hsv{i}(:,:,1:2), ranges, <span class="string">'HistSize'</span>,hsizes, <span class="string">'Uniform'</span>,true);
    histo{i} = cv.normalize(histo{i}, <span class="string">'NormType'</span>,<span class="string">'MinMax'</span>, <span class="string">'Alpha'</span>,0, <span class="string">'Beta'</span>,1);
<span class="keyword">end</span></pre><p>compare histogram of the base image against the other histograms using four different metrics</p><pre class="codeinput">algs = {<span class="string">'Correlation'</span>, <span class="string">'ChiSquare'</span>, <span class="string">'Intersection'</span>, <span class="string">'Bhattacharyya'</span>};
D = zeros(numel(algs),numel(histo));
<span class="keyword">for</span> j=1:numel(histo)
    <span class="keyword">for</span> i=1:numel(algs)
        D(i,j) = cv.compareHist(histo{1}, histo{j}, <span class="string">'Method'</span>,algs{i});
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><p>The first image is the base (to be compared to the others), the other 2 are the test images. We also compare the first image
            with respect to itself and with respect of half the base image.
         </p>
         <p>We should expect a perfect match when we compare the base image histogram with itself. Also, compared with the histogram of
            half the base image, it should present a high match since both are from the same source. For the other two test images, we
            can observe that they have very different lighting conditions, so the matching should not be very good.
         </p>
         <p>Here are the numeric results</p><pre class="codeinput"><span class="keyword">if</span> ~mexopencv.isOctave()
    t = array2table(D, <span class="string">'VariableNames'</span>,names, <span class="string">'RowNames'</span>,algs);
    disp(t);
<span class="keyword">else</span>
    <span class="comment">%HACK: use cell array instead of table</span>
    t = [{<span class="string">''</span>}, names; algs(:), arrayfun(@num2str,D,<span class="string">'Uniform'</span>,false)];
    t = t';
    fprintf(<span class="string">'%13s %9s %9s %9s %9s\n'</span>,t{:});
<span class="keyword">end</span></pre><pre class="codeoutput">                      Base      Half       Test1      Test2  
                     ______    _______    _______    ________
    Correlation           1    0.88752      0.211    0.075794
    ChiSquare             0     4.5964     1360.7      4684.5
    Intersection     18.692     13.001      5.682      2.7757
    Bhattacharyya         0    0.24179    0.66792     0.86341
</pre><p>For the <i>Correlation</i> and <i>Intersection</i> methods, the higher the metric, the more accurate the match. As we can see, the match <i>base-base</i> is the highest of all as expected. Also we can observe that the match <i>base-half</i> is the second best match (as we predicted). For the other two metrics, the less the result, the better the match. We can
            observe that the matches between the test 1 and test 2 with respect to the base are worse, which again, was expected.
         </p>
         <div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div><script type="text/x-mathjax-config">
  // https://stackoverflow.com/a/14631703/97160
  MathJax.Extension.myImg2jax = {
    version: "1.0",
    PreProcess: function (element) {
      var images = element.getElementsByTagName("img");
      for (var i = images.length - 1; i >= 0; i--) {
        var img = images[i];
        if (img.className === "equation") {
          var match = img.alt.match(/^(\$\$?)([\s\S]*)\1$/m);
          if (!match) continue;
          var script = document.createElement("script");
          script.type = "math/tex";
          if (match[1] === "$$") {script.type += ";mode=display"}
          MathJax.HTML.setScript(script, match[2]);
          img.parentNode.replaceChild(script, img);
        }
      }
    }
  };
  MathJax.Hub.Register.PreProcessor(["PreProcess", MathJax.Extension.myImg2jax]);
  </script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML"></script>
      <!--
##### SOURCE BEGIN #####
%% Histogram Comparison
%
% In this demo, we show how to:
%
% * Use the function |cv.compareHist| to get a numerical parameter that
%   express how well two histograms match with each other
% * Use different metrics to compare histograms
%
% Sources:
%
% * <https://docs.opencv.org/3.2.0/d8/dc8/tutorial_histogram_comparison.html>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/tutorial_code/Histograms_Matching/compareHist_Demo.cpp>
%

%% Theory
%
% To compare two histograms ($H_{1}$ and $H_{2}$), first we have to choose a
% _metric_ ($d(H_{1}, H_{2})$) to express how well both histograms match.
%
% OpenCV implements the function |cv.compareHist| to perform a comparison. It
% also offers 4 different metrics to compute the matching:
%
% * *Correlation*:
%
% $$d(H_1,H_2) =  \frac{\sum_I (H_1(I) - \bar{H_1}) (H_2(I) - \bar{H_2})}
%                      {\sqrt{\sum_I(H_1(I) - \bar{H_1})^2
%                             \sum_I(H_2(I) - \bar{H_2})^2}}$$
%
% where
%
% $$\bar{H_k} =  \frac{1}{N} \sum _J H_k(J)$$
%
% and $N$ is the total number of histogram bins.
%
% * *Chi-Square*:
%
% $$d(H_1,H_2) =  \sum _I  \frac{\left(H_1(I)-H_2(I)\right)^2}{H_1(I)}$$
%
% * *Intersection*:
%
% $$d(H_1,H_2) =  \sum _I  \min (H_1(I), H_2(I))$$
%
% * *Bhattacharyya*:
%
% $$d(H_1,H_2) =  \sqrt{1 - \frac{1}{\sqrt{\bar{H_1} \bar{H_2} N^2}}
%                           \sum_I \sqrt{H_1(I) \cdot H_2(I)}}$$
%

%% Code
%
% This program:
%
% * Loads a _base image_ and 2 _test images_ to be compared with it.
% * Generate 1 image that is the lower half of the _base image_
% * Convert the images to HSV format
% * Calculate the H-S histogram for all the images and normalize them in order
%   to compare them.
% * Compare the histogram of the _base image_ with respect to the 2 test
%   histograms, the histogram of the lower half base image and with the same
%   base image histogram.
% * Display the numerical matching parameters obtained.
%

%%
% Load source images (base image and the two other images to compare)
im = {
    'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_0.jpg'
    'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_1.jpg'
    'https://docs.opencv.org/3.3.1/Histogram_Comparison_Source_2.jpg'
};
src = cell(3,1);
for i=1:3
    [~,name,ext] = fileparts(im{i});
    fname = fullfile(mexopencv.root(), 'test', [name ext]);
    if exist(fname, 'file') ~= 2
        disp('Downloading image...')
        urlwrite(im{i}, fname);
    end
    src{i} = cv.imread(fname, 'Color',true);
end

%%
% also create an image of half the base image
src{4} = src{1}(end/2:end,:,:);
src = src([1 4 2 3]);

%%
% show images
names = {'Base', 'Half', 'Test1', 'Test2'};
for i=1:numel(src)
    subplot(2,2,i), imshow(src{i}), title(names{i})
end

%%
% convert images to HSV color space
hsv = cell(size(src));
for i=1:numel(src)
    hsv{i} = cv.cvtColor(src{i}, 'RGB2HSV');
end

%%
% calculate H-S 2D histograms
%ranges = {linspace(0,180,50+1), linspace(0,256,60+1)};
ranges = {[0 180], [0 256]};
hsizes = [50, 60];
histo = cell(size(hsv));
for i=1:numel(hsv)
    histo{i} = cv.calcHist(hsv{i}(:,:,1:2), ranges, 'HistSize',hsizes, 'Uniform',true);
    histo{i} = cv.normalize(histo{i}, 'NormType','MinMax', 'Alpha',0, 'Beta',1);
end

%%
% compare histogram of the base image against the other histograms
% using four different metrics
algs = {'Correlation', 'ChiSquare', 'Intersection', 'Bhattacharyya'};
D = zeros(numel(algs),numel(histo));
for j=1:numel(histo)
    for i=1:numel(algs)
        D(i,j) = cv.compareHist(histo{1}, histo{j}, 'Method',algs{i});
    end
end

%%
% The first image is the base (to be compared to the others), the other 2 are
% the test images. We also compare the first image with respect to itself and
% with respect of half the base image.
%
% We should expect a perfect match when we compare the base image histogram
% with itself. Also, compared with the histogram of half the base image, it
% should present a high match since both are from the same source. For the
% other two test images, we can observe that they have very different lighting
% conditions, so the matching should not be very good.
%

%%
% Here are the numeric results
if ~mexopencv.isOctave()
    t = array2table(D, 'VariableNames',names, 'RowNames',algs);
    disp(t);
else
    %HACK: use cell array instead of table
    t = [{''}, names; algs(:), arrayfun(@num2str,D,'Uniform',false)];
    t = t';
    fprintf('%13s %9s %9s %9s %9s\n',t{:});
end

%%
% For the _Correlation_ and _Intersection_ methods, the higher the metric, the
% more accurate the match. As we can see, the match _base-base_ is the highest
% of all as expected. Also we can observe that the match _base-half_ is the
% second best match (as we predicted). For the other two metrics, the less the
% result, the better the match. We can observe that the matches between the
% test 1 and test 2 with respect to the base are worse, which again, was
% expected.
%

##### SOURCE END #####
--></body>
</html>