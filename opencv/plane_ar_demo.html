<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>plane_ar_demo</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="plane_ar_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Planar augmented reality</a></li>
               <li><a href="#2">Helper function</a></li>
            </ul>
         </div>
         <h2 id="1">Planar augmented reality</h2>
         <p>This sample shows an example of augmented reality overlay over a tracked planar object. The function <tt>cv.solvePnP</tt> is used to estimate the tracked object location in 3D space.
         </p>
         <p>Select a textured planar object to track by drawing a box with the mouse. It uses the <tt>RectSelector</tt> and <tt>PlaneTracker</tt> classes.
         </p>
         <p>Sample video: <a href="http://www.youtube.com/watch?v=pzVbhxx6aog">http://www.youtube.com/watch?v=pzVbhxx6aog</a>.
         </p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.3.1/samples/python/plane_ar.py">https://github.com/opencv/opencv/blob/3.3.1/samples/python/plane_ar.py</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> plane_ar_demo(vid)
    <span class="comment">% video file, and a default target to track [x,y,w,h]</span>
    win = [];
    <span class="keyword">if</span> nargin &lt; 1
        vid = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'blais.mp4'</span>);
        assert(exist(vid, <span class="string">'file'</span>) == 2, <span class="string">'Missing video file'</span>);
        <span class="keyword">if</span> true
            win = [135 165 285 175];  <span class="comment">% face</span>
        <span class="keyword">else</span>
            win = [136 0 366 433];    <span class="comment">% book</span>
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> isempty(vid)
        vid = 0;
    <span class="keyword">end</span>

    <span class="comment">% open video feed, and get first frame</span>
    cap = cv.VideoCapture(vid);
    pause(1);
    assert(cap.isOpened(), <span class="string">'Failed to open video'</span>);
    frame = cap.read();
    assert(~isempty(frame), <span class="string">'Failed to read frames'</span>);

    <span class="comment">% prepare plot</span>
    paused = false;
    hImg = imshow(frame);

    <span class="comment">% create and initialize tracker</span>
    tracker = PlaneTracker();
    <span class="keyword">if</span> ~isempty(win)
        tracker.addTarget(frame, win);
    <span class="keyword">end</span>

    <span class="comment">% create ROI region selector</span>
    <span class="keyword">if</span> ~mexopencv.isOctave()
        onHelp();
        roi = RectSelector(hImg);
        roi.callback = @onRect;
    <span class="keyword">else</span>
        <span class="comment">%HACK: RectSelector not Octave compatible</span>
        <span class="comment">%HACK: function handle to nested function not supported in Octave</span>
        roi = struct(<span class="string">'isDragging'</span>,@()false);
    <span class="keyword">end</span>

    <span class="comment">% listen to keyboard input</span>
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: function handle to nested function not supported in Octave</span>
        set(ancestor(hImg,<span class="string">'figure'</span>), <span class="string">'WindowKeyPressFcn'</span>,@onType);
    <span class="keyword">end</span>

    <span class="comment">% main loop</span>
    <span class="keyword">while</span> ishghandle(hImg)
        playing = ~paused &amp;&amp; ~roi.isDragging();
        <span class="keyword">if</span> playing
            <span class="comment">% read new frame</span>
            frame = cap.read();
            <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>
        <span class="keyword">end</span>
        out = frame;

        <span class="comment">% track and draw keypoints, boundary, and pose of targets</span>
        <span class="keyword">if</span> playing
            tracked = tracker.track(frame);
            <span class="keyword">for</span> i=1:numel(tracked)
                tr = tracked(i);
                out = cv.circle(out, tr.pt1, 2, <span class="string">'Color'</span>,[0 0 255]);
                out = cv.polylines(out, tr.quad, <span class="string">'Closed'</span>,true, <span class="keyword">...</span>
                    <span class="string">'Color'</span>,[0 0 255], <span class="string">'Thickness'</span>,2);
                out = drawOverlay(out, tr);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">% display result</span>
        set(hImg, <span class="string">'CData'</span>,out);
        <span class="keyword">if</span> playing
            drawnow;
        <span class="keyword">else</span>
            pause(0.1);  <span class="comment">% slow down a bit if paused</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    cap.release();
    <span class="keyword">if</span> isobject(roi), delete(roi); <span class="keyword">end</span>

    <span class="comment">% --- Callback functions ---</span>

    <span class="keyword">function</span> onRect(rect)
        <span class="comment">%ONRECT  Callback for ROI selector</span>
        <span class="comment">%</span>
        <span class="comment">%     onRect(rect)</span>
        <span class="comment">%</span>
        <span class="comment">% ## Input</span>
        <span class="comment">% * __rect__ selected rectangle [x,y,w,h], or empty</span>
        <span class="comment">%</span>

        <span class="keyword">if</span> isempty(rect), <span class="keyword">return</span>; <span class="keyword">end</span>

        <span class="comment">% track new target</span>
        disp(<span class="string">'Adding target...'</span>)
        tracker.addTarget(frame, rect);

        <span class="comment">% un-pause</span>
        paused = false;
    <span class="keyword">end</span>

    <span class="keyword">function</span> onType(hfig, e)
        <span class="comment">%ONTYPE  Event handler for key press on figure</span>

        <span class="keyword">switch</span> e.Key
            <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
                close(hfig);

            <span class="keyword">case</span> <span class="string">'h'</span>
                onHelp();

            <span class="keyword">case</span> {<span class="string">'space'</span>, <span class="string">'p'</span>}
                disp(<span class="string">'Toggle pause...'</span>);
                paused = ~paused;

            <span class="keyword">case</span> {<span class="string">'c'</span>, <span class="string">'r'</span>}
                disp(<span class="string">'Clearing tracker...'</span>);
                tracker.clear();
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onHelp()
        <span class="comment">%ONHELP  Display usage help dialog</span>

        h = helpdlg({
            <span class="string">'Select object(s) to track using the mouse.'</span>
            <span class="string">'Hot keys:'</span>
            <span class="string">'  q - quit'</span>
            <span class="string">'  h - help'</span>
            <span class="string">'  p - pause'</span>
            <span class="string">'  c - clear targets'</span>
        });

        <span class="comment">% wait for user to accept dialog</span>
        set(h, <span class="string">'WindowStyle'</span>,<span class="string">'modal'</span>);
        waitfor(h);
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><img src="plane_ar_demo_01.png"><h2 id="2">Helper function</h2><pre class="codeinput"><span class="keyword">function</span> img = drawOverlay(img, tr)
    <span class="comment">%DRAWOVERLAY  Draw a 3D house on top of tracked object to show its pose</span>
    <span class="comment">%</span>
    <span class="comment">%     img = drawOverlay(img, tr)</span>
    <span class="comment">%</span>
    <span class="comment">% ## Input</span>
    <span class="comment">% * __img__ image on which to draw</span>
    <span class="comment">% * __tr__ tracked target structure</span>
    <span class="comment">%</span>
    <span class="comment">% ## Output</span>
    <span class="comment">% * __img__ output image</span>
    <span class="comment">%</span>

    <span class="keyword">if</span> true
        <span class="comment">% simple model of a house (cube with a triangular prism roof)</span>
        ar_vertices = [
            0 0 0; 0 1 0; 1 1 0; 1 0 0; <span class="keyword">...</span>
            0 0 1; 0 1 1; 1 1 1; 1 0 1; <span class="keyword">...</span>
            0 0.5 2; 1 0.5 2
        ];
        ar_edges = [
            0 1; 1 2; 2 3; 3 0; <span class="keyword">...</span>
            4 5; 5 6; 6 7; 7 4; <span class="keyword">...</span>
            0 4; 1 5; 2 6; 3 7; <span class="keyword">...</span>
            4 8; 5 8; 6 9; 7 9; 8 9
        ];
    <span class="keyword">else</span>
        <span class="comment">% simple XYZ axes</span>
        ar_vertices = [0 0 0; 1 0 0; 0 1 0; 0 0 1];
        ar_edges = [0 1; 0 2; 0 3];
    <span class="keyword">end</span>

    <span class="comment">% camera matrix (assumes planar tracked object wrt camera plane)</span>
    [h,w,~] = size(img);
    fx = 1.0;  <span class="comment">% adjust camera focal length for proper augmentation [0.5, 1.0]</span>
    K = [fx*w,    0, 0.5*(w-1); <span class="keyword">...</span>
            0, fx*w, 0.5*(h-1); <span class="keyword">...</span>
            0,    0,         1];

    <span class="comment">% find object pose from corresponding 3D/2D points</span>
    rect = tr.target.rect;
    quad_3d = rect([1 2; 3 2; 3 4; 1 4]);
    quad_3d(:,3) = 0;  <span class="comment">% Z=0 for 3D points in target image</span>
    [rvec, tvec] = cv.solvePnP(quad_3d, tr.quad, K);

    <span class="comment">% scale and translate house vertices, to place it on top of target object</span>
    <span class="comment">% in target image coordinates, with origin being top-left corner in</span>
    <span class="comment">% rectangle plane:</span>
    <span class="comment">%  1 unit in x-dir = object width</span>
    <span class="comment">%  1 unit in y-dir = object height</span>
    <span class="comment">%  1 unit in z-dir = 0.3 * object width (in opposite cam z-direction)</span>
    xyzScale = rect(3:4) - rect(1:2);
    xyzScale(3) = -0.3 * max(xyzScale);
    verts = bsxfun(@times, ar_vertices, xyzScale);
    verts = bsxfun(@plus, verts, [rect(1:2) 0]);

    <span class="comment">% project house 3d points to 2d points in new frame coordinates</span>
    verts = cv.projectPoints(verts, rvec, tvec, K);

    <span class="comment">% connect and draw house edges in new frame</span>
    pts1 = verts(ar_edges(:,1)+1,:);
    pts2 = verts(ar_edges(:,2)+1,:);
    img = cv.line(img, pts1, pts2, <span class="string">'Color'</span>,[255 255 0], <span class="string">'Thickness'</span>,2);
<span class="keyword">end</span></pre><img src="plane_ar_demo_02.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Planar augmented reality
%
% This sample shows an example of augmented reality overlay over a tracked
% planar object. The function |cv.solvePnP| is used to estimate the tracked
% object location in 3D space.
%
% Select a textured planar object to track by drawing a box with the mouse.
% It uses the |RectSelector| and |PlaneTracker| classes.
%
% Sample video: <http://www.youtube.com/watch?v=pzVbhxx6aog>.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.3.1/samples/python/plane_ar.py>
%

function plane_ar_demo(vid)
    % video file, and a default target to track [x,y,w,h]
    win = [];
    if nargin < 1
        vid = fullfile(mexopencv.root(), 'test', 'blais.mp4');
        assert(exist(vid, 'file') == 2, 'Missing video file');
        if true
            win = [135 165 285 175];  % face
        else
            win = [136 0 366 433];    % book
        end
    elseif isempty(vid)
        vid = 0;
    end

    % open video feed, and get first frame
    cap = cv.VideoCapture(vid);
    pause(1);
    assert(cap.isOpened(), 'Failed to open video');
    frame = cap.read();
    assert(~isempty(frame), 'Failed to read frames');

    % prepare plot
    paused = false;
    hImg = imshow(frame);

    % create and initialize tracker
    tracker = PlaneTracker();
    if ~isempty(win)
        tracker.addTarget(frame, win);
    end

    % create ROI region selector
    if ~mexopencv.isOctave()
        onHelp();
        roi = RectSelector(hImg);
        roi.callback = @onRect;
    else
        %HACK: RectSelector not Octave compatible
        %HACK: function handle to nested function not supported in Octave
        roi = struct('isDragging',@()false);
    end

    % listen to keyboard input
    if ~mexopencv.isOctave()
        %HACK: function handle to nested function not supported in Octave
        set(ancestor(hImg,'figure'), 'WindowKeyPressFcn',@onType);
    end

    % main loop
    while ishghandle(hImg)
        playing = ~paused && ~roi.isDragging();
        if playing
            % read new frame
            frame = cap.read();
            if isempty(frame), break; end
        end
        out = frame;

        % track and draw keypoints, boundary, and pose of targets
        if playing
            tracked = tracker.track(frame);
            for i=1:numel(tracked)
                tr = tracked(i);
                out = cv.circle(out, tr.pt1, 2, 'Color',[0 0 255]);
                out = cv.polylines(out, tr.quad, 'Closed',true, ...
                    'Color',[0 0 255], 'Thickness',2);
                out = drawOverlay(out, tr);
            end
        end

        % display result
        set(hImg, 'CData',out);
        if playing
            drawnow;
        else
            pause(0.1);  % slow down a bit if paused
        end
    end
    cap.release();
    if isobject(roi), delete(roi); end

    % REPLACE_WITH_DASH_DASH- Callback functions REPLACE_WITH_DASH_DASH-

    function onRect(rect)
        %ONRECT  Callback for ROI selector
        %
        %     onRect(rect)
        %
        % ## Input
        % * __rect__ selected rectangle [x,y,w,h], or empty
        %

        if isempty(rect), return; end

        % track new target
        disp('Adding target...')
        tracker.addTarget(frame, rect);

        % un-pause
        paused = false;
    end

    function onType(hfig, e)
        %ONTYPE  Event handler for key press on figure

        switch e.Key
            case {'q', 'escape'}
                close(hfig);

            case 'h'
                onHelp();

            case {'space', 'p'}
                disp('Toggle pause...');
                paused = ~paused;

            case {'c', 'r'}
                disp('Clearing tracker...');
                tracker.clear();
        end
    end

    function onHelp()
        %ONHELP  Display usage help dialog

        h = helpdlg({
            'Select object(s) to track using the mouse.'
            'Hot keys:'
            '  q - quit'
            '  h - help'
            '  p - pause'
            '  c - clear targets'
        });

        % wait for user to accept dialog
        set(h, 'WindowStyle','modal');
        waitfor(h);
    end
end

%% Helper function

function img = drawOverlay(img, tr)
    %DRAWOVERLAY  Draw a 3D house on top of tracked object to show its pose
    %
    %     img = drawOverlay(img, tr)
    %
    % ## Input
    % * __img__ image on which to draw
    % * __tr__ tracked target structure
    %
    % ## Output
    % * __img__ output image
    %

    if true
        % simple model of a house (cube with a triangular prism roof)
        ar_vertices = [
            0 0 0; 0 1 0; 1 1 0; 1 0 0; ...
            0 0 1; 0 1 1; 1 1 1; 1 0 1; ...
            0 0.5 2; 1 0.5 2
        ];
        ar_edges = [
            0 1; 1 2; 2 3; 3 0; ...
            4 5; 5 6; 6 7; 7 4; ...
            0 4; 1 5; 2 6; 3 7; ...
            4 8; 5 8; 6 9; 7 9; 8 9
        ];
    else
        % simple XYZ axes
        ar_vertices = [0 0 0; 1 0 0; 0 1 0; 0 0 1];
        ar_edges = [0 1; 0 2; 0 3];
    end

    % camera matrix (assumes planar tracked object wrt camera plane)
    [h,w,~] = size(img);
    fx = 1.0;  % adjust camera focal length for proper augmentation [0.5, 1.0]
    K = [fx*w,    0, 0.5*(w-1); ...
            0, fx*w, 0.5*(h-1); ...
            0,    0,         1];

    % find object pose from corresponding 3D/2D points
    rect = tr.target.rect;
    quad_3d = rect([1 2; 3 2; 3 4; 1 4]);
    quad_3d(:,3) = 0;  % Z=0 for 3D points in target image
    [rvec, tvec] = cv.solvePnP(quad_3d, tr.quad, K);

    % scale and translate house vertices, to place it on top of target object
    % in target image coordinates, with origin being top-left corner in
    % rectangle plane:
    %  1 unit in x-dir = object width
    %  1 unit in y-dir = object height
    %  1 unit in z-dir = 0.3 * object width (in opposite cam z-direction)
    xyzScale = rect(3:4) - rect(1:2);
    xyzScale(3) = -0.3 * max(xyzScale);
    verts = bsxfun(@times, ar_vertices, xyzScale);
    verts = bsxfun(@plus, verts, [rect(1:2) 0]);

    % project house 3d points to 2d points in new frame coordinates
    verts = cv.projectPoints(verts, rvec, tvec, K);

    % connect and draw house edges in new frame
    pts1 = verts(ar_edges(:,1)+1,:);
    pts2 = verts(ar_edges(:,2)+1,:);
    img = cv.line(img, pts1, pts2, 'Color',[255 255 0], 'Thickness',2);
end

##### SOURCE END #####
-->
   </body>
</html>