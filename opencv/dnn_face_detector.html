<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>DNN: Face Detection</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2018-02-20">
      <meta name="DC.source" content="dnn_face_detector.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">DNN: Face Detection</h1>
         <!--introduction-->
         <p>Face detector based on SSD framework (Single Shot MultiBox Detector), using a reduced ResNet-10 model.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face_python.py">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face_python.py</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face.cpp">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <p>import network</p><pre class="codeinput">[net, blobOpts] = ResNetSSD_FaceDetector();
assert(~net.empty());</pre><p>minimum confidence threshold of detections to show</p><pre class="codeinput">confThreshold = 0.5;</pre><p>prepare video input</p><pre class="codeinput">cap = createVideoCapture([], <span class="string">'lena'</span>);
pause(1);
assert(cap.isOpened(), <span class="string">'Could not initialize capturing'</span>);</pre><p>prepare figure</p><pre class="codeinput">frame = cap.read();
assert(~isempty(frame), <span class="string">'Could not read frame'</span>);
hImg = imshow(frame);</pre><img src="dnn_face_detector_01.png"><p>main loop over video feed</p><pre class="codeinput"><span class="keyword">while</span> ishghandle(hImg)
    <span class="comment">% read frame</span>
    frame = cap.read();
    <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>

    <span class="comment">% detect faces</span>
    [rects, confs] = detectFaces(frame, net, blobOpts, confThreshold);
    <span class="keyword">for</span> i=1:size(rects,1)
        frame = cv.rectangle(frame, rects(i,:), <span class="keyword">...</span>
            <span class="string">'Color'</span>,[0 255 0], <span class="string">'Thickness'</span>,2);
        frame = cv.putText(frame, sprintf(<span class="string">'conf = %3.0f%%'</span>, confs(i)*100), <span class="keyword">...</span>
            rects(i,1:2) - [0 4], <span class="string">'Color'</span>,[255 0 0], <span class="string">'FontScale'</span>,0.5);
    <span class="keyword">end</span>

    <span class="comment">% show inference timing</span>
    [~,t] = net.getPerfProfile();
    t = double(t) / cv.TickMeter.getTickFrequency();
    frame = cv.putText(frame, sprintf(<span class="string">'time = %g sec'</span>, t), [10 20], <span class="keyword">...</span>
        <span class="string">'Color'</span>,[255 255 0], <span class="string">'FontScale'</span>,0.5);

    <span class="comment">% update plot</span>
    set(hImg, <span class="string">'CData'</span>,frame);
    drawnow;
<span class="keyword">end</span>
cap.release();</pre><p>Helper functions</p><pre class="codeinput"><span class="keyword">function</span> [rects, confs] = detectFaces(img, net, blobOpts, thresh)
    <span class="comment">%DETECTFACES  Run face detection network to detect faces on input image</span>
    <span class="comment">%</span>
    <span class="comment">% You may play with input blob sizes to balance detection quality and</span>
    <span class="comment">% efficiency. The bigger input blob the smaller faces may be detected.</span>
    <span class="comment">%</span>

    <span class="comment">% detect faces</span>
    net.setInput(cv.Net.blobFromImages(flip(img,3), blobOpts{:}));
    dets = net.forward();

    <span class="comment">% SSD output is 1-by-1-by-ndetections-by-7</span>
    <span class="comment">% d = [img_id, class_id, confidence, left, bottom, right, top]</span>
    dets = permute(dets, [3 4 2 1]);

    <span class="comment">% filter out weak detections</span>
    <span class="keyword">if</span> nargin &lt; 4, thresh = 0.5; <span class="keyword">end</span>
    idx = (dets(:,2) == 1 &amp; dets(:,3) &gt; thresh);  <span class="comment">% 0: background, 1: face</span>
    dets = dets(idx,:);

    <span class="comment">% adjust relative coordinates to image size</span>
    sz = [size(img,2) size(img,1)];
    dets(:,4:7) = bsxfun(@times, dets(:,4:7), [sz sz]);

    <span class="comment">% output detections (clamp coords and remove small and out-of-bound rects)</span>
    rects = cv.Rect.from2points(dets(:,4:5), dets(:,6:7));
    rects = cv.Rect.intersect(rects, [0 0 sz]);
    idx = (cv.Rect.area(rects) &gt;= 10);
    rects = rects(idx,:);
    confs = dets(idx,3);
<span class="keyword">end</span></pre><img src="dnn_face_detector_02.png"><p>Pretrained models</p><pre class="codeinput"><span class="keyword">function</span> dname = get_dnn_dir(dname)
    <span class="comment">%GET_DNN_DIR  Path to model files, and show where to get them if missing</span>

    dname = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'dnn'</span>, dname);
    b = isdir(dname);
    <span class="keyword">if</span> ~b
        <span class="comment">% display help of calling function</span>
        <span class="comment">% (assumed to be a local function in current file)</span>
        st = dbstack(1);
        help([mfilename() filemarker() st(1).name])
    <span class="keyword">end</span>
    assert(b, <span class="string">'Missing model: %s'</span>, dname);
<span class="keyword">end</span>

<span class="keyword">function</span> [net, blobOpts] = ResNetSSD_FaceDetector()
    <span class="comment">%RESNETSSD_FACEDETECTOR  face detector based on SSD framework with reduced ResNet-10 backbone</span>
    <span class="comment">%</span>
    <span class="comment">% homepage = https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/face_detector/how_to_train_face_detector.txt</span>
    <span class="comment">%</span>
    <span class="comment">% ## Model</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/ResNetSSD_FaceDetector/deploy.prototxt</span>
    <span class="comment">% url  = https://github.com/opencv/opencv/raw/3.4.0/samples/dnn/face_detector/deploy.prototxt</span>
    <span class="comment">% hash = 006BAF926232DF6F6332DEFB9C24F94BB9F3764E</span>
    <span class="comment">%</span>
    <span class="comment">% ## Weights</span>
    <span class="comment">%</span>
    <span class="comment">% file = test/dnn/ResNetSSD_FaceDetector/res10_300x300_ssd_iter_140000.caffemodel</span>
    <span class="comment">% url  = https://github.com/opencv/opencv_3rdparty/raw/dnn_samples_face_detector_20170830/res10_300x300_ssd_iter_140000.caffemodel</span>
    <span class="comment">% hash = 15aa726b4d46d9f023526d85537db81cbc8dd566</span>
    <span class="comment">% size = 10.1 MB</span>
    <span class="comment">%</span>

    dname = get_dnn_dir(<span class="string">'ResNetSSD_FaceDetector'</span>);
    net = cv.Net(<span class="string">'Caffe'</span>, <span class="keyword">...</span>
        fullfile(dname, <span class="string">'deploy.prototxt'</span>), <span class="keyword">...</span>
        fullfile(dname, <span class="string">'res10_300x300_ssd_iter_140000.caffemodel'</span>));
    blobOpts = {<span class="string">'SwapRB'</span>,false, <span class="string">'Crop'</span>,false, <span class="string">'Size'</span>,[300 300], <span class="string">'Mean'</span>,[104 117 123]};
<span class="keyword">end</span></pre><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% DNN: Face Detection
% Face detector based on SSD framework (Single Shot MultiBox Detector),
% using a reduced ResNet-10 model.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face_python.py>
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/resnet_ssd_face.cpp>
%

%%
% import network
[net, blobOpts] = ResNetSSD_FaceDetector();
assert(~net.empty());

%%
% minimum confidence threshold of detections to show
confThreshold = 0.5;

%%
% prepare video input
cap = createVideoCapture([], 'lena');
pause(1);
assert(cap.isOpened(), 'Could not initialize capturing');

%%
% prepare figure
frame = cap.read();
assert(~isempty(frame), 'Could not read frame');
hImg = imshow(frame);

%%
% main loop over video feed
while ishghandle(hImg)
    % read frame
    frame = cap.read();
    if isempty(frame), break; end

    % detect faces
    [rects, confs] = detectFaces(frame, net, blobOpts, confThreshold);
    for i=1:size(rects,1)
        frame = cv.rectangle(frame, rects(i,:), ...
            'Color',[0 255 0], 'Thickness',2);
        frame = cv.putText(frame, sprintf('conf = %3.0f%%', confs(i)*100), ...
            rects(i,1:2) - [0 4], 'Color',[255 0 0], 'FontScale',0.5);
    end

    % show inference timing
    [~,t] = net.getPerfProfile();
    t = double(t) / cv.TickMeter.getTickFrequency();
    frame = cv.putText(frame, sprintf('time = %g sec', t), [10 20], ...
        'Color',[255 255 0], 'FontScale',0.5);

    % update plot
    set(hImg, 'CData',frame);
    drawnow;
end
cap.release();

%%
% Helper functions

function [rects, confs] = detectFaces(img, net, blobOpts, thresh)
    %DETECTFACES  Run face detection network to detect faces on input image
    %
    % You may play with input blob sizes to balance detection quality and
    % efficiency. The bigger input blob the smaller faces may be detected.
    %

    % detect faces
    net.setInput(cv.Net.blobFromImages(flip(img,3), blobOpts{:}));
    dets = net.forward();

    % SSD output is 1-by-1-by-ndetections-by-7
    % d = [img_id, class_id, confidence, left, bottom, right, top]
    dets = permute(dets, [3 4 2 1]);

    % filter out weak detections
    if nargin < 4, thresh = 0.5; end
    idx = (dets(:,2) == 1 & dets(:,3) > thresh);  % 0: background, 1: face
    dets = dets(idx,:);

    % adjust relative coordinates to image size
    sz = [size(img,2) size(img,1)];
    dets(:,4:7) = bsxfun(@times, dets(:,4:7), [sz sz]);

    % output detections (clamp coords and remove small and out-of-bound rects)
    rects = cv.Rect.from2points(dets(:,4:5), dets(:,6:7));
    rects = cv.Rect.intersect(rects, [0 0 sz]);
    idx = (cv.Rect.area(rects) >= 10);
    rects = rects(idx,:);
    confs = dets(idx,3);
end

%%
% Pretrained models

function dname = get_dnn_dir(dname)
    %GET_DNN_DIR  Path to model files, and show where to get them if missing

    dname = fullfile(mexopencv.root(), 'test', 'dnn', dname);
    b = isdir(dname);
    if ~b
        % display help of calling function
        % (assumed to be a local function in current file)
        st = dbstack(1);
        help([mfilename() filemarker() st(1).name])
    end
    assert(b, 'Missing model: %s', dname);
end

function [net, blobOpts] = ResNetSSD_FaceDetector()
    %RESNETSSD_FACEDETECTOR  face detector based on SSD framework with reduced ResNet-10 backbone
    %
    % homepage = https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/face_detector/how_to_train_face_detector.txt
    %
    % ## Model
    %
    % file = test/dnn/ResNetSSD_FaceDetector/deploy.prototxt
    % url  = https://github.com/opencv/opencv/raw/3.4.0/samples/dnn/face_detector/deploy.prototxt
    % hash = 006BAF926232DF6F6332DEFB9C24F94BB9F3764E
    %
    % ## Weights
    %
    % file = test/dnn/ResNetSSD_FaceDetector/res10_300x300_ssd_iter_140000.caffemodel
    % url  = https://github.com/opencv/opencv_3rdparty/raw/dnn_samples_face_detector_20170830/res10_300x300_ssd_iter_140000.caffemodel
    % hash = 15aa726b4d46d9f023526d85537db81cbc8dd566
    % size = 10.1 MB
    %

    dname = get_dnn_dir('ResNetSSD_FaceDetector');
    net = cv.Net('Caffe', ...
        fullfile(dname, 'deploy.prototxt'), ...
        fullfile(dname, 'res10_300x300_ssd_iter_140000.caffemodel'));
    blobOpts = {'SwapRB',false, 'Crop',false, 'Size',[300 300], 'Mean',[104 117 123]};
end

##### SOURCE END #####
-->
   </body>
</html>