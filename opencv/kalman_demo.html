<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Tracking of rotating point using Kalman filter</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="kalman_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Tracking of rotating point using Kalman filter</h1>
         <!--introduction-->
         <p>Tracking of rotating point. Rotation speed is constant. Both state and measurements vectors are 1D (a point angle), Measurement
            is the real point angle + gaussian noise. The real and the estimated points are connected with yellow line segment, the real
            and the measured points are connected with red line segment. (if Kalman filter works correctly, the yellow segment should
            be shorter than the red one).
         </p>
         <p>Pressing any key will reset the tracking with a different speed. Close the window to stop the program.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/kalman.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/kalman.cpp</a></li>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/python/kalman.py">https://github.com/opencv/opencv/blob/3.2.0/samples/python/kalman.py</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <p>set up display window</p><pre class="codeinput">img = zeros(500, 500, 3, <span class="string">'uint8'</span>);
hFig = figure(<span class="string">'KeyPressFcn'</span>,@(o,e)setappdata(o, <span class="string">'flag'</span>,true), <span class="keyword">...</span>
    <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Name'</span>,<span class="string">'Kalman Filter demo'</span>);
setappdata(hFig, <span class="string">'flag'</span>,false);
hImg = imshow(img);</pre><img src="kalman_demo_01.png"><p>helper anonymous functions</p><pre class="codeinput">calcPoint = @(center,R,angle) center + [cos(angle), -sin(angle)]*R;
drawCross = @(img,center,clr,d) cv.line(<span class="keyword">...</span>
    cv.line(img, center-d, center+d, <span class="string">'Color'</span>,clr, <span class="keyword">...</span>
        <span class="string">'Thickness'</span>,1, <span class="string">'LineType'</span>,<span class="string">'AA'</span>), <span class="keyword">...</span>
    center+[d -d], center+[-d d], <span class="string">'Color'</span>,clr, <span class="keyword">...</span>
        <span class="string">'Thickness'</span>,1, <span class="string">'LineType'</span>,<span class="string">'AA'</span>);</pre><p>create and intialize Kalman filter</p><pre class="codeinput">KF = cv.KalmanFilter(2, 1);
state = zeros(2,1);  <span class="comment">% [phi; delta_phi]</span>
processNoise = zeros(2,1);
measurement = zeros(1,1);</pre><p>keep repeating until figure is closed</p><pre class="codeinput">tic
<span class="keyword">while</span> ishghandle(hFig)
    <span class="keyword">if</span> toc &gt; 3, <span class="keyword">break</span>; <span class="keyword">end</span>
    setappdata(hFig, <span class="string">'flag'</span>,false);

    <span class="comment">% initialize KF</span>
    state = randn(size(state))*0.1;
    KF.transitionMatrix = [1 1; 0 1];
    KF.measurementMatrix = eye(size(KF.measurementMatrix));
    KF.processNoiseCov = eye(size(KF.processNoiseCov))*1e-5;
    KF.measurementNoiseCov = eye(size(KF.measurementNoiseCov))*1e-1;
    KF.errorCovPost = eye(size(KF.errorCovPost));
    KF.statePost = randn(size(KF.statePost))*0.1;

    <span class="comment">% main loop</span>
    <span class="keyword">while</span> ishghandle(hFig)
        <span class="keyword">if</span> toc &gt; 3, <span class="keyword">break</span>; <span class="keyword">end</span>
        center = [size(img,2) size(img,1)]/2;
        R = size(img,2)/3;
        stateAngle = state(1);
        statePt = calcPoint(center, R, stateAngle);

        prediction = KF.predict();
        predictAngle = prediction(1);
        predictPt = calcPoint(center, R, predictAngle);

        measurement = randn(size(measurement))*KF.measurementNoiseCov(1);

        <span class="comment">% generate measurement</span>
        measurement = measurement + KF.measurementMatrix*state;

        measAngle = measurement(1);
        measPt = calcPoint(center, R, measAngle);

        <span class="comment">% plot points</span>
        img(:) = 0;
        img = drawCross(img, statePt, [255 255 255], 3);
        img = drawCross(img, measPt, [255 0 0 0], 3);
        img = drawCross(img, predictPt, [0 255 0], 3);
        img = cv.line(img, statePt, measPt, <span class="string">'Color'</span>,[255 0 0], <span class="keyword">...</span>
            <span class="string">'Thickness'</span>,3, <span class="string">'LineType'</span>,<span class="string">'AA'</span>);
        img = cv.line(img, predictPt, measPt, <span class="string">'Color'</span>,[255 255 0], <span class="keyword">...</span>
            <span class="string">'Thickness'</span>,3, <span class="string">'LineType'</span>,<span class="string">'AA'</span>);

        <span class="keyword">if</span> rand &gt; 0.75
            KF.correct(measurement);
        <span class="keyword">end</span>

        processNoise = randn(size(processNoise))*sqrt(KF.processNoiseCov(1,1));
        state = KF.transitionMatrix*state + processNoise;

        <span class="comment">% update display</span>
        set(hImg, <span class="string">'CData'</span>,img);

        <span class="comment">% break of inner loop on any key press</span>
        flag = getappdata(hFig, <span class="string">'flag'</span>);
        <span class="keyword">if</span> isempty(flag)||flag, <span class="keyword">break</span>; <span class="keyword">end</span>
        pause(0.1)
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><img src="kalman_demo_02.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Tracking of rotating point using Kalman filter
%
% Tracking of rotating point.
% Rotation speed is constant.
% Both state and measurements vectors are 1D (a point angle),
% Measurement is the real point angle + gaussian noise.
% The real and the estimated points are connected with yellow line segment,
% the real and the measured points are connected with red line segment.
% (if Kalman filter works correctly,
% the yellow segment should be shorter than the red one).
%
% Pressing any key will reset the tracking with a different speed.
% Close the window to stop the program.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/kalman.cpp>
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/python/kalman.py>
%

%%
% set up display window
img = zeros(500, 500, 3, 'uint8');
hFig = figure('KeyPressFcn',@(o,e)setappdata(o, 'flag',true), ...
    'Menubar','none', 'Name','Kalman Filter demo');
setappdata(hFig, 'flag',false);
hImg = imshow(img);

%%
% helper anonymous functions
calcPoint = @(center,R,angle) center + [cos(angle), -sin(angle)]*R;
drawCross = @(img,center,clr,d) cv.line(...
    cv.line(img, center-d, center+d, 'Color',clr, ...
        'Thickness',1, 'LineType','AA'), ...
    center+[d -d], center+[-d d], 'Color',clr, ...
        'Thickness',1, 'LineType','AA');

%%
% create and intialize Kalman filter
KF = cv.KalmanFilter(2, 1);
state = zeros(2,1);  % [phi; delta_phi]
processNoise = zeros(2,1);
measurement = zeros(1,1);

%%
% keep repeating until figure is closed
tic
while ishghandle(hFig)
    if toc > 3, break; end
    setappdata(hFig, 'flag',false);

    % initialize KF
    state = randn(size(state))*0.1;
    KF.transitionMatrix = [1 1; 0 1];
    KF.measurementMatrix = eye(size(KF.measurementMatrix));
    KF.processNoiseCov = eye(size(KF.processNoiseCov))*1e-5;
    KF.measurementNoiseCov = eye(size(KF.measurementNoiseCov))*1e-1;
    KF.errorCovPost = eye(size(KF.errorCovPost));
    KF.statePost = randn(size(KF.statePost))*0.1;

    % main loop
    while ishghandle(hFig)
        if toc > 3, break; end
        center = [size(img,2) size(img,1)]/2;
        R = size(img,2)/3;
        stateAngle = state(1);
        statePt = calcPoint(center, R, stateAngle);

        prediction = KF.predict();
        predictAngle = prediction(1);
        predictPt = calcPoint(center, R, predictAngle);

        measurement = randn(size(measurement))*KF.measurementNoiseCov(1);

        % generate measurement
        measurement = measurement + KF.measurementMatrix*state;

        measAngle = measurement(1);
        measPt = calcPoint(center, R, measAngle);

        % plot points
        img(:) = 0;
        img = drawCross(img, statePt, [255 255 255], 3);
        img = drawCross(img, measPt, [255 0 0 0], 3);
        img = drawCross(img, predictPt, [0 255 0], 3);
        img = cv.line(img, statePt, measPt, 'Color',[255 0 0], ...
            'Thickness',3, 'LineType','AA');
        img = cv.line(img, predictPt, measPt, 'Color',[255 255 0], ...
            'Thickness',3, 'LineType','AA');

        if rand > 0.75
            KF.correct(measurement);
        end

        processNoise = randn(size(processNoise))*sqrt(KF.processNoiseCov(1,1));
        state = KF.transitionMatrix*state + processNoise;

        % update display
        set(hImg, 'CData',img);

        % break of inner loop on any key press
        flag = getappdata(hFig, 'flag');
        if isempty(flag)||flag, break; end
        pause(0.1)
    end
end

##### SOURCE END #####
-->
   </body>
</html>