<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>lk_demo_gui</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="lk_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Lucas-Kanade Optical Flow</a></li>
               <li><a href="#3">Callback functions</a></li>
               <li><a href="#5">Helper functions</a></li>
            </ul>
         </div>
         <h2 id="1">Lucas-Kanade Optical Flow</h2>
         <p>A demo of Lukas-Kanade optical flow. It uses camera by default, but you can provide a path to video as an argument.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/lkdemo.cpp">https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/lkdemo.cpp</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = lk_demo_gui(varargin)</pre><pre class="codeinput">    <span class="comment">% setup video capture</span>
    cap = createVideoCapture([], <span class="string">'chess'</span>);
    assert(cap.isOpened());
    frame = cap.read();
    assert(~isempty(frame) &amp;&amp; size(frame,3)==3);
    prev = cv.cvtColor(frame, <span class="string">'RGB2GRAY'</span>);

    <span class="comment">% create the UI, and hook event handlers</span>
    h = buildGUI(frame);
    set(h.fig, <span class="string">'WindowKeyPressFcn'</span>,@onType, <span class="keyword">...</span>
        <span class="string">'WindowButtonDownFcn'</span>,@onMouseDown, <span class="keyword">...</span>
        <span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>

    <span class="comment">% initialize state</span>
    pts = [];
    initCorners = false;
    nightMode = false;

    <span class="comment">% main loop</span>
    <span class="keyword">while</span> ishghandle(h.fig)
        <span class="comment">% get next frame</span>
        frame = cap.read();
        <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>
        next = cv.cvtColor(frame, <span class="string">'RGB2GRAY'</span>);

        <span class="comment">% black background in night mode</span>
        <span class="keyword">if</span> nightMode
            frame(:) = 0;
        <span class="keyword">end</span>

        <span class="keyword">if</span> initCorners
            <span class="comment">% automatic points initialization</span>
            pts = detectPoints(next);
            initCorners = false;
        <span class="keyword">elseif</span> ~isempty(pts)
            <span class="comment">% track points</span>
            pts = trackPoints(pts, prev, next);
            <span class="comment">% draw points</span>
            frame = cv.circle(frame, pts, 3, <span class="keyword">...</span>
                <span class="string">'Color'</span>,[0 255 0], <span class="string">'Thickness'</span>,<span class="string">'Filled'</span>);
        <span class="keyword">end</span>

        <span class="comment">% show output</span>
        set(h.img, <span class="string">'CData'</span>,frame);
        drawnow <span class="string">limitrate</span>;

        <span class="comment">% next iteration</span>
        prev = next;
    <span class="keyword">end</span>
    cap.release();  <span class="comment">% release video source</span></pre><img src="lk_demo_gui_02.png"><h2 id="3">Callback functions</h2><pre class="codeinput">    <span class="keyword">function</span> onMouseDown(~,~)
        <span class="comment">%ONMOUSEDOWN  Event handler for mouse down on figure</span>

        <span class="comment">% current mouse location</span>
        p = get(h.ax, <span class="string">'CurrentPoint'</span>);
        p = p(1,1:2) - 1;

        <span class="comment">% check if user clicked close to an existing point</span>
        <span class="keyword">if</span> ~isempty(pts)
            [d,idx] = cv.batchDistance(p, pts, <span class="string">'K'</span>,1);
            <span class="keyword">if</span> d &lt;= 5
                <span class="comment">% remove point</span>
                pts(idx,:) = [];
                <span class="keyword">return</span>;
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">% check if we still have room for more points</span>
        <span class="keyword">if</span> size(pts,1) &lt;= 300
            <span class="comment">% add point</span>
            pts(end+1,:) = p;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> onType(~,e)
        <span class="comment">%ONTYPE  Event handler for key press on figure</span>

        <span class="keyword">switch</span> e.Key
            <span class="keyword">case</span> <span class="string">'h'</span>
                helpdlg({
                    <span class="string">'To add/remove points, click with the mouse.'</span>
                    <span class="string">'Hot keys:'</span>
                    <span class="string">'h - this help dialog'</span>
                    <span class="string">'q - quit the program'</span>
                    <span class="string">'n - switch "night" mode on/off'</span>
                    <span class="string">'c - clear all the points'</span>
                    <span class="string">'r - initialize tracking by auto-detecting corners'</span>
                });
            <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
                close(h.fig);
            <span class="keyword">case</span> <span class="string">'n'</span>
                nightMode = ~nightMode;
            <span class="keyword">case</span> <span class="string">'c'</span>
                pts = [];
            <span class="keyword">case</span> <span class="string">'r'</span>
                initCorners = true;
        <span class="keyword">end</span>
    <span class="keyword">end</span></pre><pre class="codeinput"><span class="keyword">end</span></pre><img src="lk_demo_gui_01.png"><h2 id="5">Helper functions</h2><pre class="codeinput"><span class="keyword">function</span> pts = detectPoints(gray)
    <span class="comment">%DETECTPOINTS  Find and refine corners in image</span>

    <span class="comment">% detect corners</span>
    pts = cv.goodFeaturesToTrack(gray, <span class="keyword">...</span>
        <span class="string">'MaxCorners'</span>,100, <span class="string">'QualityLevel'</span>,0.01, <span class="string">'MinDistance'</span>,10);
    <span class="keyword">if</span> isempty(pts)
        pts = [];
        <span class="keyword">return</span>;
    <span class="keyword">end</span>

    <span class="comment">% refine corners</span>
    pts = cv.cornerSubPix(gray, pts, <span class="string">'WinSize'</span>,[10 10], <span class="keyword">...</span>
        <span class="string">'Criteria'</span>,struct(<span class="string">'type'</span>,<span class="string">'Count+EPS'</span>, <span class="string">'maxCount'</span>,20, <span class="string">'epsilon'</span>,0.03));

    <span class="comment">% return Nx2 matrix of points</span>
    pts = cat(1, pts{:});
<span class="keyword">end</span>

<span class="keyword">function</span> pts = trackPoints(pts, prev, next)
    <span class="comment">%TRACKPOINTS  Calculate flow of sparse points</span>

    <span class="comment">% calculate sparse optical flow</span>
    [pts, status] = cv.calcOpticalFlowPyrLK(prev, next, pts, <span class="keyword">...</span>
        <span class="string">'WinSize'</span>,[31 31], <span class="string">'MinEigThreshold'</span>,0.001);

    <span class="comment">% drop points that are not found</span>
    pts = cat(1, pts{status == 1});
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI(img)
    <span class="comment">%BUILDGUI  Creates the UI</span>

    <span class="comment">% build the user interface (no resizing to keep it simple)</span>
    sz = size(img);
    h = struct();
    h.fig = figure(<span class="string">'Name'</span>,<span class="string">'LK Demo'</span>, <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
        <span class="string">'Pointer'</span>,<span class="string">'cross'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="string">'Position'</span>,[200 200 sz(2) sz(1)]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        <span class="comment">%HACK: not implemented in Octave</span>
        movegui(h.fig, <span class="string">'center'</span>);
    <span class="keyword">end</span>
    h.ax = axes(<span class="string">'Parent'</span>,h.fig, <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,[0 0 1 1]);
    <span class="keyword">if</span> ~mexopencv.isOctave()
        h.img = imshow(img, <span class="string">'Parent'</span>,h.ax);
    <span class="keyword">else</span>
        <span class="comment">%HACK: https://savannah.gnu.org/bugs/index.php?45473</span>
        axes(h.ax);
        h.img = imshow(img);
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Lucas-Kanade Optical Flow
% A demo of Lukas-Kanade optical flow.
% It uses camera by default, but you can provide a path to video as an
% argument.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/cpp/lkdemo.cpp>
%

function varargout = lk_demo_gui(varargin)
    % setup video capture
    cap = createVideoCapture([], 'chess');
    assert(cap.isOpened());
    frame = cap.read();
    assert(~isempty(frame) && size(frame,3)==3);
    prev = cv.cvtColor(frame, 'RGB2GRAY');

    % create the UI, and hook event handlers
    h = buildGUI(frame);
    set(h.fig, 'WindowKeyPressFcn',@onType, ...
        'WindowButtonDownFcn',@onMouseDown, ...
        'Interruptible','off', 'BusyAction','cancel');
    if nargout > 0, varargout{1} = h; end

    % initialize state
    pts = [];
    initCorners = false;
    nightMode = false;

    % main loop
    while ishghandle(h.fig)
        % get next frame
        frame = cap.read();
        if isempty(frame), break; end
        next = cv.cvtColor(frame, 'RGB2GRAY');

        % black background in night mode
        if nightMode
            frame(:) = 0;
        end

        if initCorners
            % automatic points initialization
            pts = detectPoints(next);
            initCorners = false;
        elseif ~isempty(pts)
            % track points
            pts = trackPoints(pts, prev, next);
            % draw points
            frame = cv.circle(frame, pts, 3, ...
                'Color',[0 255 0], 'Thickness','Filled');
        end

        % show output
        set(h.img, 'CData',frame);
        drawnow limitrate;

        % next iteration
        prev = next;
    end
    cap.release();  % release video source

    %% Callback functions

    function onMouseDown(~,~)
        %ONMOUSEDOWN  Event handler for mouse down on figure

        % current mouse location
        p = get(h.ax, 'CurrentPoint');
        p = p(1,1:2) - 1;

        % check if user clicked close to an existing point
        if ~isempty(pts)
            [d,idx] = cv.batchDistance(p, pts, 'K',1);
            if d <= 5
                % remove point
                pts(idx,:) = [];
                return;
            end
        end

        % check if we still have room for more points
        if size(pts,1) <= 300
            % add point
            pts(end+1,:) = p;
        end
    end

    function onType(~,e)
        %ONTYPE  Event handler for key press on figure

        switch e.Key
            case 'h'
                helpdlg({
                    'To add/remove points, click with the mouse.'
                    'Hot keys:'
                    'h - this help dialog'
                    'q - quit the program'
                    'n - switch "night" mode on/off'
                    'c - clear all the points'
                    'r - initialize tracking by auto-detecting corners'
                });
            case {'q', 'escape'}
                close(h.fig);
            case 'n'
                nightMode = ~nightMode;
            case 'c'
                pts = [];
            case 'r'
                initCorners = true;
        end
    end
end

%% Helper functions

function pts = detectPoints(gray)
    %DETECTPOINTS  Find and refine corners in image

    % detect corners
    pts = cv.goodFeaturesToTrack(gray, ...
        'MaxCorners',100, 'QualityLevel',0.01, 'MinDistance',10);
    if isempty(pts)
        pts = [];
        return;
    end

    % refine corners
    pts = cv.cornerSubPix(gray, pts, 'WinSize',[10 10], ...
        'Criteria',struct('type','Count+EPS', 'maxCount',20, 'epsilon',0.03));

    % return Nx2 matrix of points
    pts = cat(1, pts{:});
end

function pts = trackPoints(pts, prev, next)
    %TRACKPOINTS  Calculate flow of sparse points

    % calculate sparse optical flow
    [pts, status] = cv.calcOpticalFlowPyrLK(prev, next, pts, ...
        'WinSize',[31 31], 'MinEigThreshold',0.001);

    % drop points that are not found
    pts = cat(1, pts{status == 1});
end

function h = buildGUI(img)
    %BUILDGUI  Creates the UI

    % build the user interface (no resizing to keep it simple)
    sz = size(img);
    h = struct();
    h.fig = figure('Name','LK Demo', 'NumberTitle','off', 'Menubar','none', ...
        'Pointer','cross', 'Resize','off', 'Position',[200 200 sz(2) sz(1)]);
    if ~mexopencv.isOctave()
        %HACK: not implemented in Octave
        movegui(h.fig, 'center');
    end
    h.ax = axes('Parent',h.fig, 'Units','normalized', 'Position',[0 0 1 1]);
    if ~mexopencv.isOctave()
        h.img = imshow(img, 'Parent',h.ax);
    else
        %HACK: https://savannah.gnu.org/bugs/index.php?45473
        axes(h.ax);
        h.img = imshow(img);
    end
end

##### SOURCE END #####
-->
   </body>
</html>