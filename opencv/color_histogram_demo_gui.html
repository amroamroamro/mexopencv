<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Video Histogram</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2017-11-27">
      <meta name="DC.source" content="color_histogram_demo_gui.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Video Histogram</h1>
         <p>Demo to show live histogram of video, both 1D histograms of RGB channels and 2D histogram of Hue-Saturation.</p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.2.0/samples/python/color_histogram.py">https://github.com/opencv/opencv/blob/3.2.0/samples/python/color_histogram.py</a></li>
               <li><a href="https://docs.opencv.org/3.2.0/dd/d0d/tutorial_py_2d_histogram.html">https://docs.opencv.org/3.2.0/dd/d0d/tutorial_py_2d_histogram.html</a></li>
               <li><a href="https://docs.opencv.org/3.2.0/d1/db7/tutorial_py_histogram_begins.html">https://docs.opencv.org/3.2.0/d1/db7/tutorial_py_histogram_begins.html</a></li>
            </ul>
         </div><pre class="codeinput"><span class="keyword">function</span> varargout = color_histogram_demo_gui(varargin)
    <span class="comment">% setup video source</span>
    vid = createVideoCapture([], <span class="string">'chess'</span>);
    pause(0.5);
    assert(vid.isOpened());

    <span class="comment">% build and initialize GUI</span>
    opts = default_options();
    h = buildGUI(vid, opts);
    <span class="keyword">if</span> nargout &gt; 0, varargout{1} = h; <span class="keyword">end</span>

    <span class="comment">% main loop: while UI still open, keep processing frames</span>
    <span class="keyword">while</span> all(ishghandle(h.img)) &amp;&amp; vid.isOpened()
        <span class="comment">% grab next frame</span>
        frame = vid.read();
        <span class="keyword">if</span> isempty(frame), <span class="keyword">break</span>; <span class="keyword">end</span>

        <span class="comment">% compute 2D Hue/Saturation histogram and 1D R/G/B histogram</span>
        opts.scale = get(h.slid, <span class="string">'Value'</span>);  <span class="comment">% current slider value</span>
        out2 = hist2D_HSV(frame, opts);
        out1 = hist1D_RGB(frame, opts);

        <span class="comment">% show results</span>
        set(h.lbl, <span class="string">'String'</span>,sprintf(<span class="string">'Scale: %.0f'</span>,opts.scale));
        set(h.img(1), <span class="string">'CData'</span>,frame);
        set(h.img(2), <span class="string">'CData'</span>,out2);
        set(h.img(3), <span class="string">'CData'</span>,out1);
        drawnow;
    <span class="keyword">end</span>
    vid.release();
<span class="keyword">end</span>

<span class="keyword">function</span> opts = default_options()
    <span class="comment">%DEFAULT_OPTIONS  Create structure of options</span>

    opts = struct();

    <span class="comment">% hue/saturation histogram params (hue: 0-179 degrees, saturation: 0-255)</span>
    opts.hlims = [0 180];
    opts.slims = [0 256];
    opts.hbins = 180;
    opts.sbins = 256;

    <span class="comment">% R/G/B histograms params (R/G/B: 0-255)</span>
    opts.clims = [0 256];
    opts.cbins = 256;
    opts.sz = [150, 350];

    <span class="comment">% build HSV map, used to color the histogram</span>
    [H,S,V] = ndgrid((1:opts.hbins)-1, (1:opts.sbins)-1, 255);
    RGB = cv.cvtColor(uint8(cat(3,H,S,V)), <span class="string">'HSV2RGB'</span>);
    opts.map = double(RGB)./255;
    opts.scale = 20;
<span class="keyword">end</span>

<span class="keyword">function</span> out = hist2D_HSV(img, opts)
    <span class="comment">%HIST1D_HSV  Calculate H-S 2D histogram</span>

    <span class="comment">% downscale for faster computation</span>
    <span class="keyword">if</span> false
        img = cv.pyrDown(img);
    <span class="keyword">end</span>

    <span class="comment">% convert RGB to HSV colorspace</span>
    hsv = cv.cvtColor(img, <span class="string">'RGB2HSV'</span>);

    <span class="comment">% blacken dark pixels</span>
    mask = hsv(:,:,3) &lt; 20;  <span class="comment">% V between 0 and 180</span>
    mask = repmat(mask, [1 1 3]);
    hsv(mask) = 0;

    <span class="comment">% calculate 2D histogram over H and S channels</span>
    H = cv.calcHist(hsv, {opts.hlims, opts.slims}, <span class="string">'Channels'</span>,[0 1], <span class="keyword">...</span>
        <span class="string">'Uniform'</span>,true, <span class="string">'HistSize'</span>,[opts.hbins opts.sbins]);

    <span class="comment">% scale histogram for better visualization</span>
    H = log(H) * (opts.scale/64);  <span class="comment">% log-transform and scale</span>
    H = min(max(H, 0), 1);         <span class="comment">% clip to [0,1] range</span>

    <span class="comment">% color the histogram using the HSV map (both in 0-1 range)</span>
    out = bsxfun(@times, H, opts.map);
<span class="keyword">end</span>

<span class="keyword">function</span> out = hist1D_RGB(img, opts)
    <span class="comment">%HIST1D_HSV  Calculate RGB 1D histograms</span>

    <span class="comment">% output image</span>
    out = zeros([opts.sz 3], <span class="string">'uint8'</span>);

    <span class="comment">% x-coords of histogram line points scaled to fit image horizontally</span>
    <span class="comment">% (origin is top-right corner)</span>
    x = opts.sz(2) * (1:opts.cbins) / opts.cbins;

    <span class="comment">% for each channel in R,G,B</span>
    clrs = [255 0 0; 0 255 0; 0 0 255];
    <span class="keyword">for</span> i=1:3
        <span class="comment">% compute 1D histogram for current channel</span>
        H = cv.calcHist(img(:,:,i), {opts.clims}, <span class="keyword">...</span>
            <span class="string">'HistSize'</span>,opts.cbins, <span class="string">'Uniform'</span>,true);

        <span class="comment">% normalize counts to [0,opts.sz(1)] to fit image vertically</span>
        <span class="keyword">if</span> true
            H = cv.normalize(H, <span class="string">'NormType'</span>,<span class="string">'MinMax'</span>, <span class="string">'Alpha'</span>,0, <span class="string">'Beta'</span>,opts.sz(1));
        <span class="keyword">else</span>
            H = opts.sz(1) * (H - min(H)) / (max(H) - min(H));
        <span class="keyword">end</span>

        <span class="comment">% draw histogram as line</span>
        out = cv.polylines(out, [x(:), opts.sz(1) - H(:)], <span class="keyword">...</span>
            <span class="string">'Color'</span>,clrs(i,:), <span class="string">'Closed'</span>,false);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> onType(~,e,h)
    <span class="comment">%ONTYPE  Event handler for key press on figure</span>

    <span class="keyword">switch</span> e.Key
        <span class="keyword">case</span> {<span class="string">'q'</span>, <span class="string">'escape'</span>}
            close(h.fig);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> h = buildGUI(vid, opts)
    <span class="comment">%BUILDGUI  Construct the GUI</span>

    <span class="comment">% structure of handles</span>
    h = struct();

    <span class="comment">% video feed: figure, axis, image</span>
    <span class="keyword">if</span> true
        sz = [vid.get(<span class="string">'FrameHeight'</span>), vid.get(<span class="string">'FrameWidth'</span>)];
        img = zeros([sz 3], <span class="string">'uint8'</span>);
    <span class="keyword">else</span>
        img = vid.read();
        assert(~isempty(img));
        sz = size(img);
    <span class="keyword">end</span>
    h.fig(1) = figure(<span class="string">'Name'</span>,<span class="string">'Camera'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[100 200 sz(2) sz(1)]);
    h.ax(1) = axes(<span class="string">'Parent'</span>,h.fig(1), <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,[0 0 1 1]);
    h.img(1) = imshow(img, <span class="string">'Parent'</span>,h.ax(1));

    <span class="comment">% Hue/Saturation 2D histogram: figure, axis, image, slider, label</span>
    img = zeros(size(opts.map), <span class="string">'double'</span>);
    h.fig(2) = figure(<span class="string">'Name'</span>,<span class="string">'Hue/Saturation Hist'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[100+sz(2)+50 200 opts.sbins opts.hbins+21]);
    h.ax(2) = axes(<span class="string">'Parent'</span>,h.fig(2), <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[1 1 opts.sbins opts.hbins]);
    h.img(2) = imshow(img, <span class="string">'Parent'</span>,h.ax(2));
    h.slid = uicontrol(<span class="string">'Parent'</span>,h.fig(2), <span class="string">'Style'</span>,<span class="string">'slider'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[70 opts.hbins+1 opts.sbins-75 20], <span class="keyword">...</span>
        <span class="string">'Value'</span>,opts.scale, <span class="string">'Min'</span>,1, <span class="string">'Max'</span>,64, <span class="string">'SliderStep'</span>,[1 5]./64);
    h.lbl = uicontrol(<span class="string">'Parent'</span>,h.fig(2), <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
        <span class="string">'BackgroundColor'</span>,get(h.fig(1), <span class="string">'Color'</span>), <span class="keyword">...</span>
        <span class="string">'String'</span>,sprintf(<span class="string">'Scale: %.0f'</span>,opts.scale), <span class="keyword">...</span>
        <span class="string">'Position'</span>,[10 opts.hbins+1 60 20]);

    <span class="comment">% RGB histogram (three 1D hist): figure, axis, image</span>
    img = zeros([opts.sz 3], <span class="string">'uint8'</span>);
    h.fig(3) = figure(<span class="string">'Name'</span>, <span class="string">'R/G/B Hist'</span>, <span class="string">'Menubar'</span>,<span class="string">'none'</span>, <span class="string">'Resize'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
        <span class="string">'Position'</span>,[100+sz(2)+50+opts.sbins+50 200 opts.sz(2) opts.sz(1)]);
    h.ax(3) = axes(<span class="string">'Parent'</span>,h.fig(3), <span class="string">'Units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,[0 0 1 1]);
    h.img(3) = imshow(img, <span class="string">'Parent'</span>,h.ax(3));

    <span class="comment">% hook event handlers</span>
    set(h.fig, <span class="string">'WindowKeyPressFcn'</span>,{@onType,h}, <span class="keyword">...</span>
        <span class="string">'CloseRequestFcn'</span>,@(~,~) delete(h.fig), <span class="keyword">...</span>
        <span class="string">'Interruptible'</span>,<span class="string">'off'</span>, <span class="string">'BusyAction'</span>,<span class="string">'cancel'</span>);
<span class="keyword">end</span></pre><img src="color_histogram_demo_gui_01.png"><img src="color_histogram_demo_gui_02.png"><img src="color_histogram_demo_gui_03.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Video Histogram
%
% Demo to show live histogram of video, both 1D histograms of RGB channels
% and 2D histogram of Hue-Saturation.
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.2.0/samples/python/color_histogram.py>
% * <https://docs.opencv.org/3.2.0/dd/d0d/tutorial_py_2d_histogram.html>
% * <https://docs.opencv.org/3.2.0/d1/db7/tutorial_py_histogram_begins.html>
%

function varargout = color_histogram_demo_gui(varargin)
    % setup video source
    vid = createVideoCapture([], 'chess');
    pause(0.5);
    assert(vid.isOpened());

    % build and initialize GUI
    opts = default_options();
    h = buildGUI(vid, opts);
    if nargout > 0, varargout{1} = h; end

    % main loop: while UI still open, keep processing frames
    while all(ishghandle(h.img)) && vid.isOpened()
        % grab next frame
        frame = vid.read();
        if isempty(frame), break; end

        % compute 2D Hue/Saturation histogram and 1D R/G/B histogram
        opts.scale = get(h.slid, 'Value');  % current slider value
        out2 = hist2D_HSV(frame, opts);
        out1 = hist1D_RGB(frame, opts);

        % show results
        set(h.lbl, 'String',sprintf('Scale: %.0f',opts.scale));
        set(h.img(1), 'CData',frame);
        set(h.img(2), 'CData',out2);
        set(h.img(3), 'CData',out1);
        drawnow;
    end
    vid.release();
end

function opts = default_options()
    %DEFAULT_OPTIONS  Create structure of options

    opts = struct();

    % hue/saturation histogram params (hue: 0-179 degrees, saturation: 0-255)
    opts.hlims = [0 180];
    opts.slims = [0 256];
    opts.hbins = 180;
    opts.sbins = 256;

    % R/G/B histograms params (R/G/B: 0-255)
    opts.clims = [0 256];
    opts.cbins = 256;
    opts.sz = [150, 350];

    % build HSV map, used to color the histogram
    [H,S,V] = ndgrid((1:opts.hbins)-1, (1:opts.sbins)-1, 255);
    RGB = cv.cvtColor(uint8(cat(3,H,S,V)), 'HSV2RGB');
    opts.map = double(RGB)./255;
    opts.scale = 20;
end

function out = hist2D_HSV(img, opts)
    %HIST1D_HSV  Calculate H-S 2D histogram

    % downscale for faster computation
    if false
        img = cv.pyrDown(img);
    end

    % convert RGB to HSV colorspace
    hsv = cv.cvtColor(img, 'RGB2HSV');

    % blacken dark pixels
    mask = hsv(:,:,3) < 20;  % V between 0 and 180
    mask = repmat(mask, [1 1 3]);
    hsv(mask) = 0;

    % calculate 2D histogram over H and S channels
    H = cv.calcHist(hsv, {opts.hlims, opts.slims}, 'Channels',[0 1], ...
        'Uniform',true, 'HistSize',[opts.hbins opts.sbins]);

    % scale histogram for better visualization
    H = log(H) * (opts.scale/64);  % log-transform and scale
    H = min(max(H, 0), 1);         % clip to [0,1] range

    % color the histogram using the HSV map (both in 0-1 range)
    out = bsxfun(@times, H, opts.map);
end

function out = hist1D_RGB(img, opts)
    %HIST1D_HSV  Calculate RGB 1D histograms

    % output image
    out = zeros([opts.sz 3], 'uint8');

    % x-coords of histogram line points scaled to fit image horizontally
    % (origin is top-right corner)
    x = opts.sz(2) * (1:opts.cbins) / opts.cbins;

    % for each channel in R,G,B
    clrs = [255 0 0; 0 255 0; 0 0 255];
    for i=1:3
        % compute 1D histogram for current channel
        H = cv.calcHist(img(:,:,i), {opts.clims}, ...
            'HistSize',opts.cbins, 'Uniform',true);

        % normalize counts to [0,opts.sz(1)] to fit image vertically
        if true
            H = cv.normalize(H, 'NormType','MinMax', 'Alpha',0, 'Beta',opts.sz(1));
        else
            H = opts.sz(1) * (H - min(H)) / (max(H) - min(H));
        end

        % draw histogram as line
        out = cv.polylines(out, [x(:), opts.sz(1) - H(:)], ...
            'Color',clrs(i,:), 'Closed',false);
    end
end

function onType(~,e,h)
    %ONTYPE  Event handler for key press on figure

    switch e.Key
        case {'q', 'escape'}
            close(h.fig);
    end
end

function h = buildGUI(vid, opts)
    %BUILDGUI  Construct the GUI

    % structure of handles
    h = struct();

    % video feed: figure, axis, image
    if true
        sz = [vid.get('FrameHeight'), vid.get('FrameWidth')];
        img = zeros([sz 3], 'uint8');
    else
        img = vid.read();
        assert(~isempty(img));
        sz = size(img);
    end
    h.fig(1) = figure('Name','Camera', 'Menubar','none', 'Resize','on', ...
        'Position',[100 200 sz(2) sz(1)]);
    h.ax(1) = axes('Parent',h.fig(1), 'Units','normalized', 'Position',[0 0 1 1]);
    h.img(1) = imshow(img, 'Parent',h.ax(1));

    % Hue/Saturation 2D histogram: figure, axis, image, slider, label
    img = zeros(size(opts.map), 'double');
    h.fig(2) = figure('Name','Hue/Saturation Hist', 'Menubar','none', 'Resize','off', ...
        'Position',[100+sz(2)+50 200 opts.sbins opts.hbins+21]);
    h.ax(2) = axes('Parent',h.fig(2), 'Units','pixels', ...
        'Position',[1 1 opts.sbins opts.hbins]);
    h.img(2) = imshow(img, 'Parent',h.ax(2));
    h.slid = uicontrol('Parent',h.fig(2), 'Style','slider', ...
        'Position',[70 opts.hbins+1 opts.sbins-75 20], ...
        'Value',opts.scale, 'Min',1, 'Max',64, 'SliderStep',[1 5]./64);
    h.lbl = uicontrol('Parent',h.fig(2), 'Style','text', ...
        'BackgroundColor',get(h.fig(1), 'Color'), ...
        'String',sprintf('Scale: %.0f',opts.scale), ...
        'Position',[10 opts.hbins+1 60 20]);

    % RGB histogram (three 1D hist): figure, axis, image
    img = zeros([opts.sz 3], 'uint8');
    h.fig(3) = figure('Name', 'R/G/B Hist', 'Menubar','none', 'Resize','on', ...
        'Position',[100+sz(2)+50+opts.sbins+50 200 opts.sz(2) opts.sz(1)]);
    h.ax(3) = axes('Parent',h.fig(3), 'Units','normalized', 'Position',[0 0 1 1]);
    h.img(3) = imshow(img, 'Parent',h.ax(3));

    % hook event handlers
    set(h.fig, 'WindowKeyPressFcn',{@onType,h}, ...
        'CloseRequestFcn',@(~,~) delete(h.fig), ...
        'Interruptible','off', 'BusyAction','cancel');
end

##### SOURCE END #####
-->
   </body>
</html>