<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--This HTML was auto-generated from published MATLAB code.-->
      <title>Fully-Convolutional Networks Semantic Segmentation Demo</title>
      <meta name="generator" content="MATLAB 9.2">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2018-02-20">
      <meta name="DC.source" content="fcn_semsegm_demo.m">
      <link rel="stylesheet" type="text/css" href="publish_custom.css">
   </head>
   <body>
      <div class="content">
         <h1 id="1">Fully-Convolutional Networks Semantic Segmentation Demo</h1>
         <!--introduction-->
         <p>"Fully Convolutional Models for Semantic Segmentation", Jonathan Long, Evan Shelhamer and Trevor Darrell, CVPR, 2015. <a href="http://www.cv-foundation.org/openaccess/content_cvpr_2015/papers/Long_Fully_Convolutional_Networks_2015_CVPR_paper.pdf">http://www.cv-foundation.org/openaccess/content_cvpr_2015/papers/Long_Fully_Convolutional_Networks_2015_CVPR_paper.pdf</a></p>
         <p>Sources:</p>
         <div>
            <ul>
               <li><a href="https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fcn_semsegm.cpp">https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fcn_semsegm.cpp</a></li>
            </ul>
         </div>
         <!--/introduction-->
         <h2 id="toc">Contents</h2>
         <div>
            <ul>
               <li><a href="#2">Model files</a></li>
               <li><a href="#3">Load classes and their colors</a></li>
               <li><a href="#4">Create and initialize network from Caffe model</a></li>
               <li><a href="#5">Prepare blob</a></li>
               <li><a href="#6">Make forward pass</a></li>
               <li><a href="#7">Gather output</a></li>
               <li><a href="#8">Result</a></li>
            </ul>
         </div>
         <h2 id="2">Model files</h2><pre class="codeinput">dirDNN = fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'dnn'</span>, <span class="string">'FCN'</span>);
modelLabels = fullfile(dirDNN, <span class="string">'pascal-classes.txt'</span>);
modelTxt = fullfile(dirDNN, <span class="string">'fcn8s-heavy-pascal.prototxt'</span>);
modelBin = fullfile(dirDNN, <span class="string">'fcn8s-heavy-pascal.caffemodel'</span>);  <span class="comment">% 513 MB file</span>
files = {modelLabels, modelTxt, modelBin};
urls = {
    <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/pascal-classes.txt'</span>;
    <span class="string">'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/fcn8s-heavy-pascal.prototxt'</span>;
    <span class="string">'http://dl.caffe.berkeleyvision.org/fcn8s-heavy-pascal.caffemodel'</span>;
};
<span class="keyword">if</span> ~isdir(dirDNN), mkdir(dirDNN); <span class="keyword">end</span>
<span class="keyword">for</span> i=1:numel(files)
    <span class="keyword">if</span> exist(files{i}, <span class="string">'file'</span>) ~= 2
        disp(<span class="string">'Downloading...'</span>)
        <span class="keyword">if</span> i==3
            choice = questdlg({<span class="string">'Downloading a large Caffe model (513 MB).'</span>, <span class="keyword">...</span>
                <span class="string">'Continue?'</span>}, <span class="string">'Download'</span>, <span class="string">'OK'</span>, <span class="string">'Cancel'</span>, <span class="string">'OK'</span>);
            assert(strcmp(choice, <span class="string">'OK'</span>), <span class="string">'Download cancelled'</span>);
        <span class="keyword">end</span>
        urlwrite(urls{i}, files{i});
    <span class="keyword">end</span>
<span class="keyword">end</span></pre><h2 id="3">Load classes and their colors</h2><pre class="codeinput">fid = fopen(modelLabels, <span class="string">'rt'</span>);
C = textscan(fid, <span class="string">'%s %d %d %d'</span>, <span class="string">'CollectOutput'</span>,true);
fclose(fid);
labels = C{1};  <span class="comment">% (20 classes + background)</span>
colors = uint8(C{2});  <span class="comment">% 21x3</span>
fprintf(<span class="string">'%d classes\n'</span>, numel(labels));</pre><pre class="codeoutput">21 classes
</pre><h2 id="4">Create and initialize network from Caffe model</h2><pre class="codeinput">net = cv.Net(<span class="string">'Caffe'</span>, modelTxt, modelBin);
assert(~net.empty(), <span class="string">'Cant load network'</span>);</pre><h2 id="5">Prepare blob</h2>
         <p>Set the network input (VOC-FCN8s was trained on 500x500 BGR-images)</p><pre class="codeinput">crop = true;
img = cv.imread(fullfile(mexopencv.root(), <span class="string">'test'</span>, <span class="string">'rgb.jpg'</span>), <span class="keyword">...</span>
    <span class="string">'Color'</span>,true, <span class="string">'FlipChannels'</span>,false);
blob = cv.Net.blobFromImages(img, <span class="string">'Size'</span>,[500 500], <span class="keyword">...</span>
    <span class="string">'Mean'</span>,[104.00699, 116.66877, 122.67892], <span class="string">'SwapRB'</span>,false, <span class="string">'Crop'</span>,crop);
net.setInput(blob, <span class="string">'data'</span>);</pre><h2 id="6">Make forward pass</h2>
         <p>computes output</p><pre class="codeinput">tic
score = net.forward(<span class="string">'score'</span>);  <span class="comment">% 1x21x500x500</span>
toc</pre><pre class="codeoutput">Elapsed time is 5.771725 seconds.
</pre><h2 id="7">Gather output</h2><pre class="codeinput">score = permute(score, [3 4 2 1]);  <span class="comment">% num,cn,row,col -&gt; row,col,cn,num</span>

<span class="comment">% max scores and corresponding labels</span>
[S,L] = max(score, [], 3);  <span class="comment">% score is 500x500x21</span></pre><h2 id="8">Result</h2><pre class="codeinput"><span class="comment">% prepare output image</span>
<span class="keyword">if</span> crop
    <span class="keyword">if</span> true
        <span class="comment">% recover image from blob as fed to network</span>
        rgb = permute(blob, [3 4 2 1]);
        rgb = bsxfun(@plus, rgb, cat(3, 104.00699, 116.66877, 122.67892));
        rgb = uint8(round(rgb));
    <span class="keyword">else</span>
        <span class="comment">% take input image and do center-crop + resize ourselves</span>
        sz = [size(img,2) size(img,1)];
        rgb = cv.getRectSubPix(img, [min(sz) min(sz)], sz/2);
        rgb = cv.resize(rgb, [500 500]);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    <span class="comment">% direct resize of original image</span>
    rgb = cv.resize(img, [500 500]);
<span class="keyword">end</span>
rgb = flip(rgb, 3);  <span class="comment">% BGR to RGB</span>

<span class="comment">% colorize segmentations using label colors and overlay on top of image</span>
out = reshape(colors(L(:),:), [size(L) 3]);
out = cv.addWeighted(rgb, 0.4, out, 0.6, 0.0);

<span class="comment">% highlight segmented objects</span>
<span class="keyword">for</span> lbl=2:numel(labels)  <span class="comment">% skip 1 (background label)</span>
    <span class="comment">% regionprops</span>
    BW = (L == lbl);
    <span class="keyword">if</span> nnz(BW) == 0, <span class="keyword">continue</span>; <span class="keyword">end</span>
    [~,~,stats,centroids] = cv.connectedComponents(BW);

    <span class="comment">% ignore small areas</span>
    idx = stats(:,5) &lt; 200;
    stats(idx,:) = [];
    centroids(idx,:) = [];

    <span class="comment">% show bounding box around objects + show name</span>
    str = labels{lbl};
    clr = colors(lbl,:);
    clr = uint8(brighten(double(clr)/255, 0.6) * 255);
    <span class="keyword">for</span> i=1:size(stats,1)
        bbox = double(stats(i,1:4));
        out = cv.rectangle(out, bbox, <span class="string">'Color'</span>,clr, <span class="string">'Thickness'</span>,1);
        out = cv.putText(out, str, bbox(1:2)-[0 6], <span class="string">'Color'</span>,clr, <span class="string">'FontScale'</span>,0.5);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% display</span>
figure, imshow(out), title(<span class="string">'segmentation'</span>)
figure, imshow(S,[]), title(<span class="string">'max score'</span>), colorbar</pre><img src="fcn_semsegm_demo_01.png"><img src="fcn_semsegm_demo_02.png"><div class="footer">
            <p><a href="https://www.mathworks.com/products/matlab.html">Published with MATLAB&reg; R2017a</a></p>
         </div>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Fully-Convolutional Networks Semantic Segmentation Demo
%
% "Fully Convolutional Models for Semantic Segmentation", Jonathan Long,
% Evan Shelhamer and Trevor Darrell, CVPR, 2015.
% <http://www.cv-foundation.org/openaccess/content_cvpr_2015/papers/Long_Fully_Convolutional_Networks_2015_CVPR_paper.pdf>
%
% Sources:
%
% * <https://github.com/opencv/opencv/blob/3.4.0/samples/dnn/fcn_semsegm.cpp>
%

%% Model files
dirDNN = fullfile(mexopencv.root(), 'test', 'dnn', 'FCN');
modelLabels = fullfile(dirDNN, 'pascal-classes.txt');
modelTxt = fullfile(dirDNN, 'fcn8s-heavy-pascal.prototxt');
modelBin = fullfile(dirDNN, 'fcn8s-heavy-pascal.caffemodel');  % 513 MB file
files = {modelLabels, modelTxt, modelBin};
urls = {
    'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/pascal-classes.txt';
    'https://cdn.rawgit.com/opencv/opencv/3.4.0/samples/data/dnn/fcn8s-heavy-pascal.prototxt';
    'http://dl.caffe.berkeleyvision.org/fcn8s-heavy-pascal.caffemodel';
};
if ~isdir(dirDNN), mkdir(dirDNN); end
for i=1:numel(files)
    if exist(files{i}, 'file') ~= 2
        disp('Downloading...')
        if i==3
            choice = questdlg({'Downloading a large Caffe model (513 MB).', ...
                'Continue?'}, 'Download', 'OK', 'Cancel', 'OK');
            assert(strcmp(choice, 'OK'), 'Download cancelled');
        end
        urlwrite(urls{i}, files{i});
    end
end

%% Load classes and their colors
fid = fopen(modelLabels, 'rt');
C = textscan(fid, '%s %d %d %d', 'CollectOutput',true);
fclose(fid);
labels = C{1};  % (20 classes + background)
colors = uint8(C{2});  % 21x3
fprintf('%d classes\n', numel(labels));

%% Create and initialize network from Caffe model
net = cv.Net('Caffe', modelTxt, modelBin);
assert(~net.empty(), 'Cant load network');

%% Prepare blob
% Set the network input (VOC-FCN8s was trained on 500x500 BGR-images)
crop = true;
img = cv.imread(fullfile(mexopencv.root(), 'test', 'rgb.jpg'), ...
    'Color',true, 'FlipChannels',false);
blob = cv.Net.blobFromImages(img, 'Size',[500 500], ...
    'Mean',[104.00699, 116.66877, 122.67892], 'SwapRB',false, 'Crop',crop);
net.setInput(blob, 'data');

%% Make forward pass
% computes output
tic
score = net.forward('score');  % 1x21x500x500
toc

%% Gather output
score = permute(score, [3 4 2 1]);  % num,cn,row,col -> row,col,cn,num

% max scores and corresponding labels
[S,L] = max(score, [], 3);  % score is 500x500x21

%% Result

% prepare output image
if crop
    if true
        % recover image from blob as fed to network
        rgb = permute(blob, [3 4 2 1]);
        rgb = bsxfun(@plus, rgb, cat(3, 104.00699, 116.66877, 122.67892));
        rgb = uint8(round(rgb));
    else
        % take input image and do center-crop + resize ourselves
        sz = [size(img,2) size(img,1)];
        rgb = cv.getRectSubPix(img, [min(sz) min(sz)], sz/2);
        rgb = cv.resize(rgb, [500 500]);
    end
else
    % direct resize of original image
    rgb = cv.resize(img, [500 500]);
end
rgb = flip(rgb, 3);  % BGR to RGB

% colorize segmentations using label colors and overlay on top of image
out = reshape(colors(L(:),:), [size(L) 3]);
out = cv.addWeighted(rgb, 0.4, out, 0.6, 0.0);

% highlight segmented objects
for lbl=2:numel(labels)  % skip 1 (background label)
    % regionprops
    BW = (L == lbl);
    if nnz(BW) == 0, continue; end
    [~,~,stats,centroids] = cv.connectedComponents(BW);

    % ignore small areas
    idx = stats(:,5) < 200;
    stats(idx,:) = [];
    centroids(idx,:) = [];

    % show bounding box around objects + show name
    str = labels{lbl};
    clr = colors(lbl,:);
    clr = uint8(brighten(double(clr)/255, 0.6) * 255);
    for i=1:size(stats,1)
        bbox = double(stats(i,1:4));
        out = cv.rectangle(out, bbox, 'Color',clr, 'Thickness',1);
        out = cv.putText(out, str, bbox(1:2)-[0 6], 'Color',clr, 'FontScale',0.5);
    end
end

% display
figure, imshow(out), title('segmentation')
figure, imshow(S,[]), title('max score'), colorbar

##### SOURCE END #####
-->
   </body>
</html>